<!DOCTYPE html>
<html lang="en">
<head>
    <title>Slang Language Specification</title>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <h1 id="section-slang-language-specification" class="title-heading"><a href="#section-slang-language-specification" class="anchor">Slang Language Specification</a></h1>
<p>Editor: <a href="tfoley@nvidia.com">Theresa Foley</a>, <a href="https://www.nvidia.com">NVIDIA</a></p>
<nav><h1>Table of Contents</h1>
<div class="toc"><ul><li><a href="#sec.preface">Preface</a></li>
<li><a href="#sec.intro">Introduction</a><ul><li><a href="#sec.intro.scope">Scope</a></li>
<li><a href="#sec.intro.conformance">Conformance</a></li>
<li><a href="#sec.intro.stdlib">The Slang Standard Library</a></li>
<li><a href="#sec.intro.conventions">Document Conventions</a><ul><li><a href="#sec.intro.conventions.terminology">Terminology</a></li>
<li><a href="#sec.intro.conventions.typographical">Typographical Conventions</a></li>
<li><a href="#sec.intro.conventions.meta">Meta-Values and Meta-Types</a></li>
<li><a href="#sec.intro.conventions.meta.var">Meta-Variables</a></li>
<li><a href="#sec.intro.conventions.meta.pattern">Patterns</a></li>
<li><a href="#sec.intro.conventions.meta.characteristic">Characteristics of Meta-Values</a></li>
<li><a href="#sec.intro.conventions.callouts">Callouts</a></li>
<li><a href="#sec.intro.conventions.traditional">Traditional and Legacy Features</a></li>
</ul>
</li>
<li><a href="#sec.intro.grammar">Context-Free Grammars</a><ul><li><a href="#sec.intro.grammar.notation">Notation</a><ul><li><a href="#sec.intro.grammar.notation.production">Productions</a></li>
<li><a href="#sec.intro.grammar.notation.terminal">Terminals</a></li>
<li><a href="#sec.intro.grammar.notation.nonterminal">Nonterminals</a></li>
<li><a href="#sec.intro.grammar.notation.alternative">Terminals</a></li>
<li><a href="#sec.intro.grammar.notation.optional">Optionals</a></li>
<li><a href="#sec.intro.grammar.notation.sequence">Sequences</a></li>
<li><a href="#sec.intro.grammar.notation.grouping">Grouping</a></li>
<li><a href="#sec.intro.grammar.notation.exclusion">Exclusion</a></li>
<li><a href="#sec.intro.grammar.notation.characteristics">Characteristics</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.lifecycle">Program Lifecycle</a><ul><li><a href="#sec.lifecyle.compilation">Compilation</a></li>
<li><a href="#sec.lifecycle.linking">Linking</a></li>
<li><a href="#sec.lifecycle.loading">Loading</a></li>
<li><a href="#sec.lifecyle.reflection">Runtime Reflection</a></li>
<li><a href="#sec.lifecycle.bundling">Bundling</a></li>
</ul>
</li>
<li><a href="#sec.CHAPTER.lex">Lexical Structure</a><ul><li><a href="#sec.lex.source-unit">Source Units</a></li>
<li><a href="#sec.lex.encoding">Encoding</a></li>
<li><a href="#sec.lex.phase">Phases</a></li>
<li><a href="#sec.lex.lexeme">Lexemes</a><ul><li><a href="#sec.lex.trivia">Trivia</a><ul><li><a href="#sec.lex.trivia.space">Whitespace</a><ul><li><a href="#sec.lex.trivia.space.line-break">Line Breaks</a></li>
</ul>
</li>
<li><a href="#sec.lex.trivia.comment">Comments</a></li>
</ul>
</li>
<li><a href="#sec.lex.token">Tokens</a><ul><li><a href="#sec.lex.token.ident">Identifiers</a></li>
<li><a href="#sec.lex.token.lit">Literals</a><ul><li><a href="#sec.lex.token.num">Numeric Literals</a></li>
</ul>
</li>
<li><a href="#sec.lex.token.int">Integer Literals</a></li>
<li><a href="#sec.lex.token.float">Floating-Point Literals</a></li>
</ul>
</li>
<li><a href="#sec.lex.token.text">Text Literals</a><ul><li><a href="#sec.lex.token.string">String Literals</a></li>
<li><a href="#sec.lex.token.char">Character Literals</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.lex.token.punctuation">Operators and Punctuation</a></li>
<li><a href="#sec.lex.token.trivia">Associating Trivia With Tokens</a></li>
</ul>
</li>
<li><a href="#sec.prepro">Preprocessor</a><ul><li><a href="#sec.prepro.changes">Changes</a></li>
<li><a href="#sec.prepro.extensions">Extensions</a></li>
</ul>
</li>
<li><a href="#sec.parse">Parsing</a><ul><li><a href="#sec.parse.context">Contexts</a></li>
<li><a href="#sec.parse.strat">Strategies</a><ul><li><a href="#sec.parse.strat.ordered">Ordered</a></li>
<li><a href="#sec.parse.strat.unordered">Unordered</a></li>
</ul>
</li>
<li><a href="#sec.parse.angle">Angle Brackets</a><ul><li><a href="#sec.parse.angle.open">Opening Angle Brackets</a><ul><li><a href="#sec.parse.angle.open.ordered">Ordered Mode</a></li>
<li><a href="#sec.parse.angle.open.unordered">Unordered Mode</a></li>
</ul>
</li>
<li><a href="#sec.parse.angle.close">Closing Angle Brackets</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.section.type">Types and Values</a><ul><li><a href="#sec.value.level">Level</a></li>
<li><a href="#sec.type.type">Types of Types</a></li>
<li><a href="#sec.type.scalar">Scalars</a><ul><li><a href="#sec.type.unit">Unit</a></li>
<li><a href="#sec.type.bool">Booleans</a></li>
<li><a href="#sec.type.scalar.numeric">Numeric Scalars</a><ul><li><a href="#sec.type.scalar.numeric.int">Integers</a></li>
<li><a href="#sec.type.scalar.numeric.float">Floating-Point Numbers</a></li>
</ul>
</li>
<li><a href="#sec.type.scalar.unicode">Unicode Scalar Values</a></li>
</ul>
</li>
<li><a href="#sec.type.sequence.finite">Finite Sequences</a></li>
<li><a href="#sec.type.array">Array Types</a></li>
<li><a href="#sec.type.vector">Vectors</a></li>
<li><a href="#sec.type.matrix">Matrices</a></li>
<li><a href="#sec.type.never">The <code>Never</code>Type</a></li>
<li><a href="#sec.decl.ref">Declaration References</a><ul><li><a href="#sec.decl.ref.direct">Direct Declaration References</a></li>
<li><a href="#sec.decl.ref.member">Member Declaration Reference</a></li>
<li><a href="#sec.decl.ref.specialize">Specialized Declaration Reference</a></li>
<li><a href="#sec.decl.ref.specialized.fully">Fully-Specialized Declaration References</a></li>
</ul>
</li>
<li><a href="#sec.type.nominal">Nominal Types</a></li>
<li><a href="#sec.type.struct"><code>struct</code>Types</a></li>
<li><a href="#sec.type.class"><code>class</code>Types</a></li>
<li><a href="#sec.type.enum"><code>enum</code>Types</a></li>
<li><a href="#sec.type.alias">Type Aliases</a></li>
<li><a href="#sec.type.assoc">Associated Types</a></li>
<li><a href="#sec.type.interface">Interfaces</a></li>
<li><a href="#sec.type.any"><code>any</code>Types</a></li>
<li><a href="#sec.type.function">Functions</a></li>
<li><a href="#sec.type.generic">Generics</a></li>
<li><a href="#sec.type.witness">Witnesses</a></li>
<li><a href="#sec.value.module">Module Values</a></li>
<li><a href="#sec.type.text">Text</a><ul><li><a href="#sec.type.text.char">Characters</a></li>
<li><a href="#sec.type.text.string">Strings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.check">Semantic Checking</a><ul><li><a href="#sec.check.context">Contexts</a></li>
<li><a href="#sec.check.expr">Expressions</a><ul><li><a href="#sec.check.expr.synth">Synthesis</a></li>
<li><a href="#sec.check.check">Checking</a></li>
</ul>
</li>
<li><a href="#sec.check.type">Type Expressions</a></li>
<li><a href="#sec.check.stmt">Statements</a></li>
<li><a href="#sec.check.decl">Declarations</a></li>
</ul>
</li>
<li><a href="#sec.sec.module">Modules</a><ul><li><a href="#sec.module.source.primary">Primary Source Unit</a></li>
<li><a href="#sec.module.source.secondary">Seconary Source Units</a><ul><li><a href="#sec.module.include">Include Declarations</a></li>
<li><a href="#sec.module.implementing">Implementing Declarations</a></li>
</ul>
</li>
<li><a href="#sec.module.import">Import Declarations</a></li>
</ul>
</li>
<li><a href="#sec.decl">Declarations</a><ul><li><a href="#sec.decl.shared">Shared Concepts</a><ul><li><a href="#sec.decl.body">Bodies</a></li>
<li><a href="#sec.decl.base">Bases</a></li>
<li><a href="#sec.decl.param">Parameters</a><ul><li><a href="#sec.dir">Directions</a><ul><li><a href="#sec.dir.in"><code>in</code></a></li>
<li><a href="#sec.out"><code>out</code></a></li>
<li><a href="#sec.take"><code>take</code></a></li>
<li><a href="#sec.borrow"><code>borrow</code></a></li>
<li><a href="#sec.inout"><code>inout</code></a></li>
<li><a href="#sec.ref"><code>ref</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.decl.accessor">Accessors</a></li>
<li><a href="#sec.decl.invocable">Invocable Declarations</a></li>
</ul>
</li>
<li><a href="#sec.pattern">Patterns</a></li>
<li><a href="#sec.decl.generic">Generics</a></li>
<li><a href="#sec.decl.type">Type Declarations</a><ul><li><a href="#sec.decl.agg">Aggregate Types</a><ul><li><a href="#sec.decl.agg.member.static">Instance and Static Members</a></li>
<li><a href="#sec.field">Fields</a></li>
<li><a href="#sec.method">Methods</a></li>
</ul>
</li>
<li><a href="#sec.decl.agg.bases">Bases</a><ul><li><a href="#sec.decl.agg.syntax">Traditional Syntax</a><ul><li><a href="#sec.decl.agg.syntax.trailing-semicolon">Trailing Semicolon</a></li>
<li><a href="#sec.decl.agg.type-specifier">Aggregate Type Specifiers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.decl.enum"><code>enum</code>Declarations</a><ul><li><a href="#sec.case">Cases</a></li>
</ul>
</li>
<li><a href="#sec.decl.type.alias">Type Aliases</a><ul><li><a href="#sec.decl.type.alias.syntax.traditional">Traditional Syntax</a></li>
</ul>
</li>
<li><a href="#sec.decl.type.associated">Associated Types</a></li>
</ul>
</li>
<li><a href="#sec.decl.traditional">Traditional Declarations</a></li>
<li><a href="#sec.decl.var">Variables</a><ul><li><a href="#sec.decl.var.traditional">Traditional Variable Declarations</a></li>
<li><a href="#sec.decl.var.global">Variables at Global Scope</a><ul><li><a href="#sec.decl.var.global.const">Global Constants</a></li>
<li><a href="#sec.decl.var.global.static">Static Global Variables</a></li>
<li><a href="#sec.global.param">Global Shader Parameters</a></li>
</ul>
</li>
<li><a href="#sec.decl.var.func">Variables at Function Scope</a><ul><li><a href="#sec.const">Function-Scope Constants</a></li>
<li><a href="#sec.static">Function-Scope Static Variables</a></li>
<li><a href="#sec.local">Local Variables</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.decl.func">Functions</a><ul><li><a href="#sec.decl.func.result">Result Type</a></li>
<li><a href="#sec.decl.func.body">Body</a></li>
<li><a href="#sec.decl.func.traditional">Traditional Function Declarations</a></li>
<li><a href="#sec.decl.func.entry">Entry Points</a></li>
</ul>
</li>
<li><a href="#sec.decl.init">Constructors</a></li>
<li><a href="#sec.decl.prop">Properties</a><ul><li><a href="#sec.decl.accessor">Accessors</a></li>
</ul>
</li>
<li><a href="#sec.decl.subscript">Subscripts</a></li>
<li><a href="#sec.decl.extension">Extensions</a></li>
<li><a href="#sec.decl.generic">Generics</a><ul><li><a href="#sec.decl.generic.param">Generic Parameters</a></li>
<li><a href="#sec.decl.generic.specialize.explicit">Explicit Specialization</a></li>
<li><a href="#sec.decl.generic.specialize.implicit">Implicit Specialization</a></li>
<li><a href="#sec.decl.generic.syntax">Syntax Details</a></li>
</ul>
</li>
<li><a href="#sec.decl.buffer">Traditional Buffer Declarations</a></li>
</ul>
</li>
<li><a href="#sec.stmt">Statements</a><ul><li><a href="#sec.stmt.expr">Expression Statement</a></li>
<li><a href="#sec.expr.decl">Declaration Statement</a></li>
<li><a href="#sec.stmt.block">Block Statement</a></li>
<li><a href="#sec.stmt.empty">Empty Statement</a></li>
<li><a href="#sec.stmt.cond">Conditional Statements</a><ul><li><a href="#sec.stmt.if">If Statement</a></li>
<li><a href="#sec.stmt.switch">Switch Statement</a></li>
</ul>
</li>
<li><a href="#sec.stmt.loop">Loop Statements</a><ul><li><a href="#sec.stmt.for">For Statement</a></li>
<li><a href="#sec.stmt.while">While Statement</a></li>
<li><a href="#sec.stmt.do-while">Do-While Statement</a></li>
</ul>
</li>
<li><a href="#sec.stmt.control">Control Transfer Statements</a><ul><li><a href="#sec.stmt.break"><code>break</code>Statement</a></li>
<li><a href="#sec.stmt.continue">Continue Statement</a></li>
<li><a href="#sec.stmt.return">Return Statement</a></li>
<li><a href="#sec.stmt.discard">Discard Statement</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.expr">Expressions</a><ul><li><a href="#sec.expr.lit">Literal Expressions</a><ul><li><a href="#sec.expr.lit.int">Integer Literal Expressions</a></li>
<li><a href="#sec.expr.lit.float">Floating-Point Literal Expressions</a></li>
<li><a href="#sec.expr.lit.bool">Boolean Literal Expressions</a></li>
<li><a href="#sec.expr.lit.string">String Literal Expressions</a></li>
</ul>
</li>
<li><a href="#sec.expr.ident">Identifier Expressions</a></li>
<li><a href="#sec.expr.member">Member Expression</a></li>
<li><a href="#sec.expr.this">This Expression</a><ul><li><a href="#section-syntax">Syntax</a></li>
<li><a href="#section-static-semantics">Static Semantics</a></li>
</ul>
</li>
<li><a href="#sec.expr.paren">Parenthesized Expression</a><ul><li><a href="#section-syntax">Syntax</a></li>
<li><a href="#section-static-semantics">Static Semantics</a></li>
</ul>
</li>
<li><a href="#sec.expr.call">Call Expression</a></li>
<li><a href="#sec.expr.subscript">Subscript Expression</a></li>
<li><a href="#sec.expr.init-list">Initializer List Expression</a></li>
<li><a href="#sec.expr.cast">Cast Expression</a><ul><li><a href="#sec.expr.cast.compatiblity">Legacy: Compatibility Feature</a></li>
</ul>
</li>
<li><a href="#sec.expr.assign">Assignment Expression</a></li>
<li><a href="#sec.expr.op">Operator Expressions</a><ul><li><a href="#sec.expr.op.prefix">Prefix Operator Expressions</a></li>
</ul>
</li>
<li><a href="#sec.expr.op.postfix">Postfix Operator Expressions</a><ul><li><a href="#sec.expr.op.infix">Infix Operator Expressions</a></li>
<li><a href="#sec.expr.op.cond">Conditional Expression</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.mod">Modifiers</a><ul><li><a href="#sec.mod.attr">Attributes</a></li>
<li><a href="#sec.mod.semantic">Semantics</a></li>
<li><a href="#section-interpolation-control">Interpolation Control</a></li>
<li><a href="#section-geometry-shader-input-primitive-type">Geometry Shader Input Primitive Type</a></li>
<li><a href="#section-matrix-layout-control">Matrix Layout Control</a></li>
<li><a href="#section-format-control">Format Control</a></li>
<li><a href="#section-fodder">Fodder</a></li>
</ul>
</li>
<li><a href="#sec.vis">Visibility Control</a></li>
<li><a href="#sec.linearization">Type Linearization</a></li>
<li><a href="#sec.SECTION.interface">Interfaces</a></li>
<li><a href="#sec.section.generic">Generics</a></li>
<li><a href="#sec.lookup">Lookup</a></li>
<li><a href="#sec.overload">Overload Resolution</a></li>
<li><a href="#sec.subtype">Subtyping</a></li>
<li><a href="#sec.conv">Type Conversions</a></li>
<li><a href="#sec.exec">Execution</a><ul><li><a href="#sec.exec.runtime">Runtime Sessions</a></li>
<li><a href="#sec.exec.strand">Strands</a></li>
<li><a href="#sec.exec.completion">Completion Status</a></li>
<li><a href="#sec.exec.stmt">Execution of Statements</a></li>
<li><a href="#sec.exec.eval">Evaluation of Expressions</a></li>
<li><a href="#sec.exec.invocation">Invocation</a><ul><li><a href="#sec.exec.invocation.record">Invocation Records</a></li>
<li><a href="#sec.exec.invocation.eval">Evaluation of Invocations</a></li>
</ul>
</li>
<li><a href="#sec.exec.wave">Waves</a></li>
<li><a href="#sec.exec.uniformity">Uniformity</a><ul><li><a href="#sec.exec.uniformity.collective">Collective Operations</a></li>
<li><a href="#sec.exec.uniformity.tangle">Tangles</a></li>
<li><a href="#sec.exec.cfg">Control-Flow Graphs</a><ul><li><a href="#sec.exec.cfg.dom">Dominance</a></li>
</ul>
</li>
<li><a href="#sec.exec.uniformity.region">Control-Flow Regions</a><ul><li><a href="#sec.exec.uniformity.region.break">Breaking Out Of a Region</a></li>
<li><a href="#sec.exec.uniformity.region.structured">Structured Regions</a></li>
</ul>
</li>
<li><a href="#sec.exec.uniformity.divergence">Divergence</a></li>
<li><a href="#sec.exec.uniformity.reconvergence">Reconvergence</a></li>
<li><a href="#sec.exec.uniformity.dynamic">Dynamic Uniformity</a><ul><li><a href="#sec.exec.uniformity.dynamic.value">Dynamically Uniform Values</a></li>
<li><a href="#sec.exec.uniformity.dynamic.control">Dynamically Uniform Control Flow</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.exec.rate">Rates</a><ul><li><a href="#sec.exec.rate.value">Rates of Values</a></li>
<li><a href="#sec.exec.rate.control">Rates of Control-Flow</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.gpu">GPUs</a><ul><li><a href="#sec.gpu.dispatch">Dispatches</a></li>
<li><a href="#sec.gpu.pipeline">Pipelines</a><ul><li><a href="#sec.gpu.pipeline.type">Pipeline Types</a></li>
<li><a href="#sec.gpu.pipeline.instance">Pipeline Instances</a><ul><li><a href="#sec.gpu.pipeline.stage">Stages</a><ul><li><a href="#sec.exec.gpu.pipeline.stage.type">Stage Types</a></li>
<li><a href="#sec.gpu.pipeline.stage.instance">Stage Instances</a></li>
</ul>
</li>
<li><a href="#sec.exec.gpu.pipeline.stage.signature">Signatures</a></li>
</ul>
</li>
<li><a href="#sec.exec.gpu.pipeline.record">Records</a></li>
<li><a href="#sec.exec.gpu.pipeline.compute">Compute</a><ul><li><a href="#section-blocks">Blocks</a></li>
<li><a href="#section-grids">Grids</a></li>
<li><a href="#section-attributes">Attributes</a><ul><li><a href="#section-[numthreads]"><code>[numthreads]</code></a></li>
</ul>
</li>
<li><a href="#section-signature">Signature</a></li>
</ul>
</li>
<li><a href="#sec.exec.gpu.pipeline.raster">Rasterization</a><ul><li><a href="#section-rasterization-system-values">Rasterization System Values</a></li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.fetch.index">Index Fetch</a></li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.fetch.vertex">Vertex Fetch</a></li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.vertex">Vertex Shader</a><ul><li><a href="#section-signature">Signature</a></li>
<li><a href="#section-system-values">System Values</a></li>
</ul>
</li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.primitive-assembly">Primitive Assembly</a></li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.tess">Tessellation</a><ul><li><a href="#sec.exec.gpu.pipeline.raster.stage.tess.hull">Hull Shader</a><ul><li><a href="#section-attributes">Attributes</a></li>
<li><a href="#section-signature">Signature</a></li>
<li><a href="#section-system-values">System Values</a></li>
</ul>
</li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.tess.domain">Domain Shader</a><ul><li><a href="#section-system-values">System Values</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.geometry">Geometry Shader</a><ul><li><a href="#section-system-values">System Values</a></li>
</ul>
</li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.mesh">Mesh Shading</a></li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.rasterizer">Rasterizer</a></li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.depth-stencil-test">Depth/Stencil Test</a></li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.fragment">Fragment Shader</a><ul><li><a href="#section-signature">Signature</a></li>
<li><a href="#section-system-values">System Values</a></li>
</ul>
</li>
<li><a href="#sec.exec.gpu.pipeline.raster.stage.blend">Blend</a></li>
</ul>
</li>
<li><a href="#sec.exec.gpu.pipeline.ray-tracing">Ray Tracing</a></li>
</ul>
</li>
<li><a href="#sec.gpu.fodder">Fodder</a></li>
</ul>
</li>
<li><a href="#sec.memory">Memory</a><ul><li><a href="#sec.memory.location">Memory Locations</a></li>
<li><a href="#sec.memory.access">Memory Accesses</a><ul><li><a href="#sec.memory.access.mode">Memory Access Modes</a></li>
</ul>
</li>
<li><a href="#sec.memory.model">Memory Model</a></li>
</ul>
</li>
<li><a href="#sec.SECTION.layout">Layout</a></li>
<li><a href="#sec.storage">Storage</a><ul><li><a href="#sec.storage.concrete">Concrete Storage Locations</a><ul><li><a href="#sec.storage.concrete.type">Reference Types</a><ul><li><a href="#sec.storage.concrete.type.conversion">Type Conversion</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec.storage.abstract.location">Abstract Storage Locations</a></li>
<li><a href="#sec.storage.abstract.access">Abstract Storage Access</a></li>
<li><a href="#sec.storage.abstract.access.mode">Access Mode</a></li>
<li><a href="#sec.storage.abstract.reference.type">Abstract Storage References</a><ul><li><a href="#sec.storage.abstract.reference.type.conversion">Type Conversion</a></li>
</ul>
</li>
<li><a href="#sec.storage.location.contain">Containment</a><ul><li><a href="#sec.storage.access.conflict">Conflicts</a></li>
</ul>
</li>
<li><a href="#sec.storage.expr">Expressions That Reference Storage</a></li>
</ul>
</li>
<li><a href="#sec.stability">Source and Binary Stability</a></li>
<li><a href="#sec.autodiff">Automatic Differentiation</a></li>
</ul>
</div>
</nav>
<h1 id="sec.preface"><a href="#sec.preface" class="anchor">Preface</a></h1>
<p><div class="issue">
This chapter should provide descriptive information about what Slang is, including the motivations, history, and philosophy of the language.
</div></p>
<h1 id="sec.intro"><a href="#sec.intro" class="anchor">Introduction</a></h1>
<h2 id="sec.intro.scope"><a href="#sec.intro.scope" class="anchor">Scope</a></h2>
<p>This document is a specification for the Slang programming language.</p>
<p>Slang is language primarily designed for use in <a>shader programming</a>: performance oriented GPU programming for real-time graphics.</p>
<h2 id="sec.intro.conformance"><a href="#sec.intro.conformance" class="anchor">Conformance</a></h2>
<p>This document aspires to specify the Slang language, and the behaviors expected of conforming implementations, with a high level of rigor.</p>
<p>The open-source Slang compiler <a>implementation</a> may deviate from the language as specified here, in a few key ways:</p>
<ul><li><p>The implementation is necessarily imperfect, and can have bugs.</p>
</li>
<li><p>The implementation may not fully support constructs specified here, or their capabilities may not be as complete as what is required by the specification.</p>
</li>
<li><p>The implementation may support certain constructs that are experimental, deprecated, or are otherwise intentionally unspecified (or even undocumented).</p>
</li>
</ul>
<p>Where practical, this document will call out known deviations between the language as specified, and the current implementation in the open-source Slang compiler.</p>
<h2 id="sec.intro.stdlib"><a href="#sec.intro.stdlib" class="anchor">The Slang Standard Library</a></h2>
<p>Many constructs that appear to users of Slang as built-in syntax are instead defined as part of the <a><var class="meta">standard library</var></a> for Slang.
This document may, of neccessity, refer to constructs from the Slang standard library (e.g., the <code>Texture2D</code> type) that are not defined herein.</p>
<p>This document does not provide a normative definition of all of the types, functions, attributes, modifiers, capabilities, etc. that are defined in the Slang standard library.
The normative reference for standard-library constructs not defined in this document is the Slang Standard Library Reference.</p>
<div class="issue callout">Issue: Need to turn that into a link.</div>
<p>In cases where a language construct is described in <a>both</a> this specification and the Standard Library Reference, the construct has all the capabilities and restrictions defined in either source.
In cases where the two sources disagree, there is a correctness issue in one or the other.</p>
<h2 id="sec.intro.conventions"><a href="#sec.intro.conventions" class="anchor">Document Conventions</a></h2>
<h3 id="sec.intro.conventions.terminology"><a href="#sec.intro.conventions.terminology" class="anchor">Terminology</a></h3>
<p>The key words <dfn>must</dfn>, <dfn>must not</dfn>, <dfn>required</dfn>, <dfn>shall</dfn>, <dfn>shall not</dfn>, <dfn>should</dfn>, <dfn>should not</dfn>, <dfn>recommended</dfn>, <dfn>may</dfn>, and <dfn>optional</dfn> in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2199</a>.</p>
<p>Uses of the words "descriptive" and "information" in this document are to be interpreted as synonymous with "non-normative."</p>
<h3 id="sec.intro.conventions.typographical"><a href="#sec.intro.conventions.typographical" class="anchor">Typographical Conventions</a></h3>
<p>This document makes use of the following conventions to improve readability:</p>
<ul><li><p>When a term is introduced and defined, it will be in bold and italics. For example: a <dfn>duck</dfn> is something that looks like a <a>duck</a> and quacks like a <a>duck</a>.</p>
</li>
<li><p>Code fragments in Slang or other programming languages use a fixed-width font. For example: <code>a + b</code>.</p>
</li>
</ul>
<h3 id="sec.intro.conventions.meta"><a href="#sec.intro.conventions.meta" class="anchor">Meta-Values and Meta-Types</a></h3>
<p>The specification defines a variety of concepts (e.g., grammar productions, types, and values) that are used to define the static and dynamic semantics of Slang code.
In many cases, these concepts exist only to serve this specification, and cannot be directly named or manipulated in Slang code itself.</p>
<p>We refer to these abstract concepts as <dfn>meta-values</dfn>. All <a>meta-values</a> are themselves <a>values</a>.
A <dfn>meta-type</dfn> is a <a>type</a> with instances that are all <a>meta-values</a>.</p>
<p>This specification may introduce a named <a>meta-value</a> in prose, or via grammar rules.
When a <a>meta-value</a> is introduced or referenced, it name may be rendered using one of the following conventions:</p>
<ul><li><p>A <a>meta-value</a> name may be rendered in italics and <a>UpperCamelCase</a>. E.g., <a lt="if statement"><a>IfStatement</a></a>, <a lt="unit type"><a>UnitType</a></a></p>
</li>
<li><p>When a <a>meta-value</a> corresponds to a named declaration, keyword, attribute, or other entity that can be referenced in Slang code, its name may be rendered in a fixed-width font. E.g., the <a lt="unit type"><code>Unit</code></a> type.</p>
</li>
<li><p>In prose, a <a>meta-value</a> name may be rendered as ordinary English, possibly with words that reference Slang language keywords in a fixed-width font. E.g., <a lt="if statement"><code>if</code> statement</a>, <a lt="unit type">unit type</a>.</p>
</li>
</ul>
<p>In each case, the concept being referenced is the same; for example, the references <a lt="unit type"><a>UnitType</a></a>, <a lt="unit type"><code>Unit</code></a>, and <a lt="unit type">unit type</a> all refer to the same definition.</p>
<h3 id="sec.intro.conventions.meta.var"><a href="#sec.intro.conventions.meta.var" class="anchor">Meta-Variables</a></h3>
<p>A <dfn>meta-variable</dfn> is a placeholder name that may represents an unknown <a>meta-value</a> of some <a>meta-type</a>.
A <a>meta-variable</a> is rendered in italics, and must either be in <a>lowerCamelCase</a>, or consist of a single letter (either upper- or lower-case).
For example, text might introduce a <a>meta-variable</a> named <var ignore>e</var> that represents an unknown <a>expression</a>.</p>
<p>The text that introduces a <a>meta-variable</a> may explicitly specify the <a>type</a> of that variable.
When the name of a <a>meta-variable</a> matches the name of a <a>type</a>, then it is implicitly a variable of the corresponding type.</p>
<h3 id="sec.intro.conventions.meta.pattern"><a href="#sec.intro.conventions.meta.pattern" class="anchor">Patterns</a></h3>
<p>When introducing a <a>meta-value</a> that is an instance of some nonterminal in a grammar, this specification may express the value as a <dfn>meta-pattern</dfn>: a sequence of terminals and <a>meta-variables</a> that match the corresponding nonterminal.
For example, we might refer to "the <a>block statement</a> <code>{ <a><var class="meta">stmts</var></a> }</code>", implicitly introducing the <a>meta-variable</a> <a><var class="meta">stmts</var></a> of type <a><span class="meta">Statements</span></a>.</p>
<p>The type of a <a>meta-variable</a> in a <a>meta-pattern</a> may be explicitly specified in prose, or it may be implicit from the position of the <a>meta-variable</a> and the grammar production being matched.</p>
<p>A pattern may also specify a type for a <a>meta-variable</a> by immediately suffixing the <a>meta-variable</a> with a colon and a <a>type</a> in <a><span class="meta">UpperCamelCase</span></a>.
For example, a reference to "the <a>block statement</a> <code>{ <a><var class="meta">stmts</var></a></code>:<a><span class="meta">Statements</span></a> <code>}</code>" makes the type of <a><var class="meta">stmts</var></a> more explicit.</p>
<h3 id="sec.intro.conventions.meta.characteristic"><a href="#sec.intro.conventions.meta.characteristic" class="anchor">Characteristics of Meta-Values</a></h3>
<p>A <dfn>characteristic</dfn> of a <a>meta-value</a> is a named property, attribute, or quality of that value.</p>
<h3 id="sec.intro.conventions.callouts"><a href="#sec.intro.conventions.callouts" class="anchor">Callouts</a></h3>
<p>This document uses a few kinds of <dfn>callouts</dfn>, which start bold word indicating the kind of callout. For example, the following is a note:</p>
<div class="note callout">Note: Notes are rendered like this.</div>
<p>The kinds of <a>callouts</a> used in this document are:</p>
<div class="issue callout">Issue: List the cases we end up using here</div>
<h3 id="sec.intro.conventions.traditional"><a href="#sec.intro.conventions.traditional" class="anchor">Traditional and Legacy Features</a></h3>
<p>Some features of the Slang language are considered <dfn>traditional</dfn> or <dfn>legacy</dfn> features.
The language supports these constructs, syntax, etc. in order to facilitate compatibility with existing code in other GPU languages, such as HLSL.</p>
<p>Sections that introduce <a>traditional</a> or <a>legacy</a> features begin with a callout indicating the status of those features.</p>
<p><a>Legacy</a> features are those that undermine the consistency and simplicity of the language, and complicate its implementation, for little practical benefit.
These features should be considered as candidates for removal in future versions of this specification.
Legacy features are optional, unless otherwise indicated.</p>
<p><a>Traditional</a> features are those that may not represent the long-term design trajectory of the language, but that offer significant practical benefit to users of the language.
Traditional features are required, unless otherwise indicated.</p>
<h2 id="sec.intro.grammar"><a href="#sec.intro.grammar" class="anchor">Context-Free Grammars</a></h2>
<p>This specification uses <a>context-free grammars</a> to define:</p>
<ul><li><p>The lexical syntax of Slang</p>
</li>
<li><p>The abstract syntax of Slang</p>
</li>
<li><p>Representations for <a>meta-values</a> used in this specification</p>
</li>
</ul>
<p>A <dfn>context-free grammar</dfn> consists of an alphabet of <dfn>terminal</dfn> symbols, and zero or more <a>productions</a>.
A <dfn>production</dfn> consists of a <a>left-hand side</a> and a <a>right-hand side</a>.</p>
<p>The <dfn>left-hand side</dfn> of a <a>production</a> consists of a single <a>nonterminal</a> symbol.
A <a>production</a> is <dfn>for</dfn> the <a>nonterminal</a> on its <a>left-hand side</a>.</p>
<p>The <dfn>right-hand side</dfn> of a <a>production</a> consists of an ordered sequence of zero or more <a>nonterminal</a> and <a>terminal</a> symbols.</p>
<p>A <dfn>chain production</dfn> is a <a>production</a> that has exactly one <a>nonterminal</a> symbol on its <a>right-hand side</a>.</p>
<div class="note callout">Note: a chain production can have zero or more <a>terminals</a> on its <a>right-hand side</a>, in addition to the single <a>nonterminal</a>.</div>
<p>A <dfn>trivial production</dfn> is a <a>chain production</a> that has zero <a>terminals</a> on its <a>right-hand side</a>.
A <a>nonterminal</a> is abstract if all of the productions for that nonterminal are trivial productions.</p>
<p>A <dfn>nonterminal</dfn> of a <a>context-free grammar</a> is a <a>meta-type</a>.
An instance of a non-abstract <a>nonterminal</a> is the result of matching a <a>production</a> for that <a>nonterminal</a>, and consists of a sequence of matches for each of the terms on the <a>right-hand side</a> of that <a>production</a>.</p>
<p>An instance of an abstract <a>nonterminal</a> is an instance of one of the nonterminals on the right-hand side of one of its productions.</p>
<div class="note callout">Note: If there exists a trivial production for <a>nonterminal</a> <a><var class="meta">A</var></a> that has a <a>right-hand side</a> consisting of <a>nonterminal</a> <a><var class="meta">B</var></a>, then <a><var class="meta">B</var></a> is a subtype of <a><var class="meta">A</var></a>.</div>
<h3 id="sec.intro.grammar.notation"><a href="#sec.intro.grammar.notation" class="anchor">Notation</a></h3>
<p>This specification uses a notation inspired by Extended Backus-Naur Form to define <a>context-free grammars</a>.
The notation uses the following notational conventions:</p>
<h4 id="sec.intro.grammar.notation.production"><a href="#sec.intro.grammar.notation.production" class="anchor">Productions</a></h4>
<div class="issue callout">Issue: Need to write this up.</div>
<h4 id="sec.intro.grammar.notation.terminal"><a href="#sec.intro.grammar.notation.terminal" class="anchor">Terminals</a></h4>
<p>Terminals in the lexical and abstract syntax are rendered in a fixed-width font: e.g., <code>func</code>.</p>
<p>Terminals used in grammar rules for <a>meta-values</a> are rendered in bold: e.g., <dfn>extends</dfn>.</p>
<h4 id="sec.intro.grammar.notation.nonterminal"><a href="#sec.intro.grammar.notation.nonterminal" class="anchor">Nonterminals</a></h4>
<p>Nonterminals in grammar rules are named in upper camel case, and rendered in italics: e.g., <a>CallExpression</a>.
This convention is consistent with the notational conventions for <a>meta-types</a>.</p>
<p>A nonterminal on the right-hand side of a production may introduce a name for that nonterminal in lower camel case, using the same syntax as for <a>meta-variables</a> in <a>meta-patterns</a>. E.g., <a><var class="meta">base</var></a> : <a><span class="meta">TypeExpression</span></a>.</p>
<h4 id="sec.intro.grammar.notation.alternative"><a href="#sec.intro.grammar.notation.alternative" class="anchor">Terminals</a></h4>
<p>A plain-text vertical bar is used to separate alternatives. E.g., <a><span class="meta">IntegerLiteral</span></a> | <a><span class="meta">FloatingPointLiteral</span></a></p>
<h4 id="sec.intro.grammar.notation.optional"><a href="#sec.intro.grammar.notation.optional" class="anchor">Optionals</a></h4>
<p>A plain-text question mark (?) as a suffix indicates that the given element is optional. E.g., <a><span class="meta">Expression</span></a>?</p>
<h4 id="sec.intro.grammar.notation.sequence"><a href="#sec.intro.grammar.notation.sequence" class="anchor">Sequences</a></h4>
<p>A plain-text asterisk (*) as a suffix indicates that a given element may be repeated zero or more times. E.g., <a><span class="meta">Modifier</span></a> *</p>
<p>A plain-text plus sign (+) as a suffix indicates that a given element may be repeated one or more times. E.g., <a><span class="meta">AccessorDeclaration</span></a>+</p>
<p>As an additional convenience, when an asertisk or plus is applied to a grouping where the last item in that grouping is a terminal consisting of a single comma (<code>,</code>), that phrase represents a repetition of <a>comma-separated</a> elements.</p>
<h4 id="sec.intro.grammar.notation.grouping"><a href="#sec.intro.grammar.notation.grouping" class="anchor">Grouping</a></h4>
<p>Plain-text parentheses are used for grouping. E.g., <a>Expression</a> (<code>,</code> <a>Expression</a>)</p>
<h4 id="sec.intro.grammar.notation.exclusion"><a href="#sec.intro.grammar.notation.exclusion" class="anchor">Exclusion</a></h4>
<p>A plain-text minus (-) used as an infix operator matches input that matches its left operand but not its right operand.</p>
<h4 id="sec.intro.grammar.notation.characteristics"><a href="#sec.intro.grammar.notation.characteristics" class="anchor">Characteristics</a></h4>
<p>A match for a <a>production</a> will have zero or more characteristics introduced by the <a>right-hand side</a> of that production.</p>
<p>If the <a>right-hand side</a> of a non-trivial <a>production</a> <a><var class="meta">P</var></a> includes</p>
<ul><li><p>exactly one occurence of <a>nonterminal</a> <a><var class="meta">N</var></a>, or</p>
</li>
<li><p>a <a>nonterminal</a> <a><var class="meta">N</var></a> with a label <a><var class="meta">L</var></a></p>
</li>
</ul>
<p>then a match of that production has a characteristic with a name and type derived as follows:</p>
<ul><li><p>Let <a><var class="meta">label</var></a> be either <a><var class="meta">L</var></a>, if it is present, or the name of <a><var class="meta">N</var></a> otherwise</p>
</li>
<li><p>If <a><var class="meta">N</var></a> appears under a sequence (marked with * or +), then the type of the characteristic is <dfn>List<</dfn> <a><var class="meta">N</var></a> <dfn>></dfn>, and the name of the characteristic is the plural of <a><var class="meta">label</var></a></p>
</li>
<li><p>Otherwise, if <a><var class="meta">N</var></a> appears under a "?", then the type of the characteristic is <dfn>Optional<</dfn> <a><var class="meta">N</var></a> <dfn>></dfn>, and the name of the characteristic is <a><var class="meta">label</var></a></p>
</li>
<li><p>Otherwise, the type of the characteristic is <a><var class="meta">N</var></a>, and the name of the characteristic is <a><var class="meta">label</var></a></p>
</li>
</ul>
<p><div class="note">
As an example, given a grammar production like:</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Boat</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="introducer grammar"><span class="meta">mainMast</span>:<span class="meta">Mast</span></span> <span class="grammar"><span class="meta">Mast</span></span>* <span class="grammar"><span class="meta">Sail</span></span>* <span class="grammar"><span class="meta">Hold</span></span>?</span></span></div>
</pre>
</div>
<p>Then a match for this production would be a boat with the following characteristics:</p>
<ul><li><p>its <dfn>main mast</dfn>, of type <a>Mast</a></p>
</li>
<li><p>its <dfn>sails</dfn>, a list of <a>Sail</a>s</p>
</li>
<li><p>its <dfn>hold</dfn>, an <span class=allow-2119>optional</span> <a>Hold</a></p>
</li>
</ul>
<p>The term "Mast*" in the right-hand side of the production does not introduce a characteristic, because it is not the sole occurence of the non-terminal <a><span class="meta">Mast</span></a> on the right-hand side.
</div></p>
<h1 id="sec.lifecycle"><a href="#sec.lifecycle" class="anchor">Program Lifecycle</a></h1>
<h2 id="sec.lifecyle.compilation"><a href="#sec.lifecyle.compilation" class="anchor">Compilation</a></h2>
<p>A Slang <dfn>compiler</dfn> is a tool that is invoked on Slang source code to produce <dfn>object code</dfn>.</p>
<p>Object code produced by a Slang compiler from one toolchain may be incompatible with tools from other toolchains, other versions of the same toolchain, or across target platforms supported by the toolchain.</p>
<div class="note callout">Note: This specification does not prescribe the language or format of object code that a particular toolchain implementation has to use.
Object code might use a toolchain-specific IR, a portable intermediate language, or a format that is compatible with another existing toolchain (e.g., the object code format used by a C toolchain on the target).</div>
<p>A <a>compiler</a> implementation must support being invoked on an entire Slang source module, potentially comprising multiple source units, to produce object code for that entire module.
A <a>compiler</a> implementation may support being invoked on source code at other granularities: e.g., on a subset of the source units of a module.</p>
<p>When compiling code that is part of a Slang module <a><var class="meta">M</var></a>, the output of a compiler implementation must not depend on any non-<a>fragile</a> information in the modules that <a><var class="meta">M</var></a> depends on.</p>
<h2 id="sec.lifecycle.linking"><a href="#sec.lifecycle.linking" class="anchor">Linking</a></h2>
<p>A <dfn>static library</dfn> is a unit of code suitable for distribution or re-use.
Static libraries created by a toolchain should be usable with later versions of that same toolchain.</p>
<p>A <dfn>binary</dfn> is a unit of <dfn>loadable code</dfn> that is either an <dfn>executable</dfn> or a <dfn>dynamic library</dfn>.</p>
<div class="note callout">Note: We need to refer to <a>executables</a> and <a>dynamic libraries</a> somewhere in the text.</div>
<p>A Slang <dfn>linker</dfn> is a tool that is invoked on one or more inputs, consisting of units of <a>object code</a> and <a>static libraries</a>, to produce a <a>static library</a> or a <a>binary</a>.</p>
<p>A binary may contain <a>loadable code</a> for zero or more Slang modules.</p>
<div class="note callout">Note: it is possible that a linked binary might contain both code compiled from Slang as well as code generated from other languages, or by other tools.</div>
<p>It is invalid for a binary to contain code for non-<a>fragile</a> symbols from a Slang module <a><var class="meta">M</var></a> while also having external dependencies on symbols from <a><var class="meta">M</var></a>.
A <a>linker</a> may fail with an error rather than produce an invalid binary.</p>
<div class="note callout">Note: In practice, a linked binary has to either contain all of a given Slang module, or none of it.
The nuance is that <a>fragile</a> symbols, such as inlinable functions, from a module <a><var class="meta">M</var></a> might get copied into object code for a module <a><var class="meta">N</var></a> that depends on <a><var class="meta">M</var></a>, and thus end up in a binary for <a><var class="meta">N</var></a>.</div>
<h2 id="sec.lifecycle.loading"><a href="#sec.lifecycle.loading" class="anchor">Loading</a></h2>
<p>A Slang runtime must support <dfn>loading</dfn> <a>binaries</a> into a <a>runtime session</a>, and resolving dependencies between them.</p>
<p><a>Loading</a> of a binary containing definitions of non-fragile symbols from Slang module <a><var class="meta">M</var></a> must fail if any external symbol that <a><var class="meta">M</var></a> depends on has not already been loaded into the process.</p>
<p><a>Loading</a> of a binary containing non-fragile symbols from module <a><var class="meta">M</var></a> may fail if any binary containing definition of non-fragile symbols from <a><var class="meta">M</var></a> has already been loaded into the process.</p>
<p>It is valid to load a binary containing fragile symbols from module <a><var class="meta">M</var></a> even if other binaries containing one or more of those symbols has already been loaded, and even if the definitions of those fragile symbols differ between the binaries.
References to fragile symbols may resolve at runtime to any definition of those symbols that was compiled into object code that made its way into the binaries that are loaded.</p>
<p>If Slang code is stored in a <a>binary</a> for a <a>host</a>, then that code may be loaded as part of initialization of a <a>process</a> for a <a>host</a> <a>executable</a>.</p>
<p>If a <a>module</a> of Slang code is loaded programmatically, a Slang runtime must return a <a>mirror</a> reflecting that module.</p>
<h2 id="sec.lifecyle.reflection"><a href="#sec.lifecyle.reflection" class="anchor">Runtime Reflection</a></h2>
<p>A Slang runtime may support reflection of <a>modules</a> that have been loaded into a <a>runtime session</a>.</p>
<p>A <dfn>mirror</dfn> is a runtime value that reflects some entity in a Slang codebase.
A <a>mirror</a> is created and managed by a <a>runtime session</a>, and reflects entities in the code that has been loaded into that runtime session.
A <a>mirror</a> that reflects an <a><var class="meta">X</var></a> is also called an <a><var class="meta">X</var></a> <a>mirror</a>.</p>
<p>Example: A <a>module</a> <a>mirror</a> is a <a>mirror</a> that reflects a <a>module</a>.</p>
<p>A <a>mirror</a> may reflect:</p>
<ul><li><p>A module</p>
</li>
<li><p>A declaration</p>
</li>
<li><p>A reference to a declaration</p>
</li>
<li><p>A type</p>
</li>
<li><p>A value</p>
</li>
</ul>
<p>A <a>mirror</a> is not the same as the entity it reflects.</p>
<h2 id="sec.lifecycle.bundling"><a href="#sec.lifecycle.bundling" class="anchor">Bundling</a></h2>
<p><div class="issue">
This concept needs a proper name.
</div></p>
<p>A <dfn>bundle</dfn> is a runtime entity composed from a sequence of distinct runtime entities where each element in the sequence is one of:</p>
<ul><li><p>A module</p>
</li>
<li><p>An entry point (a fully specialized reference to an entry point declaration)</p>
</li>
<li><p>A witness to conformance relationship of a type to an interface</p>
</li>
<li><p>A bundle</p>
</li>
</ul>
<p>A Slang runtime must support creation of a <a>bundle</a> from a sequence of <a>mirrors</a> reflecting the runtime entities to be bundled.</p>
<p>The entry points in a bundle are the entry points in the input sequence.</p>
<p>The modules in a bundle are the set of modules in the input sequence, the modules referenced by the entities in the input sequence, and the transitive closure of modules imported by those.</p>
<p>The global uniform shader parameters of a bundle are the global uniform shader parameters declared in modules in the bundle.</p>
<p>The entry point uniform shader parameters of a bundle are the entry-point uniform shader parameters declared by entry points in the bundle.</p>
<p>The shader parameters of a bundle are the global uniform shader parameters of the bundle and the entry-point uniform shader parameters of the bundle.</p>
<p>A <dfn>kernel</dfn> is a runtime entity created from a bundle, an entry point in that bundle, and a target device.</p>
<p>A kernel created from a bundle <a><var class="meta">B</var></a> is compatible with kernels created from a bundle <a><span class="meta">BX</span></a> where <a><span class="meta">BX</span></a> was created from an input sequence that started with <a><var class="meta">B</var></a>.</p>
<h1 id="sec.CHAPTER.lex"><a href="#sec.CHAPTER.lex" class="anchor">Lexical Structure</a></h1>
<p>This chapter describes how a <a>source unit</a> is decomposed into a sequence of <a>lexemes</a>.</p>
<h2 id="sec.lex.source-unit"><a href="#sec.lex.source-unit" class="anchor">Source Units</a></h2>
<p>A <dfn>source unit</dfn> comprises a sequence of zero or more <a>characters</a>.
For the purposes of this document, a <dfn>character</dfn> is defined as a [[!Unicode]] scalar value.</p>
<div class="note callout">Note: A Unicode scalar value is a Unicode code point that is not a surrogate code point.</div>
<p>Implementations may accept <a>source units</a> stored as files on disk, buffers in memory, or any appropriate implementation-specified means.</p>
<h2 id="sec.lex.encoding"><a href="#sec.lex.encoding" class="anchor">Encoding</a></h2>
<p>Implementations must support <a>source units</a> encoded using UTF-8, if they support any encoding of <a>source units</a> as byte sequences.</p>
<p>Implementations should default to the UTF-8 encoding for all text input/output.</p>
<p>Implementations may support additional implementation-specified encodings.</p>
<h2 id="sec.lex.phase"><a href="#sec.lex.phase" class="anchor">Phases</a></h2>
<p>Lexical processing of a <a>source unit</a> proceeds <a>as if</a> the following steps are executed in order:</p>
<ul><li><p>Line numbering (for subsequent diagnostic messages) is noted based on the locations of <a>line breaks</a></p>
</li>
<li><p><a>Escaped line breaks</a> are eliminated. No new <a>characters</a> are inserted to replace them. Any new <a>escaped line breaks</a> introduced by this step are not eliminated.</p>
</li>
<li><p>Each comment is replaced with a single space (U+0020)</p>
</li>
<li><p>The <a>source unit</a> is <a lt=lex>lexed</a> into a sequence of <a>tokens</a> according to the lexical grammar in this chapter</p>
</li>
<li><p>The lexed sequence of tokens is <a><var class="meta">preprocessed</var></a> to produce a new sequence of tokens</p>
</li>
</ul>
<p>The final <a>token</a> sequence produced by this process is used as input to subsequent phases of compilation.</p>
<h2 id="sec.lex.lexeme"><a href="#sec.lex.lexeme" class="anchor">Lexemes</a></h2>
<p>A <dfn>lexeme</dfn> is a contiguous sequence of characters in a single <a>source unit</a>.</p>
<p><dfn>Lexing</dfn> is the process by which an implementation decomposes a <a>source unit</a> into zero or more non-overlapping <a>lexemes</a>.</p>
<p>Every <a>lexeme</a> is either a <a>token</a> or it is <a>trivia</a>.</p>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Lexeme</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Token</span></span>
⇒ <span class="alternative grammar"><span class="meta">Trivia</span></span></div>
</pre>
</div>
<h3 id="sec.lex.trivia"><a href="#sec.lex.trivia" class="anchor">Trivia</a></h3>
<p><dfn>Trivia</dfn> are <a>lexemes</a> that do not appear in the abstract syntax; they are only part of the lexical grammar.
The presence or absence of <a>trivia</a> in a sequence of <a>lexemes</a> has no semantic impact, except where specifically noted in this specification.</p>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Trivia</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Whitespace</span></span>
⇒ <span class="alternative grammar"><span class="meta">Comment</span></span></div>
</pre>
</div>
<div class="note callout">Note: Trivia is either <a>whitespace</a> or a <a>comment</a>.</div>
<h4 id="sec.lex.trivia.space"><a href="#sec.lex.trivia.space" class="anchor">Whitespace</a></h4>
<p><dfn>Whitespace</dfn> consists of <a>horizontal whitespace</a> and <a>line breaks</a>.</p>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Whitespace</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">HorizontalSpace</span></span>
⇒ <span class="alternative grammar"><span class="meta">LineBreak</span></span></div>
</pre>
</div>
<p><dfn>Horizontal whitespace</dfn> consists of any sequence of space (U+0020) and horizontal tab (U+0009).</p>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">HorizontalSpace</span></dfn>
⇒ <span class="alternative grammar"><span class="grammar">(<span class="grammar"><span class="grammar"><code> </code> | <code>\t</code></span></span>)</span>+</span></div>
</pre>
</div>
<h5 id="sec.lex.trivia.space.line-break"><a href="#sec.lex.trivia.space.line-break" class="anchor">Line Breaks</a></h5>
<p>A <dfn>line break</dfn> consists of a line feed (U+000A), carriage return (U+000D) or a carriage return followed by a line feed (U+000D, U+000A).</p>
<p>An <dfn>escaped line break</dfn> is a backslash (<code>\</code>, U+005C) follow immediately by a <a>line break</a>.</p>
<p>A <a>source unit</a> is split into <dfn>lines</dfn>: non-empty sequences of <a>characters</a> separated by <a>line breaks</a>.</p>
<div class="note callout">Note: Line breaks are used as <a>line</a> separators rather than terminators; it is not necessary for a <a>source unit</a> to end with a line break.</div>
<h4 id="sec.lex.trivia.comment"><a href="#sec.lex.trivia.comment" class="anchor">Comments</a></h4>
<p>A <dfn>comment</dfn> is either a <a>line comment</a> or a <a>block comment</a>.</p>
<p>A <dfn>line comment</dfn> comprises two forward slashes (<code>/</code>, U+002F) followed by zero or more characters that do not contain a <a>line break</a>.
A <a>line comment</a> extends up to, but does not include, a subsequent <a>line break</a> or the end of the <a>source unit</a>.</p>
<p>A <dfn>block comment</dfn> begins with a forward slash (<code>/</code>, U+002F) followed by an asterisk (<code>*</code>, U+0052).
A <a>block comment</a> is terminated by the next instance of an asterisk followed by a forward slash (<code>*/</code>).
A <a>block comment</a> contains all <a>characters</a> between where it begins and where it terminates, including any <a>line breaks</a>.</p>
<div class="note callout">Note: <a>Block comments</a> do not nest.</div>
<p>It is an error if a <a>block comment</a> that begins in a <a>source unit</a> is not terminated in that <a>source unit</a>.</p>
<h3 id="sec.lex.token"><a href="#sec.lex.token" class="anchor">Tokens</a></h3>
<p><dfn>Tokens</dfn> are lexemes that are significant to the abstract syntax.</p>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Token</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Identifier</span></span>
⇒ <span class="alternative grammar"><span class="meta">Literal</span></span>
⇒ <span class="alternative grammar"><span class="meta">Operator</span></span>
⇒ <span class="alternative grammar"><span class="meta">Puncutation</span></span></div>
</pre>
</div>
<h4 id="sec.lex.token.ident"><a href="#sec.lex.token.ident" class="anchor">Identifiers</a></h4>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Identifier</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">IdentifierStart</span> <span class="grammar"><span class="meta">IdentifierContinue</span></span>*</span></span></div>
<div class="grammar production"><dfn><span class="meta">IdentifierStart</span></dfn>
⇒ <span class="alternative grammar">[<span class="character-class grammar"><span class="character-range grammar"><span class="character grammar">A</span>-<span class="character grammar">Z</span></span></span>]</span>
⇒ <span class="alternative grammar">[<span class="character-class grammar"><span class="character-range grammar"><span class="character grammar">a</span>-<span class="character grammar">z</span></span></span>]</span>
⇒ <span class="alternative grammar"><code>_</code></span></div>
<div class="grammar production"><dfn><span class="meta">IdentifierContinue</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">IdentifierStart</span></span>
⇒ <span class="alternative grammar">[<span class="character-class grammar"><span class="character-range grammar"><span class="character grammar">0</span>-<span class="character grammar">9</span></span></span>]</span></div>
</pre>
</div>
<div class="issue callout">TODO: <dfn>identifier</dfn>.</div>
<p>The identifier consisting of a single underscore (<code>_</code>) is reserved by the language and must not be used by programs as a name in a declaration or binding.</p>
<div class="note callout">Note: There are no other fixed keywords or reserved words recognized by the lexical grammar.</div>
<h4 id="sec.lex.token.lit"><a href="#sec.lex.token.lit" class="anchor">Literals</a></h4>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Literal</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">NumericLiteral</span></span>
⇒ <span class="alternative grammar"><span class="meta">TextLiteral</span></span></div>
</pre>
</div>
<div class="issue callout">TODO: <dfn>literal</dfn>, <a>numeric literal</a>.</div>
<h5 id="sec.lex.token.num"><a href="#sec.lex.token.num" class="anchor">Numeric Literals</a></h5>
<p>A <dfn>numeric literal</dfn> is either an <a>integer literal</a> or a <a>floating-point literal</a>.</p>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">NumericLiteral</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">IntegerLiteral</span></span>
⇒ <span class="alternative grammar"><span class="meta">FloatingPointLiteral</span></span></div>
</pre>
</div>
<p>A <dfn>radix specifier</dfn> is one of:</p>
<ul><li><p><code>0x</code> or <code>0X</code> to specify a <dfn>hexadecimal literal</dfn> (radix 16)</p>
</li>
<li><p><code>0b</code> or <code>0B</code> to specify a <dfn>binary literal</dfn> (radix 2)</p>
</li>
</ul>
<p>When no radix specifier is present, a numeric literal is a <dfn>decimal literal</dfn> (radix 10).</p>
<div class="note callout">Note:Octal literals (radix 8) are not supported.
A <code>0</code> prefix on an integer literal is not used to specify an octal literal as it does in C.
Implementations might warn on integer literals with a <code>0</code> prefix in case users expect C behavior.</div>
<p>The grammar of the <dfn>digits</dfn> for a numeric level depend on its radix, as follows:</p>
<ul><li><p>The <a>digits</a> of a <a>decimal literal</a> may include <code>0</code> through <code>9</code></p>
</li>
<li><p>The <a>digits</a> of a <a>hexadecimal literal</a> may include <code>0</code> through <code>9</code>, the letters <code>A</code> through <code>F</code> and <code>a</code> through <code>f</code>. The letters represent digit values 10 through 15.</p>
</li>
<li><p>The <a>digits</a> of a <a>binary literal</a> may include <code>0</code> and <code>1</code></p>
</li>
</ul>
<p>Digits for all numeric literals may also include <code>_</code>, which are ignored and have no semantic impact.</p>
<p>A <dfn>numeric literal suffix</dfn> consists of any sequence of characters that would be a valid identifier, that does not start with <code>e</code> or <code>E</code>.</p>
<div class="note callout">Note: A leading <code>-</code> (U+002D) before a numeric literal is <a>not</a> part of the literal, even if there is no whitespace separating the two.</div>
<h4 id="sec.lex.token.int"><a href="#sec.lex.token.int" class="anchor">Integer Literals</a></h4>
<p>An <dfn>integer literal</dfn> consists of an optional radix specifier followed by digits and an optional <a>numeric literal suffix</a>.</p>
<p>The suffix on an integer literal may be used to indicate the desired type of the literal:</p>
<ul><li><p>A <code>u</code> suffix indicates the <code>UInt</code> type</p>
</li>
<li><p>An <code>l</code> or <code>ll</code> suffix indicates the <code>Int64</code> type</p>
</li>
<li><p>A <code>ul</code> or <code>ull</code> suffix indicates the <code>UInt64</code> type</p>
</li>
</ul>
<h4 id="sec.lex.token.float"><a href="#sec.lex.token.float" class="anchor">Floating-Point Literals</a></h4>
<p>A <dfn>floating-point literal</dfn> consists of either</p>
<ul><li><p>An optional <a>radix specifier</a>, followed by digits, followed by a <code>.</code> (U+002E), followed by optional digits, an optional <a>exponent</a>, and an optional numeric literal suffix.</p>
</li>
<li><p>An optional <a>radix specifier</a>, followed by digits, an exponent, and an optional numeric literal suffix.</p>
</li>
<li><p>A <code>.</code> (U+002E) followed by digits, an optional exponent, and an optional numeric literal suffix.</p>
</li>
</ul>
<p>A floating-point literal may only use dexicmal or hexadecimal radix.</p>
<p>The <dfn>exponent</dfn> of a floating-pointer literal consists of either <code>e</code> or <code>E</code>, followed by an optional <dfn>sign</dfn> of <code>+</code> or <code>-</code>, followed by decimal digits.</p>
<div class="issue callout">TODO: <a>sign</a>.</div>
<h3 id="sec.lex.token.text"><a href="#sec.lex.token.text" class="anchor">Text Literals</a></h3>
<div class="issue callout">Issue: Need to document supported escape sequences.</div>
<h4 id="sec.lex.token.string"><a href="#sec.lex.token.string" class="anchor">String Literals</a></h4>
<p>A <dfn>string literal</dfn> consists of a sequence of characters enclosed between two <code>"</code>, with the constraint that any <code>"</code> within the sequence must be escaped with <code>\</code>.</p>
<div class="issue callout">TODO: <a>string literal</a></div>
<h4 id="sec.lex.token.char"><a href="#sec.lex.token.char" class="anchor">Character Literals</a></h4>
<p>A <dfn>character literal</dfn> consists of a sequence of characters enclosed between two <code>'</code>, with the constraint that any <code>'</code> within the sequence must be escaped with <code>\</code>.</p>
<p>The sequence of characters within a <a>character literal</a> must represent a single character.</p>
<h2 id="sec.lex.token.punctuation"><a href="#sec.lex.token.punctuation" class="anchor">Operators and Punctuation</a></h2>
<p>The following table defines tokens that are used as operators and punctuation in the syntax.
When a given sequence of characters could be interpreted as starting with more than one of the following tokens, the longest matching token is used.
The name or names given to tokens by this table may be used in the rest of this document to refer to those tokens.</p>
<div class="lexical grammar callout"><pre class="lexical grammar">
<div class="grammar production"><dfn><span class="meta">Punctuation</span></dfn>
⇒ <span class="alternative grammar"><code>(</code></span>
⇒ <span class="alternative grammar"><code>)</code></span>
⇒ <span class="alternative grammar"><code>[</code></span>
⇒ <span class="alternative grammar"><code>]</code></span>
⇒ <span class="alternative grammar"><code>{</code></span>
⇒ <span class="alternative grammar"><code>}</code></span>
⇒ <span class="alternative grammar"><code>;</code></span>
⇒ <span class="alternative grammar"><code>:</code></span>
⇒ <span class="alternative grammar"><code>,</code></span>
⇒ <span class="alternative grammar"><code>.</code></span>
⇒ <span class="alternative grammar"><code>...</code></span>
⇒ <span class="alternative grammar"><code>::</code></span>
⇒ <span class="alternative grammar"><code>-></code></span></div>
<div class="grammar production"><dfn><span class="meta">Operator</span></dfn>
⇒ <span class="alternative grammar"><code>`</code></span>
⇒ <span class="alternative grammar"><code>!</code></span>
⇒ <span class="alternative grammar"><code>@</code></span>
⇒ <span class="alternative grammar"><code>$</code></span>
⇒ <span class="alternative grammar"><code>%</code></span>
⇒ <span class="alternative grammar"><code>~</code></span>
⇒ <span class="alternative grammar"><code>^</code></span>
⇒ <span class="alternative grammar"><code>&</code></span>
⇒ <span class="alternative grammar"><code>*</code></span>
⇒ <span class="alternative grammar"><code>-</code></span>
⇒ <span class="alternative grammar"><code>=</code></span>
⇒ <span class="alternative grammar"><code>+</code></span>
⇒ <span class="alternative grammar"><code>|</code></span>
⇒ <span class="alternative grammar"><code><</code></span>
⇒ <span class="alternative grammar"><code>></code></span>
⇒ <span class="alternative grammar"><code>/</code></span>
⇒ <span class="alternative grammar"><code>?</code></span>
⇒ <span class="alternative grammar"><code>==</code></span>
⇒ <span class="alternative grammar"><code>!=</code></span>
⇒ <span class="alternative grammar"><code>%=</code></span>
⇒ <span class="alternative grammar"><code>+=</code></span>
⇒ <span class="alternative grammar"><code>^=</code></span>
⇒ <span class="alternative grammar"><code>&=</code></span>
⇒ <span class="alternative grammar"><code>*=</code></span>
⇒ <span class="alternative grammar"><code>-=</code></span>
⇒ <span class="alternative grammar"><code>|=</code></span>
⇒ <span class="alternative grammar"><code><=</code></span>
⇒ <span class="alternative grammar"><code>>=</code></span>
⇒ <span class="alternative grammar"><code>/=</code></span>
⇒ <span class="alternative grammar"><code>&&</code></span>
⇒ <span class="alternative grammar"><code>--</code></span>
⇒ <span class="alternative grammar"><code>++</code></span>
⇒ <span class="alternative grammar"><code>||</code></span>
⇒ <span class="alternative grammar"><code><<</code></span>
⇒ <span class="alternative grammar"><code>>></code></span></div>
</pre>
</div>
<h2 id="sec.lex.token.trivia"><a href="#sec.lex.token.trivia" class="anchor">Associating Trivia With Tokens</a></h2>
<div class="issue callout">Issue: We should define lexing in terms of producing a sequence of tokens-with-trivia instead of just lexemes.</div>
<p>Each token in a source unit may be prededed or followed by trivia:</p>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">TokenWithTrivia</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">LeadingTrivia</span> <span class="meta">Token</span> <span class="meta">TrailingTrivia</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">LeadingTrivia</span></dfn>
⇒ <span class="alternative grammar"><span class="grammar"><span class="meta">Trivia</span></span>*</span></div>
<div class="grammar production"><dfn><span class="meta">TrailingTrivia</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="grammar">(<span class="grammar"><span class="grammar"><span class="meta">Trivia</span> - <span class="meta">LineBreak</span></span></span>)</span>* <span class="grammar"><span class="meta">LineBreak</span></span>?</span></span></div>
</pre>
</div>
<p>A compiler implementation must use the "maximal munch" rule when lexing, so that each <a>TokenWithTrivia</a> includes as many characters of <a>TrailingTrivia</a> as possible.</p>
<div class="note callout">Note: Informally, the trailing trivia of a token is all the trivia up to the next line break, the next token, or the end of the source unit - whichever comes first.
The leading trivia of a token starts immediately after the trailing trivia of the preceding token, or at the beginning of the file if there is no preceding token.</div>
<p>Lexing decomposes a source unit into a sequence of zero or more tokens with trivia, as well as zero or more pieces of trivia that do not belong to any token:</p>
<div class="lexical grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">LexicalSourceUnit</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="grammar"><span class="meta">TokenWithTrivia</span></span>* <span class="grammar"><span class="meta">Trivia</span></span>*</span></span></div>
</pre>
</div>
<p>The terminals of the context-free grammar should be understood to be tokens with trivia.
A reference to a nonterminal <a><var class="meta">N</var></a> in productions for the abstract syntax should be understood as matching the <a>TokenWithTrivia</a> rule, restricted to the case where the contained token is <a><var class="meta">N</var></a>.</p>
<div class="issue callout">Issue: We should probably make a dedicated <dfn>EOF</dfn> be part of the alphabet for input source units, so that the <a>LexicalSourceUnit</a> can be simpler to define.
E.g., "The alphabet of the lexical grammar comprises all Unicode scalar values, as well as the unique meta-value <dfn>EOF</dfn>."</div>
<h1 id="sec.prepro"><a href="#sec.prepro" class="anchor">Preprocessor</a></h1>
<p>As the last phase of lexical processing the token sequence of a <a>source unit</a> is preprocessed to produce a new token stream.</p>
<p>The preprocessor supported by Slang is derived from the C/C++ preprocessor with a few changes and extensions.</p>
<div class="issue callout">Issue: We either need to pick a normative reference here for some existing preprocessor (and thus bind ourselves to eventually supporting the semantics of that normative reference), or we need to take the time to fully document what the semantics of our current preprocessor are.</div>
<p>Slang programs may use the following preprocessor directives, with the same semantics as their C/C++ equivalent:</p>
<ul><li><p><code>#include</code></p>
</li>
<li><p><code>#define</code></p>
</li>
<li><p><code>#undef</code></p>
</li>
<li><p><code>#if</code>, <code>#ifdef</code>, <code>#ifndef</code></p>
</li>
<li><p><code>#else</code>, <code>#elif</code></p>
</li>
<li><p><code>#endif</code></p>
</li>
<li><p><code>#error</code></p>
</li>
<li><p><code>#warning</code></p>
</li>
<li><p><code>#line</code></p>
</li>
<li><p><code>#pragma</code></p>
</li>
</ul>
<p>An implementation may use any implementation-specified means to resolve paths provided to <code>#include</code> directives.</p>
<p>An implementation that supports <code>#pragma  once</code> may use any implementation-specified means to determine if two <a>source units</a> are identical.</p>
<h2 id="sec.prepro.changes"><a href="#sec.prepro.changes" class="anchor">Changes</a></h2>
<p>The input to the Slang preprocessor is a token sequence produced by the rules in Chapter 2, and does not use the definition of "preprocessor tokens" as they are used by the C/C++ preprocessor.</p>
<div class="note callout">Note: The key place where this distinction matters is in macros that perform token pasting.
The input to the Slang preprocessor has to be a valid sequence of tokens <a>before</a> any token pasting occurs.</div>
<p>When tokens are pasted with the <code>##</code> operator, the resulting concatenated text is decomposed into one or more new tokens.
It is an error if the concatenated text does not form a valid sequence of tokens.</p>
<div class="note callout">Note: The C/C++ preprocessor always yields a single token from any token pasting, whether or not that token is valid.</div>
<h2 id="sec.prepro.extensions"><a href="#sec.prepro.extensions" class="anchor">Extensions</a></h2>
<div class="issue callout">Issue: At the very least we need to document support for the GLSL <code>#version</code> directive, if we intend to keep it.</div>
<h1 id="sec.parse"><a href="#sec.parse" class="anchor">Parsing</a></h1>
<p><div class=issue>
The intention of this chapter is to establish the overall rules for the recursive-descent <a>parsing</a> strategy needed for Slang's grammar.</p>
<p>Slang attempts to thread the needle by supporting the familiar C-like syntax of existing shading languages, while also support out-of-order declarations.
The parsing strategy is necessarily complicated as a result, but we hope to isolate most of the details to this chapter so that the grammar for each construct can be presented in its simplest possible fashion.
</div></p>
<p><dfn>Parsing</dfn> is the process of matching a sequence of tokens from the lexical grammar with a rule of the abstract syntax grammar.</p>
<h2 id="sec.parse.context"><a href="#sec.parse.context" class="anchor">Contexts</a></h2>
<p>Parsing is always performed with respect to a <a>context</a>, which determines which identifiers are bound, and what they are bound to.</p>
<p>The <dfn>initial context</dfn> for parsing includes bindings for syntax rules corresponding to each declaration, statement, and expression keyword defined in this specification.</p>
<div class="note callout">Note: For example, an <code>if</code> expression begins with the <code>if</code> keyword, so the <a>initial context</a> contains a binding for the identifier <code>if</code> to a syntax rule that parses an <code>if</code> expression.</div>
<p>The initial context also includes bindings for the declarations in the Slang standard library.
Implementations may include additional bindings in the initial context.</p>
<h2 id="sec.parse.strat"><a href="#sec.parse.strat" class="anchor">Strategies</a></h2>
<p>Parsing is always performed in one of two modes: <a>unordered</a> or <a>ordered</a>.
Unless otherwise specified, each grammar rule matches its sub-rules in the same mode.</p>
<h3 id="sec.parse.strat.ordered"><a href="#sec.parse.strat.ordered" class="anchor">Ordered</a></h3>
<p>Parsing in <dfn>ordered</dfn> mode interleaves parsing and semantic analysis.
When the parser is in ordered mode and is about to parse a <a>declaration</a>, <a>statement</a>, or <a>expression</a>, and the lookahead is an Identifier, it first looks up that identifier in the context.</p>
<ul><li><p>If the identifier is bound to a syntax rule <a><var class="meta">s</var></a>, then the parser attempts to match the corresponding production in the grammar given here.</p>
</li>
<li><p>Otherwise, the parser first matches a <a>term</a>, and then based on whether the result of checking that term is a <a>type</a> or an <a>expression</a>, it either considers only productions starting with a <a>type expression</a> or those starting with an <a>expression</a>.</p>
</li>
</ul>
<p>If the parser is in ordered mode and is about to parse a <a>declaration body</a>, it switches to unordered mode before parsing the body, and switches back to ordered mode afterward.</p>
<h3 id="sec.parse.strat.unordered"><a href="#sec.parse.strat.unordered" class="anchor">Unordered</a></h3>
<p>In <dfn>unordered</dfn> mode, semantic analysis is deferred.</p>
<p>When the parser is in unordered mode and is about to parse a <a>declaration</a>, and the lookahead is an Identifier, it first looks up that identifier in the context.</p>
<ul><li><p>If the identifier is bound to a syntax rule <a><var class="meta">s</var></a>, then the parser attempts to match the corresponding production in the grammar given here.</p>
</li>
<li><p>Otherwise, it considers only productions that start with a <a>type specifier</a>.</p>
</li>
</ul>
<p><dfn>Balanced tokens</dfn> are those that match the following production:</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">BalancedTokens</span></dfn>
⇒ <span class="alternative grammar"><span class="grammar"><span class="meta">BalancedToken</span></span>*</span></div>
<div class="grammar production"><dfn><span class="meta">BalancedToken</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>{</code> <span class="meta">BalancedTokens</span> <code>}</code></span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>(</code> <span class="meta">BalancedTokens</span> <code>)</code></span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>[</code> <span class="meta">BalancedTokens</span> <code>]</code></span></span>
⇒ <span class="alternative grammar"><span class="block-comment grammar">/* any token other than `{`, `}`, `(`, `)`, `[`, `]` */</span></span></div>
</pre>
</div>
<p>A <dfn>balanced</dfn> rule in the grammar is one that meets one of the following criteria:</p>
<ul><li><p>starts with a <code>{</code> and ends with a <code>}</code></p>
</li>
<li><p>starts with a <code>(</code> and ends with a <code>)</code></p>
</li>
<li><p>starts with a <code>[</code> and ends with a <code>]</code></p>
</li>
</ul>
<p>Whenever the parser is in ordered mode and would attempt to match a <a>balanced</a> rule <a><var class="meta">r</var></a>, it instead matches the <a>balanced token</a> rule and saves the token sequence that was matched.
Those tokens are then matched against <a><var class="meta">r</var></a> as part of semantic analysis, using the context that the checking rules specify.</p>
<h2 id="sec.parse.angle"><a href="#sec.parse.angle" class="anchor">Angle Brackets</a></h2>
<h3 id="sec.parse.angle.open"><a href="#sec.parse.angle.open" class="anchor">Opening Angle Brackets</a></h3>
<h4 id="sec.parse.angle.open.ordered"><a href="#sec.parse.angle.open.ordered" class="anchor">Ordered Mode</a></h4>
<p>If the parser is in ordered mode with a lookahead of <code><</code>, and it could match that token as part of either an <a>infix expression</a> or a <a>specialize expression</a>, then it considers the term that has been matched so far:</p>
<ul><li><p>If the term has a generic type or overloaded type, then the <a>specialize expression</a> case is favored.</p>
</li>
<li><p>Otherwise the <a>infix expression</a> case is favored.</p>
</li>
</ul>
<h4 id="sec.parse.angle.open.unordered"><a href="#sec.parse.angle.open.unordered" class="anchor">Unordered Mode</a></h4>
<p>If the parser is in ordered mode with a lookahead of <code><</code>, and it could match that token as part of either an  <a>infix expression</a> or a <a>specialize expression</a>, then it first attempts to match the <a>generic arguments</a> rule. If that rule is matched successfully, then the new lookahead token is inspected:</p>
<ul><li><p>If the lookahead token is an <a>identifier</a>, <code>(</code>, <a>literal</a>, or <a>prefix operator</a>, then roll back to before the <code><</code> was matched and favor the  <a>infix expression</a> rule.</p>
</li>
<li><p>Otherwise, use the generic arguments already matched as part of matching the <a>specialize expression</a> rule.</p>
</li>
</ul>
<h3 id="sec.parse.angle.close"><a href="#sec.parse.angle.close" class="anchor">Closing Angle Brackets</a></h3>
<p>If the parser is attempting to match the closing <code>></code> in the <a>generic parameters</a> or <a>generic arguments</a> rules, and the lookahead is any token other than <code>></code> that starts with a <code>></code> character (<code>>=</code>, <code>>></code>, or <code>>>=</code>), then it splits the opening <code>></code> off and matches it, replacing the lookahead with a token comprised of the remaining characters (<code>=</code>, <code>></code>, or <code>>=</code>).</p>
<h1 id="sec.section.type"><a href="#sec.section.type" class="anchor">Types and Values</a></h1>
<p>A <dfn>type</dfn> is a set of <dfn>values</dfn>;
the values in that set are <dfn>instances</dfn> of the type.</p>
<div class="note callout">Note: A given <a>value</a> might be an <a>instance</a> of zero or more <a>types</a>. We avoid saying that a value <a>has</a> some type, except in cases where there is an "obviously right" type for such a value.</div>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Value</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">ImplicitlyTypedValue</span></span>
⇒ <span class="alternative grammar"><span class="meta">UntypedValue</span></span></div>
<div class="grammar production"><dfn><span class="meta">TypedValue</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">ImplicitlyTypedValue</span></span>
⇒ <span class="alternative grammar"><span class="meta">ExplicitlyTypedValue</span></span></div>
<div class="grammar production"><dfn><span class="meta">ExplicitlyTypedValue</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">UntypedValue</span> <code>:</code> <span class="meta">Type</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">ImplicitlyTypedValue</span></dfn>
⇒ <span class="alternative grammar"><span class="block-comment grammar">/* TODO */</span></span></div>
<div class="grammar production"><dfn><span class="meta">UntypedValue</span></dfn>
⇒ <span class="alternative grammar"><span class="block-comment grammar">/* TODO */</span></span></div>
</pre>
</div>
<h2 id="sec.value.level"><a href="#sec.value.level" class="anchor">Level</a></h2>
<p>Every <a>value</a> has a positive integer <dfn>level</dfn>.</p>
<div class="note callout">Note: Typical values that a Slang program calculates and works with have <a>level</a> zero.</div>
<h2 id="sec.type.type"><a href="#sec.type.type" class="anchor">Types of Types</a></h2>
<p>A <a>type</a> is itself a <a>value</a>.</p>
<p>The level of a <a>type</a> is one greater than the maximum of zero and the maximum level of the instances of that type.</p>
<div class="note callout">Note: It is impossible for a type to be an instance of itself.</div>
<p>A <a>type</a> whose instances are all <a>values</a> with <a>level</a> zero is a <dfn>proper type</dfn>.</p>
<div class="note callout">Note: Most of what a programmer thinks of as types are <a>proper types</a>. The <a>level</a> of a <a>proper type</a> will always be one.</div>
<p>A <a>type</a> whose instances are <a>types</a> with <a>level</a> one is a <dfn>kind</dfn>.</p>
<p>The <a>kind</a> <code>Type</code> is the <a>kind</a> of all <a>proper types</a>.</p>
<p>A <a>type</a> whose instances are <a>types</a> with <a>level</a> two is a <dfn>sort</dfn>.</p>
<p>The <a>sort</a> <code>Kind</code> is the <a>sort</a> of all <a>kinds</a>.</p>
<h2 id="sec.type.scalar"><a href="#sec.type.scalar" class="anchor">Scalars</a></h2>
<p>All scalar values have <a>level</a> zero.</p>
<h3 id="sec.type.unit"><a href="#sec.type.unit" class="anchor">Unit</a></h3>
<p>The <dfn>unit type</dfn>, named <a lt="unit type"><code>Unit</code></a>, has a single instance: the <dfn>unit value</dfn>.
The name <code>void</code> is an alias for the unit type.</p>
<h3 id="sec.type.bool"><a href="#sec.type.bool" class="anchor">Booleans</a></h3>
<p>The type <code>Bool</code> has two instances: <code>true</code> and <code>false</code>.</p>
<h3 id="sec.type.scalar.numeric"><a href="#sec.type.scalar.numeric" class="anchor">Numeric Scalars</a></h3>
<h4 id="sec.type.scalar.numeric.int"><a href="#sec.type.scalar.numeric.int" class="anchor">Integers</a></h4>
<p>The <dfn>integer types</dfn> are:</p>
<p><table>
<tr><th>Type</th><th>Kind</th></tr></p>
<p><tr><td><code>Int8</code></td>  <td>8-bit signed integer type</td></tr>
<tr><td><code>Int16</code></td><td>16-bit signed integer type</td></tr>
<tr><td><code>Int32</code></td><td>32-bit signed integer type</td></tr>
<tr><td><dfn><code>Int64</code></dfn></td><td>64-bit signed integer type</td></tr></p>
<p><tr><td><code>UInt8</code></td>  <td>8-bit unsigned integer type</td></tr>
<tr><td><code>UInt16</code></td><td>16-bit unsigned integer type</td></tr>
<tr><td><code>UInt32</code></td><td>32-bit unsigned integer type</td></tr>
<tr><td><code>UInt64</code></td><td>64-bit unsigned integer type</td></tr></p>
<p></table></p>
<p>An <a>integer type</a> is either signed or unsigned.
An integer type has a bit width.</p>
<p>Signed integer types use two's complement representation.
Arithmetic operations on values of integer type (both signed and unsigned) wrap on overflow/underflow.</p>
<p>The name <code>Int</code> is an alias for the type <code>Int32</code>.
The name <code>UInt</code> is an alias for the type <code>UInt32</code>.</p>
<h4 id="sec.type.scalar.numeric.float"><a href="#sec.type.scalar.numeric.float" class="anchor">Floating-Point Numbers</a></h4>
<p>The <dfn>floating-point types</dfn> are:</p>
<p><table>
<tr><th>Type</th><th>Kind</th><th>IEEE 754 Format</tr></p>
<p><tr><td><code>Float16</code></td><td>16-bit floating-point type</td><td><code>binary16</code></td></tr>
<tr><td><code>Float32</code></td><td>32-bit floating-point type</td><td><code>binary16</code></td></tr>
<tr><td><code>Float64</code></td><td>64-bit floating-point type</td><td><code>binary16</code></td></tr>
</table></p>
<p>All <a>floating-point types</a> are signed.
A floating-point type has a bit width.</p>
<p>A <a>floating-point type</a> has a corresponding IEEE 754 format.
The instances of a floating-point type are all the values of its IEEE 754 format.</p>
<p>The name <code>Float</code> is an alias for the <code>Float32</code> type.</p>
<h3 id="sec.type.scalar.unicode"><a href="#sec.type.scalar.unicode" class="anchor">Unicode Scalar Values</a></h3>
<p>A <dfn>unicode scalar</dfn> is defined by the Unicode specification.</p>
<p><div class="note">
A unicode scalar is a Unicode code point that is not a surrogate code point.
</div></p>
<h2 id="sec.type.sequence.finite"><a href="#sec.type.sequence.finite" class="anchor">Finite Sequences</a></h2>
<p>The <dfn>element count</dfn> of a finite sequence is the number of elements in it.</p>
<p>The <dfn>element type</dfn> of a homogeneous sequence is the type of elements in it.</p>
<p>The <a>level</a> of a sequence is the level of its <a>element type</a>.</p>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Sequence</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>{</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">Value</span> <code>,</code></span></span>)</span>* <code>}</code></span></span></div>
</pre>
</div>
<h2 id="sec.type.array"><a href="#sec.type.array" class="anchor">Array Types</a></h2>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ArrayType</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="introducer grammar"><span class="meta">elementType</span>:<span class="meta">Type</span></span> <code>[</code> <span class="introducer grammar"><span class="meta">elementCount</span>:<span class="meta">Int</span></span> <code>]</code></span></span></div>
</pre>
</div>
<p>An <dfn>array</dfn> is a finite homogenous sequence.
An <dfn>array type</dfn> <code><a><var class="meta">T</var></a>[<a><var class="meta">N</var></a>]</code> is the type of <a><var class="meta">N</var></a>-element <a>arrays</a> with elements of type <a><var class="meta">T</var></a>.</p>
<p>The <a>element count</a> of an <a>array type</a> must be a non-negative <code>Int</code>.</p>
<h2 id="sec.type.vector"><a href="#sec.type.vector" class="anchor">Vectors</a></h2>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">VectorType</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>Vector</code> <code><</code> <span class="introducer grammar"><span class="meta">elementType</span>:<span class="meta">Type</span></span> <code>,</code> <span class="introducer grammar"><span class="meta">elementCount</span>:<span class="meta">Int</span></span> <code>></code></span></span></div>
</pre>
</div>
<p>A <dfn>vector</dfn> is a finite homogenous sequence.
The <a>element type</a> of a vector must be a scalar numeric type.</p>
<p>A <dfn>vector type</dfn> <code>Vector<<a><var class="meta">T</var></a>,<a><var class="meta">N</var></a>></code> is the type of <a>vectors</a> with <a><var class="meta">N</var></a> elements of type <a><var class="meta">T</var></a>.</p>
<p>The <a>element count</a> of a <a>vector type</a> must be a non-negative <code>Int</code>.</p>
<h2 id="sec.type.matrix"><a href="#sec.type.matrix" class="anchor">Matrices</a></h2>
<p>A <dfn>matrix</dfn> is a finite homogenous sequence.
The <a>element type</a> of a <a>matrix</a> must be a <a>vector type</a>.</p>
<p>The <dfn>rows</dfn> of a matrix are its elements.
The <dfn>row type</dfn> of a matrix is its <a>element type</a>.
The <dfn>row count</dfn> of a matrix is its <a>element count</a>.</p>
<p>The <dfn>scalar type</dfn> of a matrix is the <a>element type</a> of its <a>element type</a>.</p>
<p>The <dfn>column count</dfn> of a matrix is the <a>element count</a> of its <a>row type</a>.
The <dfn>column type</dfn> of a matrix with <a>scalar type</a> <a><var class="meta">T</var></a> and <a>column count</a> <a><var class="meta">C</var></a> is <code>Vec<</code>T<code>,<a><var class="meta">C</var></a>></code></p>
<p>A <dfn>matrix type</dfn> <code>Matrix<<a><var class="meta">T</var></a>,<a><var class="meta">R</var></a>,<a><var class="meta">C</var></a>></code> is the type of matrices with <a><var class="meta">R</var></a> <a>rows</a> of type <code>Vector<<a><var class="meta">C</var></a>,<a><var class="meta">T</var></a>></code>.</p>
<h2 id="sec.type.never"><a href="#sec.type.never" class="anchor">The <code>Never</code>Type</a></h2>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">NeverType</span></dfn>
⇒ <span class="alternative grammar"><code>Never</code></span></div>
</pre>
</div>
<p>The type <code>Never</code> has no instances.</p>
<h2 id="sec.decl.ref"><a href="#sec.decl.ref" class="anchor">Declaration References</a></h2>
<p>A <dfn>declaration reference</dfn> is a <a>value</a> that refers to some <a>declaration</a>.</p>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">DeclarationReference</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">DirectDeclarationReference</span></span>
⇒ <span class="alternative grammar"><span class="meta">MemberDeclarationReference</span></span>
⇒ <span class="alternative grammar"><span class="meta">SpecializedDeclarationReference</span></span></div>
</pre>
</div>
<h3 id="sec.decl.ref.direct"><a href="#sec.decl.ref.direct" class="anchor">Direct Declaration References</a></h3>
<p>A <a>declaration</a> serves as a <dfn>direct declaration reference</dfn> to itself.</p>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">DirectDeclarationReference</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Declaration</span></span></div>
</pre>
</div>
<h3 id="sec.decl.ref.member"><a href="#sec.decl.ref.member" class="anchor">Member Declaration Reference</a></h3>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">MemberDeclarationReference</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="introducer grammar"><span class="meta">base</span>:<span class="meta">DeclarationReference</span></span> <code>::</code> <span class="introducer grammar"><span class="meta">member</span>:<span class="meta">Declaration</span></span></span></span></div>
</pre>
</div>
<p>A <dfn>member declaration reference</dfn> refers to some <a>member</a> <a>declaration</a> of a base <a>declaration reference</a>.
A <a>member declaration reference</a> must satisfy the following constraints:</p>
<ul><li><p>The <a>base</a> must refer to a declaration with members (TODO: make this precise)</p>
</li>
<li><p>The <a>member</a> must be a direct member declaration of the <a>base</a></p>
</li>
</ul>
<h3 id="sec.decl.ref.specialize"><a href="#sec.decl.ref.specialize" class="anchor">Specialized Declaration Reference</a></h3>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">SpecializedDeclarationReference</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="introducer grammar"><span class="meta">base</span>:<span class="meta">Value</span></span> <code><</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="introducer grammar"><span class="meta">arguments</span>:<span class="meta">Value</span></span> <code>,</code></span></span>)</span>* <code>></code></span></span></div>
</pre>
</div>
<p>A <dfn>specialized declaration reference</dfn> refers to a specialization of some generic declaration.
A <a>specialized declaration reference</a> must satisfy the following constraints:</p>
<ul><li><p>The <a>base</a> must refer to a generic declaration</p>
</li>
<li><p>The <a>base</a> must not be a <a>specialized declaration reference</a></p>
</li>
<li><p>The number of <a>arguments</a> must match the number of parameters of <a>base</a></p>
</li>
<li><p>Each of the <a>arguments</a> must be an instance of the type of the corresponding parameter of <a>base</a></p>
</li>
</ul>
<h3 id="sec.decl.ref.specialized.fully"><a href="#sec.decl.ref.specialized.fully" class="anchor">Fully-Specialized Declaration References</a></h3>
<p>A <a>declaration reference</a> <a><var class="meta">r</var></a> is <dfn>unspecialized</dfn> if <a><var class="meta">r</var></a> refers to a generic declaration and <a><var class="meta">r</var></a> is not a <a>specialized declaration reference</a>.</p>
<p>A <a>declaration reference</a> <a><var class="meta">r</var></a> is <dfn>fully specialized</dfn> if all of:</p>
<ul><li><p><a><var class="meta">r</var></a> is <a>unspecialized</a></p>
</li>
<li><p>if <a><var class="meta">r</var></a> has a base <a>declaration reference</a>, then its base is <a>fully specialized</a></p>
</li>
</ul>
<p><div class="issue">
We need to do some work to define what a fully-qualified declaration reference is, since some parts of the semantics want it.</p>
<p>A direct declaration reference is fully qualified if it is to a module, a parameter (generic or value), or a local declaration.</p>
<p>A member declaration reference is fully qualified if its base is.
A specialization is fully qualified if its base is.
</div></p>
<h2 id="sec.type.nominal"><a href="#sec.type.nominal" class="anchor">Nominal Types</a></h2>
<p>A <dfn>nominal type</dfn> is a fully-specialized declaration reference to a <a>type declaration</a>.</p>
<h2 id="sec.type.struct"><a href="#sec.type.struct" class="anchor"><code>struct</code>Types</a></h2>
<p>A <dfn>struct type</dfn> is a fully-specialized declaration reference to a <code>struct</code> declaration.</p>
<p>A <a>struct type</a> is a <a>proper type</a>.</p>
<h2 id="sec.type.class"><a href="#sec.type.class" class="anchor"><code>class</code>Types</a></h2>
<p>A <dfn>class type</dfn> is a fully-specialized declaration reference to a <code>class</code> declaration.</p>
<p>An instance of a <a>class type</a> is an <dfn>object</dfn>.</p>
<p>A <a>class type</a> is a <a>proper type</a>.</p>
<h2 id="sec.type.enum"><a href="#sec.type.enum" class="anchor"><code>enum</code>Types</a></h2>
<p>An <dfn>enum type</dfn> is a fully-specialized declaration reference to an <code>enum</code> declaration.</p>
<p>An <a>enum type</a> is a <a>proper type</a>.</p>
<h2 id="sec.type.alias"><a href="#sec.type.alias" class="anchor">Type Aliases</a></h2>
<p>A <dfn>type alias</dfn> is a fully-specialized declaration reference to an <code>typealias</code> declaration.</p>
<p>A <a>type alias</a> is a <a>proper type</a>.</p>
<h2 id="sec.type.assoc"><a href="#sec.type.assoc" class="anchor">Associated Types</a></h2>
<p>An <dfn>associated type</dfn> is a fully-specialized declaration reference to an <code>associatedtype</code> declaration.</p>
<p>An <a>associated type</a> is a <a>proper type</a>.</p>
<h2 id="sec.type.interface"><a href="#sec.type.interface" class="anchor">Interfaces</a></h2>
<p>An <dfn>interface</dfn> is a value that is either:</p>
<ul><li><p>a fully-specialized declaration reference to an <code>interface</code> declaration</p>
</li>
<li><p>a conjunction of interfaces</p>
</li>
</ul>
<p>The <a>instances</a> of an interface are the <a>proper types</a> that conform to it.</p>
<p>An <a>interface</a> has level two.</p>
<p>The <a>sort</a> <code>Interface</code> is the <a>sort</a> of all <a>interfaces</a>.</p>
<h2 id="sec.type.any"><a href="#sec.type.any" class="anchor"><code>any</code>Types</a></h2>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ExistentialAnyType</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>any</code> <span class="meta">Interface</span></span></span></div>
</pre>
</div>
<p>An <dfn>any type</dfn> takes the form <code>any <a><var class="meta">I</var></a></code>, where <a><var class="meta">I</var></a> is an <a>interface</a>.</p>
<p>The <a>level</a> of an <a>any type</a> is one.</p>
<p>An instance of <code>any <a><var class="meta">I</var></a></code> is an <dfn>existential value</dfn>.</p>
<ul><li><p>a <a>type</a> <a><var class="meta">T</var></a></p>
</li>
<li><p>a witness that <a><var class="meta">T</var></a> conforms to <a><var class="meta">I</var></a></p>
</li>
<li><p>a <a>value</a> of type <a><var class="meta">T</var></a></p>
</li>
</ul>
<p>The <a>level</a> of an existential value is zero.</p>
<h2 id="sec.type.function"><a href="#sec.type.function" class="anchor">Functions</a></h2>
<p>A <dfn>function</dfn> is a value that can be called.</p>
<p>A function is called with zero or more values as <dfn>arguments</dfn>.
The <a>arguments</a> to a function call must match the function's <dfn>parameters</dfn></p>
<p>If a call to a function returns normally, it returns a value of the function's <dfn>result type</dfn>.</p>
<p>A call to a function may have additional <dfn>effects</dfn>.</p>
<p>A <dfn>function type</dfn> takes the form:</p>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">FunctionType</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>(</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">Parameter</span> <code>,</code></span></span>)</span>* <code>)</code> <span class="grammar"><span class="meta">Effect</span></span>* <code>-></code> <span class="introducer grammar"><span class="meta">resultType</span>:<span class="meta">Type</span></span></span></span></div>
<div class="grammar production"><dfn><span class="meta">Parameter</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">Name</span> <code>:</code></span></span>)</span>? <span class="meta">Type</span></span></span></div>
</pre>
</div>
<p><code>( <a><var class="meta">parameters</var></a> ) <a><var class="meta">effects</var></a> -> <a><var class="meta">resultType</var></a></code></p>
<p>where:</p>
<ul><li><p><a><var class="meta">parameters</var></a> is a comma-separated sequence of zero or more <a>parameters</a></p>
</li>
<li><p><a><var class="meta">effects</var></a> is zero or more <a>effects</a></p>
</li>
<li><p><a><var class="meta">resultType</var></a> is a <a>type</a></p>
</li>
</ul>
<p>Each of the <a><var class="meta">parameters</var></a> of a function type may either be a <a>type</a> or of the form <a>name</a><code>:</code><a>type</a>.</p>
<p>A fully-specialized declaration reference to a function declaration is a <a>function</a>.</p>
<p>The level of a function is the maximum of the levels of its parameter types and result types.</p>
<h2 id="sec.type.generic"><a href="#sec.type.generic" class="anchor">Generics</a></h2>
<p>A <dfn>generic</dfn> is a value that can be specialized.</p>
<p>A generic is specialized with one or more values as <a>arguments</a>.
The <a>arguments</a> to a specialization must match the generic's <a>parameters</a>.</p>
<p>A <dfn>dependent function type</dfn> takes the form:</p>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">DependentFunctionType</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code><</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">Parameter</span> <code>,</code></span></span>)</span>* <code>></code> <code>-></code> <span class="introducer grammar"><span class="meta">resultType</span>:<span class="meta">Type</span></span></span></span></div>
</pre>
</div>
<p><code>< <a><var class="meta">parameters</var></a> > -> <a><var class="meta">resultType</var></a></code></p>
<p>where:</p>
<ul><li><p><a><var class="meta">parameters</var></a> is a comma-separated sequence of zero or more parameters</p>
</li>
<li><p><a><var class="meta">resultType</var></a> is a type</p>
</li>
</ul>
<p>The <a><var class="meta">parameters</var></a> of a generic type may either be a type or of the form <a>name</a><code>:</code><a>type</a>.</p>
<p>The result type of a generic type may refer to the parameters.</p>
<p>An unspecialized declaration reference to a generic declaration is a <a>generic</a>.</p>
<p>The level of a generic is the maximum of the level of its result type and one greater than the maximul of the levels of its parameter types.</p>
<h2 id="sec.type.witness"><a href="#sec.type.witness" class="anchor">Witnesses</a></h2>
<p>A <dfn>proposition</dfn> is a phrase that logically may be either true or false.</p>
<p><a>Propositions</a> are <a>types</a>.
A <dfn>witness</dfn> is an instance of a <a>proposition</a>.
The existance of a <a>witness</a> of some <a>proposition</a> <a><var class="meta">P</var></a> demonstrates the truth of <a><var class="meta">P</var></a>.</p>
<p>The notation "a <a>witness</a> that <a><var class="meta">P</var></a>", where <a><var class="meta">P</var></a> is a proposition, is equivalent to "an <a>instance</a> of <a><var class="meta">P</var></a>".</p>
<p>The notation <code><a><var class="meta">T</var></a> extends <a><var class="meta">S</var></a></code> denotes a <a>proposition</a> that the <a>type</a> <a><var class="meta">T</var></a> is a subtype of the <a>type</a> <a><var class="meta">S</var></a>.</p>
<p>The notation <code><a><var class="meta">T</var></a> implements <a><var class="meta">I</var></a></code> denotes a <a>proposition</a> that the <a>type</a> <a><var class="meta">T</var></a> conforms to the <a>interface</a> <a><var class="meta">I</var></a>.</p>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Proposition</span></dfn>
⇒ <span class="alternative grammar"><span class="block-comment grammar">/* TODO */</span></span></div>
<div class="grammar production"><dfn><span class="meta">SubtypeProposition</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="introducer grammar"><span class="meta">subtype</span>:<span class="meta">Type</span></span> <code>extends</code> <span class="introducer grammar"><span class="meta">supertype</span>:<span class="meta">Type</span></span></span></span></div>
<div class="grammar production"><dfn><span class="meta">ImplementationProposition</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Type</span> <code>implements</code> <span class="meta">Interface</span></span></span></div>
</pre>
</div>
<p><div class="issue">
A witness that <a>t</a> <code>implements</code> <a>i</a> is a witness table.</p>
<p>Given:</p>
<ul><li><p>an interface <a>i</a></p>
</li>
<li><p>a requirement of <a>i</a>, represented as a direct member declaration of <a>r</a></p>
</li>
<li><p>a type <a>t</a></p>
</li>
<li><p>a witness table <a>w</a>, of type <a>t</a> <code>implements</code> <a>i</a></p>
</li>
</ul>
<p>then looking up the witness value for <a>r</a> should basically amount to a (static) member reference into <a>w</a>.</p>
<p>This would all be easier if Slang followed the approach of something like Haskell, where the <code>This</code> parameter is basically explicit.</p>
<p>Basically this amounts to saying that <a>t</a> <code>implements</code> <a>i</a> acts as a declaration reference to <a>i</a>, and that a declaration reference to an <code>interface</code> is not "fully specialized" (in the sense that members can be looked up) without that added parameter.</p>
<p>(<a>t</a> <code>implements</code> <a>i</a>)::<a>r</a></p>
<p>So... I need to do that.
</div></p>
<h2 id="sec.value.module"><a href="#sec.value.module" class="anchor">Module Values</a></h2>
<p>A <a>module</a> is a <a>value</a>.</p>
<h2 id="sec.type.text"><a href="#sec.type.text" class="anchor">Text</a></h2>
<h3 id="sec.type.text.char"><a href="#sec.type.text.char" class="anchor">Characters</a></h3>
<p>A <dfn>character</dfn> is an ordered sequence of one or more unicode scalar values, matching the definition of a Unicode extended grapheme cluster.</p>
<h3 id="sec.type.text.string"><a href="#sec.type.text.string" class="anchor">Strings</a></h3>
<p>A <dfn>string</dfn> is an ordered sequence of zero or unicode scalar values.</p>
<div class="issue callout">Issue: This text should eventually clarify how to decompose a string into a sequence of characters.</div>
<h1 id="sec.check"><a href="#sec.check" class="anchor">Semantic Checking</a></h1>
<div class="issue callout"><h6>Issue</h6>
<p>The intention of this chapter is to establish the formalisms and notations that will be used for expressing typing judgements and other semantic-checking rules in this specification.</p>
<p>The notation being used here is aligned with how papers in the PLT world on type theory, semantics, etc. present a language.</p>
</div>
<h2 id="sec.check.context"><a href="#sec.check.context" class="anchor">Contexts</a></h2>
<p>A <dfn>context</dfn> is an ordered sequence of zero or more <dfn>context entries</dfn>.
<a>Context entries</a> include <dfn>bindings</dfn> of the name of a variable (an <a>identifier</a>) to its type.</p>
<pre><code class="language-.checking">
    Context :
        ContextEntry*
    
    ContextEntry :
        Binding
    
    Binding :
        Identifier : Type // variable
        Identifer = TypedValue // alias
</code></pre>
<p>A context <a><var class="meta">c</var></a> <dfn>binds</dfn> an identifier <a><var class="meta">n</var></a> if <a><var class="meta">c</var></a> contains one or more <a>bindings</a> with <a><var class="meta">n</var></a> on the left-hand side.</p>
<div class="issue callout">Issue: We need to describe here the process by which an identifier resolves to a <a>binding</a>, including overloaded, etc.
The discussion here will have to be a forward reference to the algorithms to be given later.</div>
<h2 id="sec.check.expr"><a href="#sec.check.expr" class="anchor">Expressions</a></h2>
<p>Slang use a variation on a bidirectional type-checking algorithm.</p>
<p>There are two main steps used when checking expressions.
Each form of expression may define rules for synthesis, checking, or both.</p>
<div class="issue callout"><h6>Issue</h6>
<p>A parsed expression is what you get out of the relevant parsing rules for <code>Expression</code>.</p>
<p>A checked expression is a limited subset of forms that includes stuff like:</p>
<ul><li><p>typed values</p>
</li>
<li><p>declaration references</p>
</li>
<li><p>calls</p>
</li>
</ul>
<p>A typed value evaluates to itself, with no side effects.</p>
<p>A resolved expression is either a checked expression <a>or</a> one of a few cases that need further context:</p>
<ul><li><p>overloaded declaration references</p>
</li>
<li><p>overloaded calls</p>
</li>
<li><p>initializer lists</p>
</li>
</ul>
<p>We also need to drill into the representation of types and values...</p>
</div>
<div class="semantics grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">CheckedExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">TypedValue</span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">CheckedExpression</span> <code>(</code> <span class="grammar"><span class="meta">CheckedExpression</span></span>* <code>)</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">IntermediateExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">CheckedExpression</span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>OverloadSet</code> <span class="grammar"><span class="meta">CheckedExpression</span></span>*</span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>InitializerList</code> <span class="grammar"><span class="meta">IntermediateExpression</span></span>*</span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>OverloadedCall</code> <span class="meta">IntermediateExpression</span> <code>(</code> <span class="grammar"><span class="meta">IntermediateExpression</span></span>* <code>)</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">Expression</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">ParsedExpression</span></span>
⇒ <span class="alternative grammar"><span class="meta">IntermediateExpression</span></span></div>
</pre>
</div>
<h3 id="sec.check.expr.synth"><a href="#sec.check.expr.synth" class="anchor">Synthesis</a></h3>
<p><dfn>Synthesizing</dfn> an <a>expression</a> in a <a>context</a> may yield some <a>intermediate expression</a>.</p>
<div class="note callout">Note: Synthesis is used in places where an expression needs to have some amount of validation performed, but an expected type for the expression is not available.</div>
<p>To <a>synthesize</a> an <a>expression</a> <a><var class="meta">e</var></a> in context <a><var class="meta">c</var></a>, when the syntactic form of <a><var class="meta">e</var></a> does not have an explicit synthesis rule that applies:</p>
<ul><li><p>Extend <a><var class="meta">c</var></a> with a fresh type variable <a><var class="meta">t</var></a></p>
</li>
<li><p>Return the result of checking <a><var class="meta">e</var></a> against <a><var class="meta">t</var></a> in <a><var class="meta">c</var></a></p>
</li>
</ul>
<h3 id="sec.check.check"><a href="#sec.check.check" class="anchor">Checking</a></h3>
<p><dfn>Checking</dfn> an <a>expression</a> against a <a>type</a> in a <a>context</a> may yield a <a>checked expression</a>.</p>
<div class="note callout">Note: Checking is used in places where the type that an expression is expected to have is known.</div>
<p>To check an <a>expression</a> <a><var class="meta">e</var></a> against a type <a><var class="meta">T</var></a> when form of <a><var class="meta">e</var></a> does not define a checking rule:</p>
<ul><li><p>Let <a><var class="meta">se</var></a> be the result of synthesizing <a><var class="meta">e</var></a></p>
</li>
<li><p>Return the result of implicitly coercing <a><var class="meta">se</var></a> to a <a><var class="meta">T</var></a></p>
</li>
</ul>
<h2 id="sec.check.type"><a href="#sec.check.type" class="anchor">Type Expressions</a></h2>
<p><a>Type expressions</a> are syntactically a subset of <a>expressions</a>.</p>
<p>To check an expression <a><var class="meta">e</var></a> <dfn>as a type</dfn>, check it against the type <code>TYPE</code>.</p>
<h2 id="sec.check.stmt"><a href="#sec.check.stmt" class="anchor">Statements</a></h2>
<p>Statement also use <a>checking judgements</a>.
A checking judgement for a statement determines that <a>statement</a> <a><var class="meta">s</var></a> <dfn>checks</dfn> in <a>context</a> <a><var class="meta">c</var></a>.</p>
<h2 id="sec.check.decl"><a href="#sec.check.decl" class="anchor">Declarations</a></h2>
<p>Declarations also use <a>checking judgements</a>.
A checking judgement for a declaration determines that <a>declaration</a> <a><var class="meta">d</var></a> <a>checks</a> in <a>context</a> <a><var class="meta">c</var></a>.</p>
<p>Checking of a declaration may modify the context <a><var class="meta">c</var></a> to include additional bindings.</p>
<h1 id="sec.sec.module"><a href="#sec.sec.module" class="anchor">Modules</a></h1>
<p>A <dfn>module</dfn> is a unit of encapsulation for declarations.</p>
<h2 id="sec.module.source.primary"><a href="#sec.module.source.primary" class="anchor">Primary Source Unit</a></h2>
<p>One or more <a>source units</a> may be compiled together to form a module.
Compilation of a module begins with a single <a>source unit</a> that is the <dfn>primary source unit</dfn> of the module.
An implementation <a>should</a> use the <a>primary source unit</a> as a means to identify a module when resolving references from one module to another.</p>
<p>A <a>primary source unit</a> may start with a <dfn>module declaration</dfn>, which specifies the name of the module:</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ModuleDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>module</code> <span class="meta">Identifier</span> <code>;</code></span></span></div>
</pre>
</div>
<p>If a <a>primary source unit</a> does not start with a <a>module declaration</a>, the module comprises only a single source unit, and the name of the module must be determined by some implementation-specified method.
A <a>primary source unit</a> without a <a>module declaration</a> must not contain any <code>include</code> declarations.</p>
<div class="note callout">Note: An implementation might derive a default module name from a file name/path, command-line arguments, build configuration files, etc.</div>
<div class="note callout">Note: A module might be defined in a single source unit, but have code spread across multiple files.
For example, <code>#include</code> directives might be used so that the content of a single <a>source unit</a> comes from multiple files.</div>
<p>A <a>module declaration</a> must always be the first declaration in its <a>source unit</a>.
A <a>module declaration</a> must not appear in any <a>source unit</a> that is not a primary <a>source unit</a>.</p>
<h2 id="sec.module.source.secondary"><a href="#sec.module.source.secondary" class="anchor">Seconary Source Units</a></h2>
<p>Any <a>source units</a> in a module other than the <a>primary source unit</a> are <dfn>secondary source units</dfn>.</p>
<h3 id="sec.module.include"><a href="#sec.module.include" class="anchor">Include Declarations</a></h3>
<p>Secondary <a>source units</a> are included into a module via <dfn>include declarations</dfn>.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">IncludeDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>include</code> <span class="introducer grammar"><span class="meta">path</span>:<span class="meta">PathSpecifier</span></span> <code>;</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">PathSpecifier</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">PathElement</span> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><code>.</code> <span class="meta">PathElement</span></span></span>)</span>*</span></span></div>
<div class="grammar production"><dfn><span class="meta">PathElement</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Identifier</span></span>
⇒ <span class="alternative grammar"><span class="meta">StringLiteral</span></span></div>
</pre>
</div>
<p>An implementation must use the <a><var class="meta">path</var></a> given in an <a>include declaration</a> to identify a <a>source unit</a> via implementation-specified means.
It is an error if <a>source unit</a> matching the given name cannot be identified.</p>
<p><div class=note>
Include declarations are distinct from preprocessor <code>#include</code> directives.</p>
<p>Each <a>source unit</a> in a module is preprocessed independently, and the preprocessor state at the point where an <code>include</code> declaration appears does not have any impact on how the <a>source unit</a> identified by that include declaration will be preprocessed.
</div></p>
<p>A <a>module</a> comprises the transitive closure of <a>source units</a> referred to via <a>include declarations</a>.
An implementation must use an implementation-specified means to determine if multiple <a>include declarations</a> refer to the same <a>source unit</a> or not.</p>
<div class="note callout">Note: Circular, and even self-referential, <code>include</code> declarations are allowed.</div>
<h3 id="sec.module.implementing"><a href="#sec.module.implementing" class="anchor">Implementing Declarations</a></h3>
<p>Secondary <a>source units</a> must start with an <dfn>implementing declaration</dfn>, naming the module that the <a>secondary source unit</a> is part of:</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ImplementingDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>implementing</code> <span class="meta">PathSpecifier</span> <code>;</code></span></span></div>
</pre>
</div>
<div class="note callout">Note: It is an error if the name on an <a>implementing declaration</a> in a <a>secondary source unit</a> does not match the name on the <a>module declaration</a> of the corresponding primary <a>source unit</a>.</div>
<div class="note callout">Note: <a>implementing declaration</a>s ensure that given a source unit, a tool can always identify the module that the <a>source unit</a> is part of (which can in turn be used to identify all of the <a>source units</a> in the module via its <code>include</code> declarations).</div>
<p>An <a>implementing declaration</a> must always be the first declaration in its <a>source unit</a>.
An <a>implementing declaration</a> must not appear in any <a>source unit</a> that is not a secondary <a>source unit</a>.</p>
<h2 id="sec.module.import"><a href="#sec.module.import" class="anchor">Import Declarations</a></h2>
<p>Modules may depend on one another via <code>import</code> declarations.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ImportDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>import</code> <span class="meta">PathSpecifier</span> <code>;</code></span></span></div>
</pre>
</div>
<p>An <code>import</code> declaration names a module, and makes the public declarations in the named module visible to the current <a>source unit</a>.</p>
<div class="note callout">Note: An <code>import</code> declaration only applies to the scope of the current source unit, and does not import the chosen module so that it is visible to other <a>source units</a> of the current module.</div>
<p>Implementations must use an implementation-specified method to resolve the name given in an <code>import</code> declaration to a module.
Implementations may resolve an <code>import</code> declaration to a previously compiled module.
Implementations may resolve an <code>import</code> declaration to a source unit, and then attempt to compile a module using that <a>source unit</a> as its primary <a>source unit</a>.
If an implementation fails to resolve the name given in an <code>import</code> declaration, it must diagnose an error.
If an implementation diagnoses erros when compiling a soure unit named via an <code>import</code> declaration fails, it must diagnose an error.</p>
<p><div class=note>
The current Slang implementation searches for a module by translating the specified module name into a file path by:</p>
<ul><li><p>Replacing any dot (<code>.</code>) separators in a compound name with path separators (e.g., <code>/</code>)</p>
</li>
<li><p>Replacing any underscores (<code>_</code>) in the name with hyphens (<code>-</code>)</p>
</li>
<li><p>Appending the extension <code>.slang</code></p>
</li>
</ul>
<p>The implementation then looks for a file matching this path on any of its configured search paths.
If such a file is found it is loaded as a module comprising a single <a>source unit</a>.
</div></p>
<h1 id="sec.decl"><a href="#sec.decl" class="anchor">Declarations</a></h1>
<p>A <dfn>declaration</dfn> is a unit of syntax that typically affects what names are visibile in a scope, and how those names are interpreted.
In the abstract syntax, a <a>source unit</a> comprises a sequence of declarations.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">SourceUnit</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="grammar">(<span class="grammar"><span class="grammar"><span class="meta">ModuleDeclaration</span> | <span class="meta">ImplementingDeclaration</span></span></span>)</span>? <span class="grammar"><span class="meta">IncludeDeclaration</span></span>* <span class="grammar"><span class="meta">ImportDeclaration</span></span>* <span class="grammar">(<span class="grammar"><span class="meta">Declaration</span></span>)</span>*</span></span></div>
</pre>
</div>
<p>A declaration may be preceded by zero or more modifiers.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Declaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Modifier</span> <span class="meta">Declaration</span></span></span>
⇒ <span class="alternative grammar"><span class="meta">VariableDeclaration</span></span>
⇒ <span class="alternative grammar"><span class="meta">FunctionDeclaration</span></span>
⇒ <span class="alternative grammar"><span class="meta">TypeDeclaration</span></span></div>
</pre>
</div>
<p>A <dfn>binding</dfn> is an association of an identifier with a specific entity, such as a declaration.
A <dfn>scope</dfn> is a set of bindings.</p>
<div class="note callout">Note: A <a>scope</a> can include more than one binding for the same identifier.</div>
<p>An <dfn>environment</dfn> is either the unique <dfn>empty environment</dfn>, or it comprises a scope that is the <dfn>local scope</dfn> of that environment, and a <dfn>parent environment</dfn>.</p>
<div class="note callout">Note: No Slang code is ever parsed or checked in the <a>empty environment</a>.
Many checking rules are expected to introduce new <a>local scopes</a>, which will use the current environment as the <a>parent environment</a>.</div>
<p>For each production in the abtract syntax, there is a <dfn>input environment</dfn> in effect at the start of that production, and an <dfn>output environment</dfn> in effect after that production.
Each production determines the <a>input environment</a> used by its sub-terms.
When the description of a production does not say otherwise:</p>
<ul><li><p>The input environment of a production's first sub-term is the input environment of that production.</p>
</li>
<li><p>The input environment of each sub-term other than the first is the output environment of the preceding sub-term.</p>
</li>
<li><p>The <a>output environment</a> of the entire production is the output environment of its last sub-term.</p>
</li>
</ul>
<p>The output environment of a token is its input environment.
The output environment of an empty production is its input <a>environment</a>.</p>
<p>When we say that a declaration <dfn>introduces</dfn> a binding, we mean that its output environment is the output environment of its last sub-term extended with that binding.</p>
<h2 id="sec.decl.shared"><a href="#sec.decl.shared" class="anchor">Shared Concepts</a></h2>
<div class="issue callout">Issue: We need to define concepts that are used by traditional-style declarations, including <dfn>type specifiers</dfn>.</div>
<h3 id="sec.decl.body"><a href="#sec.decl.body" class="anchor">Bodies</a></h3>
<div class="issue callout">Issue: We need to define that there are two kinds of bodies: <dfn>declaration bodies</dfn> and <a><var class="meta">statement bodies</var></a>.</div>
<h3 id="sec.decl.base"><a href="#sec.decl.base" class="anchor">Bases</a></h3>
<h3 id="sec.decl.param"><a href="#sec.decl.param" class="anchor">Parameters</a></h3>
<p>A parameters clause defines a sequence of <dfn>parameter declarations</dfn>.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ParametersClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>(</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">ParameterDeclaration</span> <code>,</code></span></span>)</span>* <code>)</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">ParameterDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Identifier</span> <code>:</code> <span class="grammar"><span class="meta">Direction</span></span>?</span></span></div>
<div class="grammar production"><dfn><span class="meta">TypeExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="grammar"><span class="meta">DefaultValueClause</span></span>?</span></div>
<div class="grammar production"><dfn><span class="meta">DefaultValueClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>=</code> <span class="meta">Expression</span></span></span></div>
</pre>
</div>
<p>A <a>parameter declaration</a> must include a type expression; the type of the parameter is the result of evaluating that type expression.</p>
<p>A parameter declaration may include a default-value clause; it it does, the default value for that parameter is the result of evaluating the expression in that clause with an expected type that is the type of the parameter.</p>
<h4 id="sec.dir"><a href="#sec.dir" class="anchor">Directions</a></h4>
<p>Every parameter has a <dfn>direction</dfn>, which determines how an argument provided at a call site is connected to that parameter.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Direction</span></dfn>
⇒ <span class="alternative grammar"><code>in</code></span>
⇒ <span class="alternative grammar"><code>out</code></span>
⇒ <span class="alternative grammar"><code>take</code></span>
⇒ <span class="alternative grammar"><code>borrow</code></span>
⇒ <span class="alternative grammar"><code>inout</code></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>in</code> <code>out</code></span></span>
⇒ <span class="alternative grammar"><code>ref</code></span></div>
</pre>
</div>
<p>If a parameter declaration includes a <a>direction</a>, then that determines the direction of the parameter; otherwise the direction of the parameter is <code>in</code>.</p>
<h5 id="sec.dir.in"><a href="#sec.dir.in" class="anchor"><code>in</code></a></h5>
<p>The <code>in</code> direction indicates typical pass-by-value (copy-in) semantics.
The parameter in the callee binds to a copy of the argument value passed by the caller.</p>
<h5 id="sec.out"><a href="#sec.out" class="anchor"><code>out</code></a></h5>
<p>The <code>out</code> direction indicates copy-out semantics.
The parameter in the callee binds to a fresh storage location that is uninitialized on entry.
When the callee returns, the value in that location is moved to the storage location referenced by the argument.</p>
<h5 id="sec.take"><a href="#sec.take" class="anchor"><code>take</code></a></h5>
<p>The <code>take</code> direction indicates move-in semantics.
The argument provided by the caller is moved into the parameter of the callee, ending the lifetime of the argument.</p>
<h5 id="sec.borrow"><a href="#sec.borrow" class="anchor"><code>borrow</code></a></h5>
<p>The <code>borrow</code> direction indicates immutable borrow semantics.</p>
<p>If the parameter has a noncopyable type, then the parameter in the callee binds to the storage location referenced by the argument.</p>
<p>If the parameter has a copyable type, then the parameter in the callee may, at the discretion of the implementation, bind to either the storage location referenced by the argument, or a copy of the argument value.</p>
<h5 id="sec.inout"><a href="#sec.inout" class="anchor"><code>inout</code></a></h5>
<p>The <code>inout</code> direction indicates exclusive mutable borrow semantics.
The syntax <code>in out</code> is equivalent to <code>inout</code></p>
<p>If the parameter has a noncopyable type, then the parameter in the callee binds to the storage location referenced by the argument.</p>
<p>If the parameter has a copyable type, then the parameter in the callee may, at the discretion of the implementation, bind to either:</p>
<ul><li><p>the storage location referenced by the argument</p>
</li>
<li><p>a fresh storage location, in which case that location is initialized with a copy of the argument value on entry, and the value at that location is written to the argument on return from the function.</p>
</li>
</ul>
<h5 id="sec.ref"><a href="#sec.ref" class="anchor"><code>ref</code></a></h5>
<p>The <code>ref</code> direction indicates pass-by-reference semantics.
The parameter in the callee binds to the storage location referenced by the argument.</p>
<h3 id="sec.decl.accessor"><a href="#sec.decl.accessor" class="anchor">Accessors</a></h3>
<h3 id="sec.decl.invocable"><a href="#sec.decl.invocable" class="anchor">Invocable Declarations</a></h3>
<p>A declaration that is <dfn>invocable</dfn> can be invoked by a strand during execution.</p>
<h2 id="sec.pattern"><a href="#sec.pattern" class="anchor">Patterns</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar">
<div class="grammar production"><dfn><span class="meta">Pattern</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">BindingPattern</span></span>
⇒ <span class="alternative grammar"><span class="meta">TuplePattern</span></span>
⇒ <span class="alternative grammar"><span class="meta">ExpressionPattern</span></span></div>
<div class="grammar production"><dfn><span class="meta">TuplePattern</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>(</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">Pattern</span> <code>,</code></span></span>)</span>* <code>)</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">ExpressionPattern</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Expression</span></span></div>
<div class="grammar production"><dfn><span class="meta">BindingPattern</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>let</code> <span class="meta">BindingPatternInner</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">BindingPatternInner</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Identifier</span></span>
⇒ <span class="alternative grammar"><span class="meta">TuplePatternInner</span></span></div>
<div class="grammar production"><dfn><span class="meta">TuplePatternInner</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>(</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">BindingPatternInner</span> <code>,</code></span></span>)</span>* <code>)</code></span></span></div>
</pre>
</div>
<h2 id="sec.decl.generic"><a href="#sec.decl.generic" class="anchor">Generics</a></h2>
<h2 id="sec.decl.type"><a href="#sec.decl.type" class="anchor">Type Declarations</a></h2>
<p>A <dfn>type declaration</dfn> <a>introduces</a> a binding to a type.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">TypeDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">AggregateTypeDeclaration</span></span>
⇒ <span class="alternative grammar"><span class="meta">EnumDeclaration</span></span>
⇒ <span class="alternative grammar"><span class="meta">TypeAliasDeclaration</span></span></div>
</pre>
</div>
<h3 id="sec.decl.agg"><a href="#sec.decl.agg" class="anchor">Aggregate Types</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">AggregateTypeDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar">(<span class="grammar"><span class="grammar"><code>struct</code> | <code>class</code> | <code>interface</code></span></span>) <span class="meta">Identifier</span> <span class="grammar"><span class="meta">GenericParametersClause</span></span>? <span class="grammar"><span class="meta">BasesClause</span></span>? <span class="grammar"><span class="meta">GenericWhereClause</span></span>? <span class="meta">DeclarationBodyClause</span> <span class="grammar"><code>;</code></span>?</span></span></div>
<div class="grammar production"><dfn><span class="meta">DeclarationBodyClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>{</code> <span class="grammar"><span class="meta">Declaration</span></span>* <code>}</code></span></span></div>
</pre>
</div>
<p>An <dfn>aggregate type declaration</dfn> is either a <code>struct</code> declaration, a <code>class</code> declaration, or an <dfn>interface declaration</dfn>.</p>
<p>The declarations in the body clause of an <a>aggregate type declaration</a> are referred the <dfn>direct members</dfn> of that declaration.</p>
<div class="note callout">Note: We need rules to define what the members that aren't <a>direct members</a> are.</div>
<h4 id="sec.decl.agg.member.static"><a href="#sec.decl.agg.member.static" class="anchor">Instance and Static Members</a></h4>
<p>Members of an aggregate type may me marked with a <code>static</code> modifier, in which case they are <dfn>static members</dfn> of the type.
Members not marked with <code>static</code> are <dfn>instance members</dfn> of the type.</p>
<p><a>Static members</a> are referenced through the type itself.
<a>Instance members</a> are referened through values that are instances of the type.</p>
<h4 id="sec.field"><a href="#sec.field" class="anchor">Fields</a></h4>
<p>Variable declarations that are instance members of an aggregate type declaration are also referred to as the <dfn>fields</dfn> of the aggregate type declaration.</p>
<h4 id="sec.method"><a href="#sec.method" class="anchor">Methods</a></h4>
<p><a>Function declarations</a> that are instance members of an aggregate type declaration are also referred to as <dfn>methods</dfn>.</p>
<p>By default, the implicit <code>this</code> parameter of a method acts has a direction of <code>in</code>.
A method of a <code>struct</code> type declaration may be modified with the <code>[mutating]</code> attribute, in which case the implicit <code>this</code> parameter has a direction of <code>inout</code>.</p>
<h3 id="sec.decl.agg.bases"><a href="#sec.decl.agg.bases" class="anchor">Bases</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">BasesClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>:</code> <span class="meta">Base</span> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><code>,</code> <span class="meta">Base</span></span></span>)</span>*</span></span></div>
<div class="grammar production"><dfn><span class="meta">Base</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">TypeExpression</span></span></div>
</pre>
</div>
<p>An aggregate type declaration has zero or more <dfn>bases</dfn>.
If an aggregate type declaration has no bases clause, then it has zero <a>bases</a>;
otherwise, the bases of the aggregate type declaration are the types identified by eachBase in that clause.</p>
<p>The list of bases of a <code>struct</code> declaration must consist of:</p>
<ul><li><p>at most one <code>struct</code> type</p>
</li>
<li><p>zero or more interface types</p>
</li>
</ul>
<p>The list of bases of a <code>class</code> declaration must consist of:</p>
<ul><li><p>at most one <code>class</code> type</p>
</li>
<li><p>zero or more interface types</p>
</li>
</ul>
<p>The list of bases of an <a>interface declaration</a> must consist of:</p>
<ul><li><p>zero or more interface types</p>
</li>
</ul>
<h4 id="sec.decl.agg.syntax"><a href="#sec.decl.agg.syntax" class="anchor">Traditional Syntax</a></h4>
<h5 id="sec.decl.agg.syntax.trailing-semicolon"><a href="#sec.decl.agg.syntax.trailing-semicolon" class="anchor">Trailing Semicolon</a></h5>
<p>For compatibility, the body clause of an aggregate type declaration may end with a semicolon (<code>;</code>).
The body clause of an aggregate type declaration must end with a semicolon if there are any tokens between the closing <code>}</code> token and the next line break that follows it.</p>
<div class="note callout">Note: Put more simply: a closing <code>;</code> can be left off of an aggregate type declaration so long as there is nothing but trivia after it on the same line.</div>
<h5 id="sec.decl.agg.type-specifier"><a href="#sec.decl.agg.type-specifier" class="anchor">Aggregate Type Specifiers</a></h5>
<p>An aggregate type declaration may be used as a type specififer in declarations using traditional syntax.</p>
<p>When an aggregate type declaration is used as a type specififer, the closing <code>}</code> of its body must be followed by another token on the same line.</p>
<h3 id="sec.decl.enum"><a href="#sec.decl.enum" class="anchor"><code>enum</code>Declarations</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">EnumDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>enum</code> <span class="meta">Identifier</span> <span class="grammar"><span class="meta">GenericParametersClause</span></span>? <span class="grammar"><span class="meta">BasesClause</span></span>? <span class="grammar"><span class="meta">GenericWhereClause</span></span>? <span class="meta">EnumBody</span> <span class="grammar"><code>;</code></span>?</span></span></div>
<div class="grammar production"><dfn><span class="meta">EnumBody</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">TraditionalEnumBody</span></span>
⇒ <span class="alternative grammar"><span class="meta">DeclarationBody</span></span></div>
</pre>
</div>
<p>An <dfn><code>enum</code> declaration</dfn> introduces a binding for a type whose instances value into one or more cases.</p>
<p>An <a>enum declaration</a> that has a declaration body is a modern <code>enum</code> declaration.
A <a>enum declaration</a> that has a traditional <code>enum</code> body is a traditional <code>enum</code> declaration.</p>
<p>An <a>enum declaration</a> may have a bases clause, in which case the list of bases must consist of:</p>
<ul><li><p>at most one proper type; if present, this determines an <dfn>underlying type</dfn> for the <code>enum</code> declaration.</p>
</li>
<li><p>zero or more interface types</p>
</li>
</ul>
<p>A traditional <a>enum declaration</a> always has an <a>underlying type</a>.
If an underlying type is not specified in the bases list of a traditional <code>enum</code> declaration, then the underlying type of that declaration is <code>Int</code>.
The underlying type of a traditional <a>enum declaration</a> must be a built-in integer type.</p>
<p>A modern <a>enum declaration</a> must not specify an underlying type.</p>
<h4 id="sec.case"><a href="#sec.case" class="anchor">Cases</a></h4>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">CaseDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>case</code> <span class="meta">Identifier</span> <span class="grammar"><span class="meta">InitialValueClause</span></span>?</span></span></div>
<div class="grammar production"><dfn><span class="meta">TraditionalEnumBody</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>{</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">TraditionalCaseDeclaration</span> <code>,</code></span></span>)</span>* <code>}</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">TraditionalCaseDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Identifier</span> <span class="grammar"><span class="meta">InitialValueClause</span></span>?</span></span></div>
</pre>
</div>
<p>The possible values of an <code>enum</code> type are determined by the <dfn>case declarations</dfn> in its body.
An <code>enum</code> type has one case for each case declaration in its body.</p>
<p>The <a>case declarations</a> in a modern <a>enum declaration</a> are declared using the <code>case</code> keyword.
The case declarations in a traditional <code>enum</code> body are traditional case declarations.</p>
<p>Each case of a traditional <a>enum declaration</a> has an <dfn>underlying value</dfn>, that is a value of the <a>underlying type</a> of that <code>enum</code> declaration.
When a traditional case declaration includes an initial-value expression, its <a>underlying value</a> is the result of evaluating that expression, with the underlying type of the <a>enum declaration</a> as the expected type.
The underlying value of a traditional case declaration must be an compile-time-constant integer value.
If a traditional case declaration does not have an initial-value expression, then its underlying value is one greater than the underlying value of the preceding case declaration, or zero if there is no preceding case declaration.</p>
<p>Case declarations are implicitly static.</p>
<p><!-->
%
%### Conversions [decl.enum.conv]
%
%A value of an enumeration type can be implicitly converted to a value of its tag %type:
%
%<code>hlsl %int r = Color.Red; %</code>
%
%Values of the tag type can be explicitly converted to the enumeration type:
%
%<code>hlsl %Color red = Color(r); %</code>
</--></p>
<h3 id="sec.decl.type.alias"><a href="#sec.decl.type.alias" class="anchor">Type Aliases</a></h3>
<p>A <dfn>type alias declaration</dfn> introduces a binding that resolves to some other type.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">TypeAliasDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">ModernTypeAliasDeclaration</span></span>
⇒ <span class="alternative grammar"><span class="meta">TraditionalTypeAliasDeclaration</span></span></div>
<div class="grammar production"><dfn><span class="meta">ModernTypeAliasDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>typealias</code> <span class="meta">Identifier</span> <span class="grammar"><span class="meta">GenericParametersClause</span></span>? <span class="grammar"><span class="meta">GenericWhereClause</span></span>? <code>=</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">TypeExpression</span></dfn>
⇒ <span class="alternative grammar"><code>;</code></span></div>
</pre>
</div>
<div class="issue callout">TODO: <a>type alias declaration</a></div>
<pre><code class="language-.checking">GIVEN identifier n, type t, context c
GIVEN t checks in c
THEN `typealias` n = t `;` checks in c
</code></pre>
<pre><code class="language-">
</code></pre>
<h4 id="sec.decl.type.alias.syntax.traditional"><a href="#sec.decl.type.alias.syntax.traditional" class="anchor">Traditional Syntax</a></h4>
<p>A type alias may also be declared using a <dfn>traditional type alias declaration</dfn>.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">TraditionalTypeAliasDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>typedef</code> <span class="meta">TypeSpecifier</span> <span class="meta">Declarator</span> <code>;</code></span></span></div>
</pre>
</div>
<div class="issue callout">TODO: <a>traditional type alias declaration</a></div>
<p>To desguar a <a>traditional type alias declaration</a> <code>typedef <a><var class="meta">ts</var></a> <a><var class="meta">d</var></a> ;</code>, where <a><var class="meta">ts</var></a> is a type specifier and <a><var class="meta">d</var></a> is a declarator:</p>
<ul><li><p>Unwrap <a><var class="meta">d</var></a> for <a><var class="meta">ts</var></a> to yield type expression <a><var class="meta">t</var></a> and optional name declarator <a><var class="meta">nd</var></a></p>
</li>
<li><p>If <a><var class="meta">nd</var></a> is not present then:</p>
<ul><li><p>diagnose an error</p>
</li>
</ul>
</li>
<li><p>Otherwise:</p>
<ul><li><p>Let <a><var class="meta">n</var></a> be the name of <a><var class="meta">nd</var></a></p>
</li>
<li><p>Return the modern type alias declaration <code>typealias <a><var class="meta">n</var></a> = <a><var class="meta">t</var></a> ;</code></p>
</li>
</ul>
</li>
</ul>
<h3 id="sec.decl.type.associated"><a href="#sec.decl.type.associated" class="anchor">Associated Types</a></h3>
<p>An <dfn>associated type declaration</dfn> introduces a type requirement to an <a>interface declaration</a>.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">AssociatedTypeDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>associatedtype</code> <span class="meta">Identifier</span> <span class="grammar"><span class="meta">GenericParametersClause</span></span>? <span class="grammar"><span class="meta">BasesClause</span></span>? <span class="grammar"><span class="meta">GenericWhereClause</span></span>? <code>;</code></span></span></div>
</pre>
</div>
<p>An <a>associated type declaration</a> may only appear as a member declaration of an <a>interface declaration</a>.</p>
<p>An associated type is an interface requirement, and different implementations of an interface may provide different types that satisfy the same associated type interface requirement.</p>
<h2 id="sec.decl.traditional"><a href="#sec.decl.traditional" class="anchor">Traditional Declarations</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Declarator</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">NameDeclarator</span></span>
⇒ <span class="alternative grammar"><span class="meta">ParenthesizedDeclarator</span></span>
⇒ <span class="alternative grammar"><span class="meta">ArrayDeclarator</span></span>
⇒ <span class="alternative grammar"><span class="meta">PointerDeclarator</span></span></div>
<div class="grammar production"><dfn><span class="meta">NameDeclarator</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Identifier</span></span></div>
<div class="grammar production"><dfn><span class="meta">ParenthesizedDeclarator</span></dfn>
⇒ <span class="alternative grammar"><code>(</code></span></div>
<div class="grammar production"><dfn><span class="meta">Declarator</span></dfn>
⇒ <span class="alternative grammar"><code>)</code></span></div>
<div class="grammar production"><dfn><span class="meta">ArrayDeclarator</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Declarator</span> <code>[</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">Expression</span> <code>,</code></span></span>)</span>* <code>]</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">PointerDeclarator</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>*</code> <span class="grammar"><span class="meta">PointerQualifier</span></span>* <span class="meta">Declarator</span></span></span></div>
</pre>
</div>
<p>Unwrapping a declarator for some type expression yields a type expression and an optional name declarator.</p>
<p>The unwrapping of a name declarator <a><var class="meta">nd</var></a> for a type expression <a><var class="meta">t</var></a> is (<a><var class="meta">t</var></a>, <a><var class="meta">nd</var></a>).</p>
<p>The unwrapping of a parenthesized declarator <code>( <a><var class="meta">d</var></a> )</code> for a type expression <a><var class="meta">t</var></a> is the unwrapping of <a><var class="meta">d</var></a> for <a><var class="meta">t</var></a>.</p>
<p>The unwrapping of an array declarator <code><a><var class="meta">d</var></a> [ <a><var class="meta">args</var></a> ]</code> for a type expression <a><var class="meta">t</var></a> is the unwrapping of <a><var class="meta">d</var></a> for <code>Array<<a><var class="meta">t</var></a></code>, <code><a><var class="meta">args</var></a>></code>.</p>
<p>The unwrapping of a pointer declarator <code>* <a><var class="meta">q</var></a> <a><var class="meta">d</var></a></code> for a type expression <a><var class="meta">t</var></a> is the unwrapping of <a><var class="meta">d</var></a> for <code>Ptr<(<a><var class="meta">q</var></a> <a><var class="meta">t</var></a>)></code></p>
<h2 id="sec.decl.var"><a href="#sec.decl.var" class="anchor">Variables</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">VariableDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar">(<span class="grammar"><span class="grammar"><code>let</code> | <code>var</code></span></span>) <span class="meta">Identifier</span> <span class="grammar"><span class="meta">TypeAscriptionClause</span></span>? <span class="grammar"><span class="meta">InitialValueClause</span></span>? <code>;</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">TypeAscriptionClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>:</code> <span class="meta">TypeExpression</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">InitialValueClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>=</code> <span class="meta">Expression</span></span></span></div>
</pre>
</div>
<p>A <dfn>variable</dfn> is an <a>abstract storage location</a> that can hold a value.
Every <a>variable</a> has a type, and it can only hold values of that type.
Every variable is either immutable or mutable.</p>
<p>A <dfn>variable declaration</dfn> introduces a binding for the given Identifier, to a variable.
A <a>variable declaration</a> using the <code>let</code> keyword binds an immutable variable.
A <a>variable declaration</a> using the <code>var</code> keyword binds a mutable variable.</p>
<p>Every variable declaration has a type, and the variable it <a>binds</a> is of the same type.</p>
<p>A variable declaration must have either a TypeAscriptionClause or an InitialValueClause; a variable declaration may have both.</p>
<p>If a variable declaration has a type ascription, then let <a><var class="meta">T</var></a> be the type that results from evaluating the type expression of that type ascription in the input environment of the declaration.</p>
<p>If a variable declaration has a TypeAscriptionClause and no InitialValueClause, then the type of that variable declaration is <a><var class="meta">T</var></a>.</p>
<p>If a variable declaration has both a TypeAscriptionClause and an InitialValueClause, then let <a><var class="meta">E</var></a> be the value that results from evaluating the expression of the initial value clause against the expected type <a><var class="meta">T</var></a> in the input environment of the declaration.
The type of the variable declaration is the type of <a><var class="meta">E</var></a>, and its initial value is <a><var class="meta">E</var></a>.</p>
<p>If a variable declaration has an InitialValueClause but no TypeAscriptionClause, then let <a><var class="meta">E</var></a> be the value that results from evaluating the expression of the initial value clause in the input environment of the declaration.
The type of the variable declaration is the type of <a><var class="meta">E</var></a>, and its initial value is <a><var class="meta">E</var></a>.</p>
<h3 id="sec.decl.var.traditional"><a href="#sec.decl.var.traditional" class="anchor">Traditional Variable Declarations</a></h3>
<p>Variable declaration may also be declared using traditional syntax, which is similar to C:</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">VariableDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">LegacyVariableDeclaration</span></span></div>
<div class="grammar production"><dfn><span class="meta">LegacyVariableDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">TypeSpecifier</span> <span class="grammar"><span class="meta">InitDeclarator</span></span>* <code>;</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">InitDeclarator</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Declarator</span> <span class="grammar"><span class="meta">InitialValueClause</span></span>?</span></span></div>
</pre>
</div>
<p>To desugar a traditional variable declaration <code><a><var class="meta">typeSpecifier</var></a> <a><var class="meta">initDeclarators</var></a> ;</code>:</p>
<ul><li><p>Let variable <a><var class="meta">result</var></a> be an empty sequence of declarations</p>
</li>
<li><p>Let <a><var class="meta">ts</var></a> be a fresh name</p>
</li>
<li><p>Append <code>typealias <a><var class="meta">ts</var></a> = <a><var class="meta">typeSpecifier</var></a> ;</code> to <a><var class="meta">result</var></a></p>
</li>
<li><p>For each <a><var class="meta">i</var></a> in <a><var class="meta">initDeclarators</var></a>:</p>
<ul><li><p>Let <a><var class="meta">d</var></a> be the declarator of <a><var class="meta">i</var></a></p>
</li>
<li><p>Unwrap <a><var class="meta">d</var></a> for <a><var class="meta">ts</var></a> to yield <a><var class="meta">n</var></a> and <a><var class="meta">t</var></a></p>
</li>
<li><p>Let <a><var class="meta">iv</var></a> be the initial value clause of <a><var class="meta">i</var></a></p>
</li>
<li><p>Let <a><var class="meta">v</var></a> be <code>var <a><var class="meta">n</var></a> : <a><var class="meta">t</var></a> <a><var class="meta">iv</var></a> ;</code></p>
</li>
<li><p>Append <a><var class="meta">v</var></a> to <a><var class="meta">result</var></a></p>
</li>
</ul>
</li>
<li><p>Return <a><var class="meta">result</var></a></p>
</li>
</ul>
<div class="issue callout"><h6>Issue</h6>
<p>The above desugaring logic is ignoring modifiers.
It also isn't making sure to use a <code>let</code> declaration where possible (because <a><var class="meta">t</var></a> ends up being <code>const</code>).</p>
</div>
<p>A legacy variable declaration introduces a binding for each InitDeclarator.
Let <a><var class="meta">S</var></a> be the type that results from evaluating the TypeSpecifier in the input environment.
The type <a><var class="meta">T</var></a> corresponding to each declarator is determined by evaluating the declarator in the input environment, against input type <a><var class="meta">S</var></a>.</p>
<div class="note callout">Note: Slang does not support the equivalent of the <code>auto</code> type specifier in C++.
Variables declared using <code>let</code> and <code>var</code> can be used to fill a similar role.</div>
<p>The variables introduced by a legacy variable declaration are immutable if the declaration has a <code>const</code> modifier; otherwise it is mutable.</p>
<h3 id="sec.decl.var.global"><a href="#sec.decl.var.global" class="anchor">Variables at Global Scope</a></h3>
<p>A variable declaration at global scope may be either a global constant, a static global variable, or a global shader parameter.</p>
<p>Variables declared at global scope may be either a global constant, a static global variables, or a global shader parameters.</p>
<h4 id="sec.decl.var.global.const"><a href="#sec.decl.var.global.const" class="anchor">Global Constants</a></h4>
<p>A variable declared at global scope and marked with <code>static</code> and <code>const</code> is a <dfn>global constant</dfn>.</p>
<p>A <a>global constant</a> must have an initial-value clause, and the initial-value expression must be a compile-time constant expression.</p>
<div class="issue callout">Issue: Need a section to define what a "compile-time constant expression" is.</div>
<h4 id="sec.decl.var.global.static"><a href="#sec.decl.var.global.static" class="anchor">Static Global Variables</a></h4>
<p>A variable declared at global scope and marked with <code>static</code> but not with <code>const</code> is a <dfn>static global variable</dfn>.</p>
<p>A <a>static global variable</a> provides storage for each strand executing an entry point.
Writes to a static global variable from one strand do not affect the value seen by other strands.</p>
<div class="note callout">Note: The semantics of static global variable are similar to a "thread-local" variable in other programming models.</div>
<p>A static global variable may include an initial-value expression; if an initial-value expression is included it is guaranteed to be evaluated and assigned to the variable before any other expression that references the variable is <a>evaluated</a>.
If a thread attempts to read from a static global variable during the evaluation of the initial-value expression for that variable, a runtime error is raised.</p>
<p>There is no guarantee that the initial-value expression for a static global variable is evaluated before entry point execution begins, or even that the initial-value expression is evaluated at all (in cases where the variable might not be referenced at runtime).</p>
<div class="note callout">Note: The above rules mean that an implementation can perform dead code elimination on static global variables, and can choose between eager and lazy initialization of those variables at its discretion.</div>
<h4 id="sec.global.param"><a href="#sec.global.param" class="anchor">Global Shader Parameters</a></h4>
<p>A variable declared at global scope and not marked with <code>static</code> is a <dfn>global shader parameter</dfn>.</p>
<p><a>Global shader parameters</a> are used to pass arguments from application code into strands executing an entry point.
The mechanisms for parameter passing are specific to each target platform.</p>
<p>A global shader parameter may include an initial-value expression, but such an expression does not affect the semantics of the compiled program.</p>
<div class="note callout">Note: An implementation can choose to provide ways to query the initial-value expression of a global shader parameter, or to evaluate it to a value.
<a>Host</a> applications can use such capabilities to establish a default value for global shader parameters.</div>
<div class="issue callout">TODO: We need to define <dfn>uniform shader parameters</dfn> somewhere.</div>
<h3 id="sec.decl.var.func"><a href="#sec.decl.var.func" class="anchor">Variables at Function Scope</a></h3>
<p>Variables declared at <dfn>function scope</dfn> (in the body of a function, initializer, subscript acessor, etc.) may be either a function-scope constant, function-scope static variable, or a local variable.</p>
<h4 id="sec.const"><a href="#sec.const" class="anchor">Function-Scope Constants</a></h4>
<p>A variable declared at <a>function scope</a> and marked with both <code>static</code> and <code>const</code> is a <dfn>function-scope constant</dfn>.
Semantically, a <a>function-scope constant</a> behaves like a global constant except that its name is only bound in the local scope.</p>
<h4 id="sec.static"><a href="#sec.static" class="anchor">Function-Scope Static Variables</a></h4>
<p>A variable declared at function scope and marked with <code>static</code> (but not <code>const</code>) is a <dfn>function-scope static variable</dfn>.
Semantically, a <a>function-scope static variable</a> behaves like a global static variable except that its name is only visible in the local scope.</p>
<p>The initial-value expression for a function-scope static variable may refer to non-static variables in the body of the function.
In these cases initialization of the variable is guaranteed not to occur until at least the first time the function body is evaluated for a given invocation.</p>
<h4 id="sec.local"><a href="#sec.local" class="anchor">Local Variables</a></h4>
<p>A variable declared at function scope and not marked with <code>static</code> (even if marked with <code>const</code>) is a <dfn>local variable</dfn>.
A <a>local variable</a> has unique storage for each activation of a function.</p>
<div class="note callout">Note: When a function is called recursively, each call produces a distinct activation with its own copies of local variables.</div>
<h2 id="sec.decl.func"><a href="#sec.decl.func" class="anchor">Functions</a></h2>
<p>A <dfn>function declaration</dfn> introduces a binding to a function.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">FunctionDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>func</code> <span class="meta">Identifier</span> <span class="grammar"><span class="meta">GenericParametersClause</span></span>? <span class="meta">ParametersClause</span> <span class="grammar"><span class="meta">GenericWhereClause</span></span>? <span class="grammar"><span class="meta">ResultTypeClause</span></span>? <span class="meta">FunctionBodyClause</span></span></span></div>
</pre>
</div>
<p>A function declaration is invocable.</p>
<h3 id="sec.decl.func.result"><a href="#sec.decl.func.result" class="anchor">Result Type</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ResultTypeClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>-></code> <span class="meta">TypeExpression</span></span></span></div>
</pre>
</div>
<p>If a function declaration has a result type clause, then the <a>result type</a> of the function is the type that results from evaluating the type expression in that clause.
If a function declaration does not have a result type clause, then the result type of the function is the unit type.</p>
<h3 id="sec.decl.func.body"><a href="#sec.decl.func.body" class="anchor">Body</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">FunctionBodyClause</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">BlockStatement</span></span>
⇒ <span class="alternative grammar"><code>;</code></span></div>
</pre>
</div>
<p>A function declaration may have a <dfn>body</dfn>.
A function declaration with a <a>body</a> is a <dfn>function definition</dfn>.</p>
<p>If the function body clause is a block statement, then that statement is the body of the <a>function definition</a>.
If the function body clause is <code>;</code>, then that function declaration has no body.</p>
<h3 id="sec.decl.func.traditional"><a href="#sec.decl.func.traditional" class="anchor">Traditional Function Declarations</a></h3>
<p>A <dfn>traditional function declaration</dfn> is a function declaration that uses traditional C-like syntax.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">TraditionalFunctionDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">TypeSpecifier</span> <span class="meta">Declarator</span> <span class="grammar"><span class="meta">GenericParametersClause</span></span>? <span class="meta">TraditionalParametersClause</span> <span class="grammar"><span class="meta">GenericWhereClause</span></span>? <span class="meta">FunctionBodyClause</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">TraditionalParametersClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>(</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">TraditionalParameterDeclaration</span> <code>,</code></span></span>)</span>* <code>)</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">TraditionalParameterDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Direction</span> <span class="meta">TypeSpecifier</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">Declarator</span></dfn>
⇒ <span class="alternative grammar"><span class="grammar"><span class="meta">DefaultValueClause</span></span>?</span></div>
</pre>
</div>
<div class="issue callout">TODO: <a>traditional function declaration</a></div>
<h3 id="sec.decl.func.entry"><a href="#sec.decl.func.entry" class="anchor">Entry Points</a></h3>
<p>An <dfn>entry point declaration</dfn> is a function declaration that can be used as the starting point of execution for a thread.</p>
<div class="issue callout">TODO: reference <a>entry point declaration</a>.</div>
<h2 id="sec.decl.init"><a href="#sec.decl.init" class="anchor">Constructors</a></h2>
<p>A <dfn>constructor declaration</dfn> introduces logic for initializing an instance of the enclosing <a>type declaration</a>.
A <a>constructor declaration</a> is implicitly static.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ConstructorDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>init</code> <span class="grammar"><span class="meta">GenericParametersClause</span></span>? <span class="meta">ParametersClause</span> <span class="meta">FunctionBodyClause</span></span></span></div>
</pre>
</div>
<p>A constructor declaration is invocable.
A constructor declaratin has an implicit <code>this</code> parameter, with a direction of <code>out</code>.</p>
<div class="note callout">Note: Slang does not provide any equivalent to C++ destructors, which run automatically when an instance goes out of scope.</div>
<h2 id="sec.decl.prop"><a href="#sec.decl.prop" class="anchor">Properties</a></h2>
<p>A <dfn>property declaration</dfn> introduces a binding that can have its behavior for read and write operations customized.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">PropertyDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>property</code> <span class="meta">Identifier</span> <span class="grammar"><span class="meta">GenericParametersClause</span></span>? <span class="meta">TypeAscriptionClause</span> <span class="meta">GenericWhereClause</span> <span class="meta">PropertyBody</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">PropertyBody</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>{</code> <span class="grammar"><span class="meta">AccessorDecl</span></span>* <code>}</code></span></span></div>
</pre>
</div>
<div class="issue callout">TODO: reference <a>property declaration</a>.</div>
<h3 id="sec.decl.accessor"><a href="#sec.decl.accessor" class="anchor">Accessors</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">AccessorDecl</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">GetAccessorDecl</span></span></div>
<div class="grammar production"><dfn><span class="meta">SetAccessorDecl</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">GetAccessorDecl</span> <code>get</code> <span class="meta">FunctionBodyClause</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">SetAccessorDecl</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>set</code> <span class="grammar"><span class="meta">ParametersClause</span></span>? <span class="meta">FunctionBodyClause</span></span></span></div>
</pre>
</div>
<p>An accessor declaration is invocable.</p>
<h2 id="sec.decl.subscript"><a href="#sec.decl.subscript" class="anchor">Subscripts</a></h2>
<p>A <dfn>subscript declaration</dfn> introduces a way for the enclosing type to be used as the base expression of a subscript expression.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">SubscriptDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>subscript</code> <span class="grammar"><span class="meta">GenericParametersClause</span></span>? <span class="meta">ParametersClause</span> <span class="meta">ResultTypeClause</span> <span class="grammar"><span class="meta">GenericWhereClause</span></span>? <span class="meta">PropertyBody</span></span></span></div>
</pre>
</div>
<p>A subscript declaration is invocable.</p>
<div class="note callout">Note: Unlike a function declaration, a <a>subscript declaration</a> cannot elide the result type clause.</div>
<h2 id="sec.decl.extension"><a href="#sec.decl.extension" class="anchor">Extensions</a></h2>
<p>An extension declaration is introduced with the <code>extension</code> keyword:</p>
<pre><code class="language-">extension MyVector
{
    float getLength() { return sqrt(x*x + y*y); }
    static int getDimensionality() { return 2; }
}
</code></pre>
<p>An extension declaration adds behavior to an existing type.
In the example above, the <code>MyVector</code> type is extended with an instance method <code>getLength()</code>, and a static method <code>getDimensionality()</code>.</p>
<p>An extension declaration names the type being extended after the <code>extension</code> keyword.
The body of an extension declaration may include type declarations, functions, initializers, and subscripts.</p>
<div class="note callout">Note: The body of an extension cannot include variable declarations.
An extension cannot introduce members that would change the in-memory layout of the type being extended.</div>
<p>The members of an extension are accessed through the type that is being extended.
For example, for the above extension of <code>MyVector</code>, the introduced <a>methods</a> are accessed as follows:</p>
<pre><code class="language-">MyVector v = ...;

float f = v.getLength();
int n = MyVector.getDimensionality();
</code></pre>
<p>An extension declaration need not be placed in the same module as the type being extended; it is possible to extend a type from third-party or standard-library code.
The members of an extension are only visible inside of modules that <code>import</code> the module declaring the extension;
extension members are not automatically visible wherever the type being extended is visible.</p>
<p>An extension declaration may include an inheritance clause:</p>
<pre><code class="language-">extension MyVector : IPrintable
{
    ...
}
</code></pre>
<p>The inheritance clause of an extension declaration may only include interfaces.
When an extension declaration lists an interface in its inheritance clause, it asserts that the extension introduces a new conformance, such that the type being extended now conforms to the given interface.
The extension must ensure that the type being extended satisfies all the requirements of the interface.
Interface requirements may be satisfied by the members of the extension, members of the original type, or members introduced through other extensions visible at the point where the conformance was declared.</p>
<p>It is an error for overlapping conformances (that is, of the same type to the same interface) to be visible at the same point.
This includes cases where two extensions declare the same conformance, as well as those where the original type and an extension both declare the same conformance.
The conflicting conformances may come from the same module or difference modules.</p>
<p><div algorithm>
In order to avoid problems with conflicting conformances, when a module <a><var class="meta">M</var></a> introduces a conformance of type <a><var class="meta">T</var></a> to interface <a><var class="meta">I</var></a>, one of the following should be true:</p>
<ul><li><p>The type <a><var class="meta">T</var></a> is declared in module <a><var class="meta">M</var></a></p>
</li>
<li><p>The interface <a><var class="meta">I</var></a> is declared in module <a><var class="meta">M</var></a></p>
</li>
</ul>
<p>Any conformance that does not follow these rules (that is, where both <a><var class="meta">T</var></a> and <a><var class="meta">I</var></a> are imported into module <a><var class="meta">M</var></a>) is called a <dfn>retroactive conformance</dfn>, and there is no way to guarantee that another module <a><var class="meta">N</var></a> will not introduce the same conformance.
The runtime behavior of programs that include overlapping <a>retroactive conformances</a> is currently undefined.
</div></p>
<p>Currently, extension declarations can only apply to structure types.</p>
<h2 id="sec.decl.generic"><a href="#sec.decl.generic" class="anchor">Generics</a></h2>
<p>Many kinds of declarations can be made <a>generic</a>: structure types, interfaces, extensions, functions, initializers, and subscripts.</p>
<p>A <a>generic</a> declaration introduces a <dfn>generic parameter list</dfn> enclosed in angle brackets <code><></code>:</p>
<pre><code class="language-">T myFunction<T>(T left, T right, bool condition)
{
    return condition ? left : right;
}
</code></pre>
<h3 id="sec.decl.generic.param"><a href="#sec.decl.generic.param" class="anchor">Generic Parameters</a></h3>
<p>A <a>generic parameter list</a> can include one or more parameters separated by commas.
The allowed forms for <dfn>generic parameters</dfn> are:</p>
<ul><li><p>A single identifier like <code>T</code> is used to declare a <dfn>generic type parameter</dfn> with no constraints.</p>
</li>
<li><p>A clause like <code>T : IFoo</code> is used to introduce a <a>generic type parameter</a> <code>T</code> where the parameter is constrained so that it must conform to the <code>IFoo</code> interface.</p>
</li>
<li><p>A clause like <code>let N : int</code> is used to introduce a <dfn>generic value parameter</dfn> <code>N</code>, which takes on values of type <code>int</code>.</p>
</li>
</ul>
<div class="note callout">Note: The syntax for <a>generic value parameters</a> is provisional and subject to possible change in the future.</div>
<p><a>Generic parameters</a> may declare a default value with <code>=</code>:</p>
<pre><code class="language-">T anotherFunction<T = float, let N : int = 4>(vector<T,N> v);
</code></pre>
<p>For generic type parameters, the default value is a type to use if no argument is specified.
For generic value parameters, the default value is a value of the same type to use if no argument is specified.</p>
<h3 id="sec.decl.generic.specialize.explicit"><a href="#sec.decl.generic.specialize.explicit" class="anchor">Explicit Specialization</a></h3>
<p>A generic is <dfn>specialized</dfn> by applying it to <dfn>generic arguments</dfn> listed inside angle brackets <code><></code>:</p>
<pre><code class="language-">anotherFunction<int, 3>
</code></pre>
<p>Specialization produces a reference to the declaration with all generic parameters bound to concrete arguments.</p>
<p>When specializing a generic, generic type parameters must be matched with type arguments that conform to the constraints on the parameter, if any.
Generic value parameters must be matched with value arguments of the appropriate type, and that are specialization-time constants.</p>
<p>An explicitly <a>specialized</a> function, type, etc. may be used wherever a non-generic function, type, etc. is expected:</p>
<pre><code class="language-">int i = anotherFunction<int,3>( int3(99) );
</code></pre>
<h3 id="sec.decl.generic.specialize.implicit"><a href="#sec.decl.generic.specialize.implicit" class="anchor">Implicit Specialization</a></h3>
<p>If a generic function/type/etc. is used where a non-generic function/type/etc. is expected, the compiler attempts <dfn>implicit specialization</dfn>.
<a>Implicit specialization</a> infers generic arguments from the context at the use site, as well as any default values specified for generic parameters.</p>
<p>For example, if a programmer writes:</p>
<pre><code class="language-">int i = anotherFunction( int3(99) );
</code></pre>
<p>The compiler will infer the generic arguments <code><int, 3></code> from the way that <code>anotherFunction</code> was applied to a value of type <code>int3</code>.</p>
<div class="note callout">Note: Inference for generic arguments currently only takes the types of value arguments into account.
The expected result type does not currently affect inference.</div>
<h3 id="sec.decl.generic.syntax"><a href="#sec.decl.generic.syntax" class="anchor">Syntax Details</a></h3>
<p>The following examples show how generic declarations of different kinds are written:</p>
<pre><code class="language-">T genericFunction<T>(T value);
funct genericFunction<T>(value: T) -> T;

__init<T>(T value);

__subscript<T>(T value) -> X { ... }

struct GenericType<T>
{
    T field;
}

interface IGenericInterface<T> : IBase<T>
{
}
</code></pre>
<div class="note callout">Note: Currently there is no user-exposed syntax for writing a generic extension.</div>
<h2 id="sec.decl.buffer"><a href="#sec.decl.buffer" class="anchor">Traditional Buffer Declarations</a></h2>
<p>A <dfn>traditional buffer declaration</dfn> is a shorthand for declaring a global-scope shader parameter.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">TraditionalBufferDeclaration</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar">(<span class="grammar"><span class="grammar"><code>cbuffer</code> | <code>tbuffer</code></span></span>) <span class="meta">Identifier</span> <span class="meta">DeclarationBody</span> <span class="grammar"><code>;</code></span>?</span></span></div>
</pre>
</div>
<p>Given a <a>traditional buffer declaration</a>, an implementation shall behave as if the declaration were desugared into:</p>
<ul><li><p>A <code>struct</code> declaration with some unique name <a><var class="meta">S</var></a>, and with the declaration body of the buffer declaration.</p>
</li>
<li><p>A global shader parameter declaration with some unique name <a><var class="meta">P</var></a>, where the type of the parameter is <code>ConstantBuffer<<a><var class="meta">S</var></a>></code> in the case of a <code>cbuffer</code> declaration, or <code>TextureBuffer<<a><var class="meta">S</var></a>></code> in the case of a <code>tbuffer</code> declaration.</p>
</li>
</ul>
<p>For each member declared in <a><var class="meta">S</var></a>, a traditional buffer declaration introduces a binding that refers to that member accessed through <a><var class="meta">P</var></a>.</p>
<h1 id="sec.stmt"><a href="#sec.stmt" class="anchor">Statements</a></h1>
<p>A <dfn>statement</dfn> is an entity in the abstract syntax that describes actions to be taken by a thread.
Statements are executed for their effect, rather than evaluated to produce a value.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Statement</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">ExpressionStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">DeclarationStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">BlockStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">EmptyStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">IfStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">SwitchStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">CaseStmt</span></span>
⇒ <span class="alternative grammar"><span class="meta">ForStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">WhileStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">DoWhileStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">BreakStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">ContinueStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">ReturnStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">DiscardStatement</span></span>
⇒ <span class="alternative grammar"><span class="meta">LabeledStatement</span></span></div>
</pre>
</div>
<h2 id="sec.stmt.expr"><a href="#sec.stmt.expr" class="anchor">Expression Statement</a></h2>
<p>An <dfn>expression statement</dfn> evaluates an expression, and then ignores the resulting value.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ExpressionStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Expression</span> <code>;</code></span></span></div>
</pre>
</div>
<pre><code class="language-.checking">GIVEN context c, expression e
GIVEN e synthesizes type t in context c
THEN e `;` checks in context c
</code></pre>
<p>An implementation may diagnose a warning when execution of an <a>expression statement</a> cannot have side effects.</p>
<h2 id="sec.expr.decl"><a href="#sec.expr.decl" class="anchor">Declaration Statement</a></h2>
<p>A <dfn>declaration statement</dfn> introduces a declaration into the current scope.</p>
<pre><code class="language-">	
</code></pre>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">DeclarationStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Declaration</span></span></div>
</pre>
</div>
<pre><code class="language-.checking">GIVEN context c, declaration d
GIVEN declaration d checks in context c
THEN statement d checks in context c
</code></pre>
<pre><code class="language-">	
</code></pre>
<p>Only the following types of declarations may be used in a <a>declaration statement</a>:</p>
<ul><li><p>VariableDeclaration</p>
</li>
</ul>
<h2 id="sec.stmt.block"><a href="#sec.stmt.block" class="anchor">Block Statement</a></h2>
<p>A <dfn>block statement</dfn> executes each of its constituent statements in order.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">BlockStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>{</code> <span class="grammar"><span class="meta">Statement</span></span>* <code>}</code></span></span></div>
</pre>
</div>
<pre><code class="language-.checking">
GIVEN context c
GIVEN statements s0,s1,...
GIVEN context d, a fresh sub-context of c
GIVEN s0,s1,... check in d
THEN `{` s0,s1,... `}` checks in c
</code></pre>
<div class="note callout">Note: Declarations in a <a>block statement</a> are visible to later statements in the same block, but not to earlier statements in the block, or to code outside the block.</div>
<h2 id="sec.stmt.empty"><a href="#sec.stmt.empty" class="anchor">Empty Statement</a></h2>
<p>Executing an empty statement has no effect.</p>
<pre><code class="language-">	
</code></pre>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">EmptyStatement</span></dfn>
⇒ <span class="alternative grammar"><code>;</code></span></div>
</pre>
</div>
<pre><code class="language-.checking">GIVEN context c
THEN `;` checks in c
</code></pre>
<h2 id="sec.stmt.cond"><a href="#sec.stmt.cond" class="anchor">Conditional Statements</a></h2>
<h3 id="sec.stmt.if"><a href="#sec.stmt.if" class="anchor">If Statement</a></h3>
<p>An <dfn>if statement</dfn> executes a sub-statement conditionally.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">IfStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>if</code> <code>(</code> <span class="meta">IfCondition</span> <code>)</code> <span class="meta">Statement</span> <span class="grammar"><span class="meta">ElseClause</span></span>?</span></span></div>
<div class="grammar production"><dfn><span class="meta">IfCondition</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Expression</span></span>
⇒ <span class="alternative grammar"><span class="meta">LetDeclaration</span></span></div>
<div class="grammar production"><dfn><span class="meta">ElseClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>else</code> <span class="meta">Statement</span></span></span></div>
</pre>
</div>
<pre><code class="language-.checking">
GIVEN context c, expression e, statement t
GIVEN e checks against `Bool` in c
GIVEN t checks in C
THEN `if(` e `)` t checks in c

GIVEN context c, expression e, statement t
GIVEN e checks against `Bool` in c
GIVEN t checks in C
GIVEN f checks in C
THEN `if(` e `)` t `else` f checks in c	
</code></pre>
<p>If the condition of an <a>if statement</a> is an expression, then it is evaluated against an expected type of <code>Bool</code> to yield a value <a><var class="meta">C</var></a>.
If <a><var class="meta">C</var></a> is <code>true</code>, then the ThenClause is executed.
If <a><var class="meta">C</var></a> is <code>false</code> and there is a ElseClause, then it is executed.</p>
<p>If the condition of an <code>if</code> statement is a <code>let</code> declaration, then that declaration must have an initial-value expression.
That initial-value expression is evaluated against an expected type of <code>Optional<T></code>, where <a><var class="meta">T</var></a> is a fresh type variable, to yield a value <a><var class="meta">D</var></a>.
If <a><var class="meta">D</var></a> is <code>Some(_C_)</code>, then the ThenClause is executed, in an environment where the name of the <code>let</code> declaration is bound to <a><var class="meta">C</var></a>.
If <a><var class="meta">D</var></a> is <code>null</code> and there is a ElseClause, then it is executed.</p>
<h3 id="sec.stmt.switch"><a href="#sec.stmt.switch" class="anchor">Switch Statement</a></h3>
<p>A <dfn><code>switch</code> statement</dfn> conditionally executes up to one of its <dfn>alternatives</dfn>, based on the value of an expression.</p>
<pre><code class="language-">	
</code></pre>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">SwitchStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>switch</code> <code>(</code> <span class="meta">Expression</span> <code>)</code> <code>{</code> <span class="grammar"><span class="meta">SwitchAlternative</span></span>+ <code>}</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">SwitchAlternative</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="grammar"><span class="meta">SwitchAlternativeLabel</span></span>+ <span class="grammar"><span class="meta">Statement</span></span>+</span></span></div>
<div class="grammar production"><dfn><span class="meta">SwitchAlternativeLabel</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">CaseClause</span></span>
⇒ <span class="alternative grammar"><span class="meta">DefaultClause</span></span></div>
<div class="grammar production"><dfn><span class="meta">CaseClause</span></dfn>
⇒ <span class="alternative grammar"><code>case</code></span></div>
<div class="grammar production"><dfn><span class="meta">Expression</span></dfn>
⇒ <span class="alternative grammar"><code>:</code></span></div>
<div class="grammar production"><dfn><span class="meta">DefaultClause</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>default</code> <code>:</code></span></span></div>
</pre>
</div>
<pre><code class="language-.checking">GIVEN context c, expression e, switch alternatives a0,a1,...
GIVEN e synthesizes type t in c
GIVEN a0,a1,... check against t in c
THEN `switch(` e `) {` a0,a1,... `}` checks in c
</code></pre>
<div class="note callout">Note:
A <code>switch</code> statement is checked by first checking the expression, and then checking each of the <a>alternatives</a> against the type of that expression.</div>
<pre><code class="language-.checking">GIVEN context c, type t,
GIVEN switch alternative labels l0,l1,...
GIVEN statements s0,s1,...
GIVEN l0,l1,... check against t in c
GIVEN s0,s1,... check in c
THEN switch alternative l0,l1,... s0,s1,... checks in c

GIVEN context c, type t, expression e
GIVEN e checks against t in c
THEN `case` e `:` checks against t in c

GIVEN context c, type t
THEN `default:` checks against t in c
</code></pre>
<div class="note callout">Note:
A <code>case</code> clause is valid if its expression <a>checks against</a> the type of the control expressio nof the <code>switch</code> statement.</div>
<p>A <code>switch</code> statement may have at most one <code>default</code> clause.</p>
<p>If the type of the controlling expression of a <code>switch</code> statement is a built-in integer type, then:</p>
<ul><li><p>The expression of each <code>case</code> clause must be a compile-time constant expression.</p>
</li>
<li><p>The constant value of the expression for each <code>case</code> clause must not be equal to that of any other <code>case</code> clause in the same <code>switch</code>.</p>
</li>
</ul>
<p>Each alternative of a <code>switch</code> statement must exit the <code>switch</code> statement via a <code>break</code> or other control transfer statement.
"Fall-through" from one switch case clause to another is not allowed.</p>
<div class="note callout">Note:
Semantically, a <code>switch</code> statement is equivalent to an "<code>if</code> cascade" that compares the value of the conditional expression against each <code>case</code> clause,</div>
<h2 id="sec.stmt.loop"><a href="#sec.stmt.loop" class="anchor">Loop Statements</a></h2>
<p>A <dfn>loop statement</dfn> executes a body statement one or more times.</p>
<h3 id="sec.stmt.for"><a href="#sec.stmt.for" class="anchor">For Statement</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ForStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>for</code> <code>(</code> <span class="grammar"><span class="introducer grammar"><span class="meta">initial</span>:<span class="meta">Statement</span></span></span>? <code>;</code> <span class="grammar"><span class="introducer grammar"><span class="meta">conditional</span>:<span class="meta">Expression</span></span></span>? <code>;</code> <span class="grammar"><span class="introducer grammar"><span class="meta">sideEffect</span>:<span class="meta">Expression</span></span></span>? <code>)</code> <span class="introducer grammar"><span class="meta">body</span>:<span class="meta">Statement</span></span></span></span></div>
</pre>
</div>
<pre><code class="language-.checking">GIVEN init checks in c
GIVEN cond checks against `Bool` in c
GIVEN iter synthesizes type t in c
GIVEN body checks in c
THEN `for(init;cond;iter) body` checks in c
</code></pre>
<div class="issue callout">Issue: The checking judgements above aren't complete because they don't handle the case where <a><var class="meta">cond</var></a> is absent, in which case it should be treated like it was <code>true</code>.</div>
<h3 id="sec.stmt.while"><a href="#sec.stmt.while" class="anchor">While Statement</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">WhileStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>while</code> <code>(</code> <span class="introducer grammar"><span class="meta">conditional</span>:<span class="meta">Expression</span></span> <code>)</code> <span class="introducer grammar"><span class="meta">body</span>:<span class="meta">Statement</span></span></span></span></div>
</pre>
</div>
<pre><code class="language-.checking">GIVEN cond checks against `Bool` in c
GIVEN body checks in c
THEN `while(cond) body` checks in c
</code></pre>
<h3 id="sec.stmt.do-while"><a href="#sec.stmt.do-while" class="anchor">Do-While Statement</a></h3>
<p>A do-while statement uses the following form:</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">DoWhileStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>do</code> <span class="introducer grammar"><span class="meta">body</span>:<span class="meta">Statement</span></span> <code>while</code> <code>(</code> <span class="introducer grammar"><span class="meta">conditional</span>:<span class="meta">Expression</span></span> <code>)</code> <code>;</code></span></span></div>
</pre>
</div>
<pre><code class="language-.checking">GIVEN body checks in c
GIVEN cond checks againt `Bool` in c
THEN `do body while(cond);` checks in c
</code></pre>
<div class="issue callout">Issue: These simplified prose checking rules are leaving out all the subtlties of sub-contexts, etc.</div>
<h2 id="sec.stmt.control"><a href="#sec.stmt.control" class="anchor">Control Transfer Statements</a></h2>
<h3 id="sec.stmt.break"><a href="#sec.stmt.break" class="anchor"><code>break</code>Statement</a></h3>
<p>A <dfn>break statement</dfn> is used to transfer control out of the context of some enclosing statement.
A <a>break statement</a> may optionally provide a <dfn>label</dfn>, to identify the enclosing statement.</p>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">BreakStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>break</code> <span class="grammar"><span class="introducer grammar"><span class="meta">label</span>:<span class="meta">Identifier</span></span></span>? <code>;</code></span></span></div>
</pre>
</div>
<p>A <a>break statement</a> without a <a>label</a> transfers control to after the end of the closest lexically enclosing <a>switch statement</a> or <a>loop statement</a>.</p>
<p>A <a>break statement</a> with a <a>label</a> transfers control to after the end of the lexically enclosing <a>switch statement</a> or <a>loop statement</a> labeled with a matching <a>label</a>.</p>
<pre><code class="language-.checking">GIVEN context c
GIVEN lookup of BREAK_LABEL in c yields label l
THEN `break;` checks in context c

GIVEN context c, label l
GIVEN c contains an entry of the form BREAK_LABEL = l
THEN `break l;` checks in context c
</code></pre>
<p><div class=issue>
Issue: The checking rules for <code>break</code>-able statements should add a suitable item to the context used for checking their body statements, which will be matched by the rules above.</p>
<p>We also need to define the context-containment rule that is being used to look up the <code>break</code> item in the context.
</div></p>
<h3 id="sec.stmt.continue"><a href="#sec.stmt.continue" class="anchor">Continue Statement</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ContinueStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>continue</code> <span class="grammar"><span class="introducer grammar"><span class="meta">label</span>:<span class="meta">Identifier</span></span></span>? <code>;</code></span></span></div>
</pre>
</div>
<p>A <code>continue</code> statement transfers control to the start of the next iteration of a loop statement.
In a <code>for</code> statement with a side effect expression, the side effect expression is evaluated when <code>continue</code> is used:</p>
<pre><code class="language-.checking">GIVEN context c
GIVEN lookup of CONTINUE_LABEL in c yields label l
THEN `continue;` checks in context c

GIVEN context c, label l
GIVEN c contains an entry of the form CONTINUE_LABEL = l
THEN `continue l;` checks in context c
</code></pre>
<h3 id="sec.stmt.return"><a href="#sec.stmt.return" class="anchor">Return Statement</a></h3>
<p>A <code>return</code> statement transfers control out of the current function.</p>
<pre><code class="language-">	
</code></pre>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ReturnStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>return</code> <span class="grammar"><span class="meta">Expression</span></span>? <code>;</code></span></span></div>
</pre>
</div>
<pre><code class="language-.checking">GIVEN context c, expression e
GIVEN lookup of RESULT_TYPE in c yields type t
GIVEN e checks against t in c
THEN `return e;` checks in c
</code></pre>
<pre><code class="language-.checking">GIVEN context c
GIVEN lookup of RESULT_TYPE in c yield type t
GIVEN `Unit` is a subtype of t
THEN `return;` checks in c
</code></pre>
<div class="note callout">Note: A <code>return</code> statement without an expression is equivalent to a <code>return</code> of a value of type <code>Unit</code>.</div>
<h3 id="sec.stmt.discard"><a href="#sec.stmt.discard" class="anchor">Discard Statement</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">DiscardStatement</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>discard</code> <code>;</code></span></span></div>
</pre>
</div>
<p>A <code>discard</code> statement may only be used in the context of a fragment shader, in which case it causes the current invocation to terminate and the graphics system to discard the corresponding fragment so that it does not get combined with the framebuffer pixel at its coordinates.</p>
<p>Operations with side effects that were executed by the invocation before a <code>discard</code> will still be performed and their results will become visible according to the rules of the platform.</p>
<pre><code class="language-.checking">GIVEN context c
GIVEN capability `fragment` is available in c
THEN `discard;` checks in c
</code></pre>
<div class="issue callout">Issue:
The intent of the above rule is that checking a <code>discard</code> statement will add the <code>fragment</code> capability to the context, so that it can be checked against the capabilities of the surrounding function/context.
However, the way the other statement rules handle the context, they do not allow for anything in the context to flow upward/outward in that fashion.
It may be simplest to have the process of collecting the capabilities required by a function body be a different judgement than the type checking rules.</div>
<h1 id="sec.expr"><a href="#sec.expr" class="anchor">Expressions</a></h1>
<p><dfn>Expressions</dfn> are terms that can be <dfn>evaluated</dfn> to produce values.
This section provides a list of the kinds of expressions that may be used in a Slang program.</p>
<div class="issue callout"><h6>Issue</h6>
<p>We need a place to define a <dfn>term</dfn> and note how it can be either an expression or a <dfn>type expression</dfn>.</p>
<p>A <dfn>specialize expression</dfn> might occur in either the expression or type expression grammar.</p>
</div>
<p>In general, the order of evaluation of a Slang expression proceeds from left to right.
Where specific expressions do not follow this order of evaluation, it will be noted.</p>
<p>Some expressions can yield <dfn>l-values</dfn>, which allows them to be used on the left-hand-side of assignment, or as arguments for <code>out</code> or <code>in out</code> parameters.</p>
<h2 id="sec.expr.lit"><a href="#sec.expr.lit" class="anchor">Literal Expressions</a></h2>
<p>Literal expressions are never l-values.</p>
<h3 id="sec.expr.lit.int"><a href="#sec.expr.lit.int" class="anchor">Integer Literal Expressions</a></h3>
<p>An integer literal expression consists of a single IntegerLiteral token.</p>
<pre><code class="language-.checking">	\DerivationRule{
		\begin{trgather}
        \CheckConforms{\ContextVarA,\alpha}{\alpha}{`IFromIntegerLiteral`}{\ContextVarB}
		\end{trgather}	
	}{
		\SynthExpr{\ContextVarA}{i}{\alpha}{\ContextVarB}
	}
</code></pre>
<p>To check an unsuffixed integer literal <a><var class="meta">lit</var></a> against type <a><var class="meta">T</var></a>:</p>
<ul><li><p>Validate that <a><var class="meta">T</var></a> conforms to <code>IFromIntegerLiteral</code>, yielding conformance witness <code>w</code></p>
</li>
<li><p>Let <a><var class="meta">f</var></a> be a declaration reference to <code>IFromIntegerLiteral.init</code> looked up through <code>w</code></p>
</li>
<li><p>Return the checked expression <code><a><var class="meta">f</var></a> ( <a><var class="meta">lit</var></a> ) : <a><var class="meta">T</var></a></code></p>
</li>
</ul>
<div class="issue callout">Issue: We need a description of how suffixed integer literals have their type derived from their suffix.</div>
<h3 id="sec.expr.lit.float"><a href="#sec.expr.lit.float" class="anchor">Floating-Point Literal Expressions</a></h3>
<p>A floating-point literal expression consists of a single FloatingPointLiteral token.</p>
<pre><code class="language-.checking">	\DerivationRule{
		\begin{trgather}
        \CheckConforms{\ContextVarA,\alpha}{\alpha}{`IFromFloatingPointLiteral`}{\ContextVarB}
		\end{trgather}	
	}{
		\SynthExpr{\ContextVarA}{f}{\alpha}{\ContextVarB}
	}
</code></pre>
<div class="note callout">Note:
An unsuffixed floating-point literal synthesizes a type that is a fresh type variable $\alpha$, constrained to conform to <code>IFromFloatingPointLiteral</code>.</div>
<div class="issue callout">Issue: We need a description of how suffixed floating-point literals have their type derived from their suffix.</div>
<pre><code class="language-">
</code></pre>
<h3 id="sec.expr.lit.bool"><a href="#sec.expr.lit.bool" class="anchor">Boolean Literal Expressions</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">BooleanLiteralExpression</span></dfn>
⇒ <span class="alternative grammar"><code>true</code></span>
⇒ <span class="alternative grammar"><code>false</code></span></div>
</pre>
</div>
<p>A boolean literal expression <a><var class="meta">b</var></a> synthesizes the checked expression <code><a><var class="meta">b</var></a> : @Constant Bool</code>.</p>
<h3 id="sec.expr.lit.string"><a href="#sec.expr.lit.string" class="anchor">String Literal Expressions</a></h3>
<div class="note callout">Note:
A string literal expressions consists of one or more string literal tokens in a row.</div>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">StringLiteralExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="grammar"><span class="meta">StringLiteral</span></span>+</span></div>
</pre>
</div>
<p>A string literal expression <a><var class="meta">s</var></a> synthesizes the checked expression <code><a><var class="meta">s</var></a> : @Constant String</code>.</p>
<h2 id="sec.expr.ident"><a href="#sec.expr.ident" class="anchor">Identifier Expressions</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">IdentifierExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Identifier</span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>operator</code> <span class="meta">InfixOperator</span></span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>operator</code> <code>prefix</code> <span class="meta">PrefixOperator</span></span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>operator</code> <code>postfix</code> <span class="meta">PostfixOperator</span></span></span></div>
</pre>
</div>
<p>An identifier expression <a><var class="meta">id</var></a> synthesizes <a><var class="meta">e</var></a> if lookup of <a><var class="meta">id</var></a> yields <a><var class="meta">e</var></a>.</p>
<div class="issue callout">Issue: This presentation delegates the actual semantics of identifier expressions to the lookup judgement, which needs to be explained in detail.</div>
<h2 id="sec.expr.member"><a href="#sec.expr.member" class="anchor">Member Expression</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">MemberExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Expression</span> <code>.</code> <span class="meta">Identifier</span></span></span></div>
</pre>
</div>
<div class="issue callout"><h6>Issue</h6>
<p>The semantics of member lookup are similar in complexity to identifier lookup (and indeed the two share a lot of the same machinery).
In addition to all the complications of ordinary name lookup (including overloading), member expressions also need to deal with:</p>
<ul><li><p>Implicit dereference of pointer-like types.</p>
</li>
<li><p>Swizzles (vector or matrix).</p>
</li>
<li><p>Static vs. instance members.</p>
</li>
</ul>
<p>In both synthesis and checking modes, the base expression should first synthesize a type, and then lookup of the member should be based on that type.</p>
</div>
<p><!--
%\begin{verbatim}
%When <code>base</code> is a structure type, this expression looks up the field or other %member named by <code>m</code>.
%Just as for an identifier expression, the result of a member expression may be %overloaded, and might be disambiguated based on how it is used.
%
%A member expression is an l-value if the base expression is an l-value and the %member it refers to is mutable.
%
% ### Implicit Dereference ### {dereference.implicit}
%
%If the base expression of a member reference is a <a><var class="meta">pointer-like type</var></a> such as %<code>ConstantBuffer<T></code>, then a member reference expression will implicitly %dereference the base expression to refer to the pointed-to value (e.g., in the %case of <code>ConstantBuffer<T></code> this is the buffer contents of type <code>T</code>).
%
% ### Vector Swizzles ### {swizzle.vector}
%
%When the base expression of a member expression is of a vector type <code>vector<T,N></code> %then a member expression is a <a><var class="meta">vector swizzle expression</var></a>.
%The member name must conform to these constraints:
%
%* The member name must comprise between one and four ASCII characters
%* The characters must be come either from the set (<code>x</code>, <code>y</code>, <code>z</code>, <code>w</code>) or (<code>r</code>, %<code>g</code>, <code>b</code>, <code>a</code>), corresponding to element indics of (0, 1, 2, 3)
%* The element index corresponding to each character must be less than <code>N</code>
%
%If the member name of a swizzle consists of a single character, then the %expression has type <code>T</code> and is equivalent to a subscript expression with the %corresponding element index.
%
%If the member name of a swizzle consists of <code>M</code> characters, then the result is a %<code>vector<T,M></code> built from the elements of the base vector with the corresponding %indices.
%
%A vector swizzle expression is an l-value if the base expression was an l-value %and the list of indices corresponding to the characeters of the member name %contains no duplicates.
%
% ### Matrix Swizzles ### {swizzle.matrix}
%
%> Note: The Slang implementation currently doesn't support matrix swizzles.
%
% ### Static Member Expressions ### {member.static}
%
%When the base expression of a member expression is a type instead of a value, the %result is a <a><var class="meta">static member expression</var></a>.
%A static member expression can refer to a static field or static method of a %structure type.
%A static member expression can also refer to a case of an enumeration type.
%
%A static member expression (but not a member expression in general) may use the %token <code>::</code> instead of <code>.</code> to separate the base and member name:
%
%<code>hlsl %// These are equivalent %Color.Red %Color::Red %</code>
%\end{verbatim}
--></p>
<h2 id="sec.expr.this"><a href="#sec.expr.this" class="anchor">This Expression</a></h2>
<h3 id="section-syntax"><a href="#section-syntax" class="anchor">Syntax</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ThisExpression</span></dfn>
⇒ <span class="alternative grammar"><code>this</code></span></div>
</pre>
</div>
<h3 id="section-static-semantics"><a href="#section-static-semantics" class="anchor">Static Semantics</a></h3>
<p>A <code>this</code> expression synthesizes <a><var class="meta">e</var></a> if lookup of <code>this</code> yields <a><var class="meta">e</var></a>.</p>
<h2 id="sec.expr.paren"><a href="#sec.expr.paren" class="anchor">Parenthesized Expression</a></h2>
<h3 id="section-syntax"><a href="#section-syntax" class="anchor">Syntax</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ParenthesizedExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>(</code> <span class="meta">Expression</span> <code>)</code></span></span></div>
</pre>
</div>
<h3 id="section-static-semantics"><a href="#section-static-semantics" class="anchor">Static Semantics</a></h3>
<p>The parenthesized expression <code>( <a><var class="meta">e</var></a> )</code> synthesizes <a><var class="meta">s</var></a> if <a><var class="meta">e</var></a> synthesizes <a><var class="meta">s</var></a>.</p>
<h2 id="sec.expr.call"><a href="#sec.expr.call" class="anchor">Call Expression</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">CallExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Expression</span> <code>(</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">Argument</span> <code>,</code></span></span>)</span>* <code>)</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">Argument</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Expression</span></span>
⇒ <span class="alternative grammar"><span class="meta">NamedArgument</span></span></div>
<div class="grammar production"><dfn><span class="meta">NamedArgument</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Identifier</span> <code>:</code> <span class="meta">Expression</span></span></span></div>
</pre>
</div>
<p>The call expression <code><a><var class="meta">f</var></a> ( <a><var class="meta">args</var></a> )</code> synthesizes <a><var class="meta">scall</var></a> if:</p>
<ul><li><p><a><var class="meta">f</var></a> synthesizes <a><var class="meta">sf</var></a></p>
</li>
<li><p>The <a><var class="meta">args</var></a> synthesize <a><var class="meta">sargs</var></a></p>
</li>
<li><p>Invocation of <a><var class="meta">sf</var></a> on <a><var class="meta">sargs</var></a> synthesizes <a><var class="meta">scall</var></a></p>
</li>
</ul>
<h2 id="sec.expr.subscript"><a href="#sec.expr.subscript" class="anchor">Subscript Expression</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">SubscriptExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Expression</span> <code>[</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">Argument</span> <code>,</code></span></span>)</span>* <code>]</code></span></span></div>
</pre>
</div>
<p>The subscript expression <code><a><var class="meta">base</var></a> [ <a><var class="meta">args</var></a> ]</code> synthesizes <a><var class="meta">scall</var></a> if:</p>
<ul><li><p><a><var class="meta">base</var></a> synthesizes <a><var class="meta">sbase</var></a></p>
</li>
<li><p>The <a><var class="meta">args</var></a> synthesize <a><var class="meta">sargs</var></a></p>
</li>
<li><p>Member lookup of <code>subscript</code> in <a><var class="meta">base</var></a> synthesizes <a><var class="meta">ssub</var></a></p>
</li>
<li><p>Invocation of <a><var class="meta">ssub</var></a> on <a><var class="meta">sargs</var></a> synthesizes <a><var class="meta">scall</var></a></p>
</li>
</ul>
<h2 id="sec.expr.init-list"><a href="#sec.expr.init-list" class="anchor">Initializer List Expression</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">InitializerListExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>{</code> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><span class="meta">Argument</span> <code>,</code></span></span>)</span>* <code>}</code></span></span></div>
</pre>
</div>
<p>The initializer-list expression <code>{ <a><var class="meta">args</var></a> }</code> synthesizes <code>{ <a><var class="meta">sargs</var></a> }</code> if:</p>
<ul><li><p>The <a><var class="meta">args</var></a> synthesize <a><var class="meta">sargs</var></a></p>
</li>
</ul>
<p>The initializer-list expression <code>{ <a><var class="meta">args</var></a> }</code> checks against <a><var class="meta">t</var></a> if:</p>
<ul><li><p>Invocation of <a><var class="meta">t</var></a> on <a><var class="meta">args</var></a> checks against <a><var class="meta">t</var></a></p>
</li>
</ul>
<h2 id="sec.expr.cast"><a href="#sec.expr.cast" class="anchor">Cast Expression</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">CastExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>(</code> <span class="meta">TypeExpression</span> <code>)</code> <span class="meta">Expression</span></span></span></div>
</pre>
</div>
<p>A <a>cast expression</a> <code>( <a><var class="meta">typeExp</var></a> ) <a><var class="meta">exp</var></a></code> synthesizes <a><var class="meta">synExp</var></a> if:</p>
<ul><li><p>checking <a><var class="meta">typeExp</var></a> against <code>TYPE</code> yields <a><var class="meta">type</var></a></p>
</li>
<li><p>explicitly converting <a><var class="meta">exp</var></a> to <a><var class="meta">type</var></a> yields <a><var class="meta">synExp</var></a></p>
</li>
</ul>
<h3 id="sec.expr.cast.compatiblity"><a href="#sec.expr.cast.compatiblity" class="anchor">Legacy: Compatibility Feature</a></h3>
<p>As a compatiblity feature for older code, Slang supports using a cast where the base expression is an integer literal zero and the target type is a user-defined structure type:</p>
<pre><code class="language-">MyStruct s = (MyStruct) 0;    
</code></pre>
<p>The semantics of such a cast are equivalent to initialization from an empty initializer list:</p>
<pre><code class="language-">MyStruct s = {};
</code></pre>
<h2 id="sec.expr.assign"><a href="#sec.expr.assign" class="anchor">Assignment Expression</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">AssignmentExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="introducer grammar"><span class="meta">destination</span>:<span class="meta">Expression</span></span> <code>=</code> <span class="introducer grammar"><span class="meta">source</span>:<span class="meta">Expression</span></span></span></span></div>
</pre>
</div>
<p>Checking an assignment expression <code><a><var class="meta">dst</var></a> = <a><var class="meta">src</var></a></code> against type <a><var class="meta">t</var></a> yields <code><a><var class="meta">checkedDst</var></a> = <a><var class="meta">checkedSrc</var></a></code> if:</p>
<ul><li><p>Checking <a><var class="meta">dst</var></a> against <code>out <a><var class="meta">t</var></a></code> yields <a><var class="meta">checkedDst</var></a></p>
</li>
<li><p>Checking <a><var class="meta">src</var></a> against <a><var class="meta">t</var></a> yields <a><var class="meta">checkedSrc</var></a></p>
</li>
</ul>
<div class="note callout">Note: Assignment does not have a synthesis rule, so an assignment in a context where an expected type is not available (the typical case) will be checked against a fresh type variable.</div>
<div class="issue callout">TODO: The above logic is missing the part where we need to actually invoke property getters/setters</div>
<h2 id="sec.expr.op"><a href="#sec.expr.op" class="anchor">Operator Expressions</a></h2>
<h3 id="sec.expr.op.prefix"><a href="#sec.expr.op.prefix" class="anchor">Prefix Operator Expressions</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">PrefixOperatorExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">PrefixOperator</span> <span class="meta">Expression</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">PrefixOperator</span></dfn>
⇒ <span class="alternative grammar"><code>+</code></span>
⇒ <span class="alternative grammar"><code>-</code></span>
⇒ <span class="alternative grammar"><code>\~</code></span>
⇒ <span class="alternative grammar"><code>!</code></span>
⇒ <span class="alternative grammar"><code>++</code></span>
⇒ <span class="alternative grammar"><code>--</code></span></div>
</pre>
</div>
<p>A prefix operator expression <a><var class="meta">op</var></a> <a><var class="meta">e</var></a> desugars into <code>operator prefix <a><var class="meta">op</var></a> ( <a><var class="meta">e</var></a> )</code>.</p>
<h2 id="sec.expr.op.postfix"><a href="#sec.expr.op.postfix" class="anchor">Postfix Operator Expressions</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">PostfixOperatorExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Expression</span> <span class="meta">PostfixOperator</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">PostfixOperator</span></dfn>
⇒ <span class="alternative grammar"><code>++</code></span>
⇒ <span class="alternative grammar"><code>--</code></span></div>
</pre>
</div>
<p>A postifx operator expression <a><var class="meta">e</var></a> <a><var class="meta">op</var></a> desugars into <code>operator postfix <a><var class="meta">op</var></a> ( <a><var class="meta">e</var></a> )</code>.</p>
<h3 id="sec.expr.op.infix"><a href="#sec.expr.op.infix" class="anchor">Infix Operator Expressions</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">InfixOperatorExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Expression</span> <span class="meta">InfixOperator</span> <span class="meta">Expression</span></span></span></div>
<div class="grammar production"><dfn><span class="meta">InfixOperator</span></dfn>
⇒ <span class="alternative grammar"><code>*</code></span>
⇒ <span class="alternative grammar"><code>/</code></span>
⇒ <span class="alternative grammar"><code>\%</code></span>
⇒ <span class="alternative grammar"><code>+</code></span>
⇒ <span class="alternative grammar"><code>-</code></span>
⇒ <span class="alternative grammar"><code><<</code></span>
⇒ <span class="alternative grammar"><code>>></code></span>
⇒ <span class="alternative grammar"><code><</code></span>
⇒ <span class="alternative grammar"><code>></code></span>
⇒ <span class="alternative grammar"><code><=</code></span>
⇒ <span class="alternative grammar"><code>>=</code></span>
⇒ <span class="alternative grammar"><code>==</code></span>
⇒ <span class="alternative grammar"><code>!=</code></span>
⇒ <span class="alternative grammar"><code>&</code></span>
⇒ <span class="alternative grammar"><code>^</code></span>
⇒ <span class="alternative grammar"><code>|</code></span>
⇒ <span class="alternative grammar"><code>&&</code></span>
⇒ <span class="alternative grammar"><code>||</code></span>
⇒ <span class="alternative grammar"><code>+=</code></span>
⇒ <span class="alternative grammar"><code>-=</code></span>
⇒ <span class="alternative grammar"><code>*=</code></span>
⇒ <span class="alternative grammar"><code>/=</code></span>
⇒ <span class="alternative grammar"><code>\%=</code></span>
⇒ <span class="alternative grammar"><code><<=</code></span>
⇒ <span class="alternative grammar"><code>>>=</code></span>
⇒ <span class="alternative grammar"><code>&=</code></span>
⇒ <span class="alternative grammar"><code>\|=</code></span>
⇒ <span class="alternative grammar"><code>^=</code></span>
⇒ <span class="alternative grammar"><code>=</code></span>
⇒ <span class="alternative grammar"><code>,</code></span></div>
</pre>
</div>
<p>%TODO: need to get the precedence groups from this table into the grammar rules.
%
%| Operator 	| Kind        | Description |
%|-----------|-------------|-------------|
%| <code>*</code>		| Multiplicative 	| multiplication |
%| <code>/</code>		| Multiplicative 	| division |
%| <code>%</code>		| Multiplicative 	| remainder of division |
%| <code>+</code>		| Additive 			| addition |
%| <code>-</code>		| Additive 			| subtraction |
%| <code><<</code>		| Shift 			| left shift |
%| <code>>></code>		| Shift 			| right shift |
%| <code><</code> 		| Relational 		| less than |
%| <code>></code>		| Relational 		| greater than |
%| <code><=</code>		| Relational 		| less than or equal to |
%| <code>>=</code>		| Relational 		| greater than or equal to |
%| <code>==</code>		| Equality 			| equal to |
%| <code>!=</code>		| Equality 			| not equal to |
%| <code>&</code>		| BitAnd 			| bitwise and |
%| <code>^</code>		| BitXor			| bitwise exclusive or |
%| <code>\|</code>		| BitOr 			| bitwise or |
%| <code>&&</code>		| And 				| logical and |
%| <code>\|\|</code>	| Or 				| logical or |
%| <code>+=</code>		| Assignment  		| compound add/assign |
%| <code>-=</code>      | Assignment  		| compound subtract/assign |
%| <code>*=</code>      | Assignment  		| compound multiply/assign |
%| <code>/=</code>      | Assignment  		| compound divide/assign |
%| <code>%=</code>      | Assignment  		| compound remainder/assign |
%| <code><<=</code>     | Assignment  		| compound left shift/assign |
%| <code>>>=</code>     | Assignment  		| compound right shift/assign |
%| <code>&=</code>      | Assignment  		| compound bitwise and/assign |
%| <code>\|=</code>     | Assignment  		| compound bitwise or/assign |
%| <code>^=</code>      | Assignment  		| compound bitwise xor/assign |
%| <code>=</code>       | Assignment  		| assignment |
%| <code>,</code>		| Sequencing  		| sequence |</p>
<p>An infix operator expression <a><var class="meta">left</var></a> <a><var class="meta">op</var></a> <a><var class="meta">right</var></a> desugars into <code>operator <a><var class="meta">op</var></a> ( <a><var class="meta">left</var></a> , <a><var class="meta">right</var></a> )</code>.</p>
<div class="issue callout">TODO: The above rule implies incorrect handling of the short-circuiting <code>&&</code> and <code>||</code> operators.</div>
<h3 id="sec.expr.op.cond"><a href="#sec.expr.op.cond" class="anchor">Conditional Expression</a></h3>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">ConditionalExpression</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="introducer grammar"><span class="meta">condition</span>:<span class="meta">Expression</span></span> <code>?</code> <span class="introducer grammar"><span class="meta">then</span>:<span class="meta">Expression</span></span> <code>:</code> <span class="introducer grammar"><span class="meta">else</span>:<span class="meta">Expression</span></span></span></span></div>
</pre>
</div>
<p>A conditional expression <code><a><var class="meta">c</var></a> ? <a><var class="meta">t</var></a> : <a><var class="meta">e</var></a></code> checks against expected type <a><var class="meta">T</var></a> if:</p>
<ul><li><p><a><var class="meta">c</var></a> checks against <code>Bool</code></p>
</li>
<li><p><a><var class="meta">t</var></a> checks against <a><var class="meta">T</var></a></p>
</li>
<li><p><a><var class="meta">e</var></a> checks against <a><var class="meta">T</var></a></p>
</li>
</ul>
<h1 id="sec.mod"><a href="#sec.mod" class="anchor">Modifiers</a></h1>
<div class="issue callout">Issue: This chapter needs to list the built-in attributes that impact the language semantics, and also to specify the rules for how user-define attributes are defined and used.</div>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Modifier</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">Attribute</span></span>
⇒ <span class="alternative grammar"><span class="meta">KeywordModifier</span></span>
⇒ <span class="alternative grammar"><span class="meta">SuffixModifier</span></span></div>
</pre>
</div>
<h2 id="sec.mod.attr"><a href="#sec.mod.attr" class="anchor">Attributes</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">Attribute</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>[</code> <span class="meta">AttributeName</span> <span class="grammar"><span class="meta">AttributeArguments</span></span>? <code>]</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">AttributeName</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><span class="meta">Identifier</span> <span class="grammar">(<span class="grammar"><span class="sequence grammar"><code>.</code> <span class="meta">Identifier</span></span></span>)</span>*</span></span></div>
<div class="grammar production"><dfn><span class="meta">AttributeArguments</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>(</code> <span class="grammar"><span class="meta">Argument</span></span>* <code>)</code></span></span></div>
</pre>
</div>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">KeywordModifier</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">TypeModifier</span></span>
⇒ <span class="alternative grammar"><span class="meta">InterpolationModifier</span></span>
⇒ <span class="alternative grammar"><span class="block-comment grammar">/* ... */</span></span></div>
</pre>
</div>
<h2 id="sec.mod.semantic"><a href="#sec.mod.semantic" class="anchor">Semantics</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">SuffixModifier</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>:</code> <span class="meta">Semantic</span></span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>:</code> <span class="meta">PackOffset</span></span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>:</code> <span class="meta">Register</span></span></span>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>:</code> <span class="meta">BitFieldWidth</span></span></span></div>
</pre>
</div>
<h2 id="section-interpolation-control"><a href="#section-interpolation-control" class="anchor">Interpolation Control</a></h2>
<p>An <dfn>interpolation mode modifier</dfn> is one of:</p>
<table><tr><th>Modifier</th>
<th>Description</th>
</tr>
<tr><td><code>linear</code> (default)</td>
<td>linear interpolation</td>
</tr>
<tr><td><code>nointerpolation</code></td>
<td>constant interpolation</td>
</tr>
</table>
<p>Any <a>interpolation mode modifier</a> conflicts with any other <a>interpolation mode modifier</a>.</p>
<p>A <dfn>perspective correction modifier</dfn> is one of:</p>
<table><tr><th>Modifier</th>
<th>Description</th>
</tr>
<tr><td><code>noperspective</code></td>
<td>perspective-correction disabled</td>
</tr>
<tr><td>none (default)</td>
<td>perspective-correction enabled</td>
</tr>
</table>
<p>The <code>nointeroplation</code> modifier conflicts with any <a>perspective correction modifier</a>.</p>
<p>An <dfn>interpolation location modifier</dfn> is one of:</p>
<table><tr><th>Modifier</th>
<th>Description</th>
</tr>
<tr><td><code>centroid</code></td>
<td>interpolate at centroid of a fragment's samples</td>
</tr>
<tr><td><code>sample</code></td>
<td>interpolate at each of a fragment's samples</td>
</tr>
<tr><td>none (default)</td>
<td>interpolate at one of fragment's samples</td>
</tr>
</table>
<p>The <code>nointeroplation</code> modifier conflicts with any <a>interpolation location modifier</a>.</p>
<h2 id="section-geometry-shader-input-primitive-type"><a href="#section-geometry-shader-input-primitive-type" class="anchor">Geometry Shader Input Primitive Type</a></h2>
<p>A <dfn>geometry shader input primitive type modifier</dfn> is one of:</p>
<table><tr><th>Modifier</th>
<th>Description</th>
</tr>
<tr><td><code>point</code></td>
<td>...</td>
</tr>
<tr><td><code>line</code></td>
<td>...</td>
</tr>
<tr><td><code>lineadj</code></td>
<td>...</td>
</tr>
<tr><td><code>triangle</code></td>
<td>...</td>
</tr>
<tr><td><code>triangleadj</code></td>
<td>...</td>
</tr>
</table>
<h2 id="section-matrix-layout-control"><a href="#section-matrix-layout-control" class="anchor">Matrix Layout Control</a></h2>
<p>A <dfn>matrix layout modifier</dfn> is one of:</p>
<table><tr><th>Modifier</th>
<th>Description</th>
</tr>
<tr><td><code>row_major</code></td>
<td><a>row-major</a> layout</td>
</tr>
<tr><td><code>column_major</code></td>
<td><a>column-major</a> layout</td>
</tr>
</table>
<h2 id="section-format-control"><a href="#section-format-control" class="anchor">Format Control</a></h2>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">TypeModifier</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">FormatModifier</span></span>
⇒ <span class="alternative grammar"><span class="meta">MatrixLayoutModifier</span></span>
⇒ <span class="alternative grammar"><code>const</code></span></div>
</pre>
</div>
<div class="syntax grammar callout"><pre class="lexical grammar"><div class="grammar production"><dfn><span class="meta">FormatModifier</span></dfn>
⇒ <span class="alternative grammar"><code>unorm</code></span>
⇒ <span class="alternative grammar"><code>snorm</code></span></div>
</pre>
</div>
<h2 id="section-fodder"><a href="#section-fodder" class="anchor">Fodder</a></h2>
<pre><code class="language-">
// Tessellation
[domain]
[maxtessfactor]
[outputcontrolpoints] // HS output control point count
[outputtopology] // (HS) tessellator output topology
[partitioning] // (HS) partitioning scheme
[patchconstantfunc] // HS "patch-constant function"

// Geometry
[instance]
[maxvertexcount]


// Fragment
[earlydepthstencil]

// Compute
[numthreads]
groupshared

// Legacy
shared

// Mesh Shader
indices
vertices
primitives

// General
[shader]
[allow_uav_condition]
globallycoherent
[branch]
[call]
[fastopt]
[flatten]
[forcecase]
[loop]
[unroll]
[clipplanes] // not supported (?)
[RootSignature] // not supported (?)
precise
uniform
export

// TODO:
payload
rapayload
wavesensitive
wavesize
waveopsincludehelperlanes

[nodelaunch(LaunchType)]

</code></pre>
<h1 id="sec.vis"><a href="#sec.vis" class="anchor">Visibility Control</a></h1>
<p><div class=issue>
This chapter needs to explain the rules for:</p>
<ul><li><p>What declarations in a module are visible to modules that <code>import</code> it?</p>
</li>
<li><p>What are the modifiers that can be used to control visibility (<code>public</code>, <code>internal</code>, <code>private</code>), and what are their semantics.</p>
</li>
<li><p>What is the inferred visibility of a declaration without an explicit modifier?</p>
</li>
<li><p>What are the rules about what modifiers are legal in what contexts?</p>
<ul><li><p>E.g., a <code>public</code> field should not be allowed in an <code>internal</code> type.</p>
</li>
<li><p>E.g., a <code>public</code> function should not be allowed to have a non-<code>public</code> type used in its signature.</p>
</li>
</ul>
</li>
<li><p>How is visibility controlled for interface conformances?</p>
</li>
</ul>
<p></div></p>
<h1 id="sec.linearization"><a href="#sec.linearization" class="anchor">Type Linearization</a></h1>
<div class="issue callout"><h6>Issue</h6>
<p>This chapter needs to explain how, given a type, an implementation should derive the \emph{linearization} of that type into an ordered list of \emph{facets}.
Each facet corresponds to some DeclBody, and thus has a set of declarations in it that may bind certain names.</p>
<p>The linearization of a type should include:</p>
<ul><li><p>A facet for the type itself, which will include the declarations explicitly written inside the body of that type's DeclBody.</p>
</li>
<li><p>One facet for each transitive base of the type, including both concrete types it inherits from and <code>interface</code>s it conforms to.</p>
</li>
<li><p>One facet for each <code>extension</code> that is both visible in the context where linearization is being performed \emph{and} applicable to the type.</p>
</li>
</ul>
<p>Note that base facets are included even for bases that are introduced via an <code>extension</code>.
Similarly, extension facets are included for extensions that might apply to the type through one of its bases.</p>
<p>The set of facets for a type will always be a subset of those for each of its bases.</p>
<p>The order of facets is significant, because it affects the relative priority of the bindings in those facets for lookup.
In the simplest terms, facets earlier in the list will be prioritized over those later in the list.
Thus, derived types should always appear before their bases.
In general, facets for extensions should appear after the facet for the type declaration that the extension applies to.</p>
<p>(It is possible that a simple \emph{sequence} of facets will not actually be sufficient, and a DAG representation might be needed, if forcing a total ordering on facets would risk > unintuitive lookup results)</p>
<p>There is good precedent in the PL world for this kind of linearization, which is sometimes referred to as the \emph{method resolution order} (MRO).
A particular solution, known as the \emph{C3 linearization algorithm} is often recommended as the one to use, and it is what the Slang compiler currently implements.</p>
</div>
<h1 id="sec.SECTION.interface"><a href="#sec.SECTION.interface" class="anchor">Interfaces</a></h1>
<p><div class=issue>
This chapter needs to document the rules for what it means for a type to \emph{conform} to an interface, and how the compiler should check for conformance.</p>
<p>The biggest challenge in specifying the rules for conformance is that the Slang compiler does not require an \emph{exact} match between the requirement in an <code>interface</code> and the concrete declaration that satisfies it:</p>
<ul><li><p>A field can satisfy a <code>property</code> requirement.</p>
</li>
<li><p>A non-<code>throws</code> function can satisfy a <code>throws</code> requirement</p>
</li>
<li><p>A non-<code>[mutating]</code> function can satisfy a <code>[mutating]</code> requirement</p>
</li>
<li><p>A function with default arguments can satisfy a requirement without those arguments</p>
</li>
<li><p>A generic function may satisfy a non-generic requirement</p>
</li>
<li><p>A generic declaration with fewer constraints may satisfy a generic requirement with more constraints</p>
</li>
</ul>
<p>In the limit, we can say that a type satisfies a requirement if a \emph{synthesized} declaration that exactly matches the requirement signature would type-check successfully.
The body of a synthesized <code>get</code> accessor for a property <code>p</code> would consist of something like <code>return this.p;</code>.
Similarly, the body of a synthesized <code>func</code> for a function <code>f</code> would consist of something like <code>return this.f(a0, a1, ...);</code> where the values <code>a0</code>, etc., are the declared parameters of the synthesized function.</p>
<p>The main place where the above approach runs into wrinkles is around synthesis for generic requirements, where subtle semantic choices need to be made.</p>
<p>Ideally, checking of conformances is something that can be done after checking of all explicit function bodies (statements/expressions) in a module.
Other checking rules can \emph{assume} that a type conforms to an interface if it is declared to, knowing that the error will be caught later if it doesn't.</p>
<p>The important case where conformances can't be checked late is if we support inference (not just synthesis) of declarations to satisfy requirements.
Basically, if we want to support inference of <code>associatedtype</code>s, then only way to infer that type is by looking for the declarations that satisfy other requirements.</p>
<p>(Conveniently, checking of requirements also doesn't require looking at function bodies: only signatures)</p>
<p>This chapter is probably also the right place to define the rules for canonicalization of interface conjunctions.</p>
<p></div></p>
<h1 id="sec.section.generic"><a href="#sec.section.generic" class="anchor">Generics</a></h1>
<div class="issue callout"><h6>Issue</h6>
<p>This chapter needs to define the key semantic-checking operations that relate to generics, including:</p>
<ul><li><p>Inference of \emph{implied constraints} on a generic declaration, based on the signature of that declaration.</p>
</li>
<li><p>Validation and canonicalization of constraints on generic declarations.</p>
</li>
<li><p>Validation of explicit specialization of a generic (e.g., <code>G<A,B></code>), which includes validating that the constraints on the generic are satisfied by the parameters.</p>
</li>
<li><p>Inference of generic arguments in contexts where a generic function is called on value arguments (without first specializing it).</p>
</li>
</ul>
</div>
<h1 id="sec.lookup"><a href="#sec.lookup" class="anchor">Lookup</a></h1>
<p><div class=issue></p>
<p>This chapter needs to document the rules for how names are looked up in two cases:</p>
<ul><li><p>Looking up a standalone Identifier as an expression or type expression, we need to look up in the current context.</p>
</li>
<li><p>When looking up a name in some type, whether explicitly as part of a MemberExpression, or implicitly as part of lookup through <code>this</code> inside a type body.</p>
</li>
</ul>
<p>The first kind of lookup is easily expressed as a recursion over the structure of contexts, but will often bottleneck through lookup in the context of some type (since code is so often nested under a type).
This kind of lookup also needs to deal with <code>import</code> declarations and the visibility rules for <a>source units</a> in the same module as one another.</p>
<p>The second kind of lookup requires access to a linearization of the type.
It potentially needs to deal with performing substitutions on the type/signature of a declaration that is found, so that it is adjusted for the <code>This</code> type it has been looked up through.</p>
<p>Both kinds of lookup need to deal with the possibility that a name will be \emph{overloaded}.
At this level, lookup should probably return the full set of all \emph{candidates} when overloading occurs, but retain enough structure in the lookup results that overload resolution can evaluate which should be prioritized over the others, based (e.g., picking members from a more-derived type over those from a base type).</p>
<p>The lookup rules here should be able to handle lookup of <code>init</code>, and <code>subscript</code> declaration via a synthesized name that cannot conflict with other identifiers (in case, e.g., a user has a struct with an ordinary field named \texttt{subscript}).</p>
<p>Lookup will also need to interact with visibility, by stripping out non-<code>public</code> bindings from <code>import</code>ed modules.</p>
<p>Note that this chapter does not need to deal with <code>extension</code> declarations, as they are handled as part of type linearization.</p>
<p>One important kind of subtlety to lookup is that upon finding a \emph{first} in-scope declaration of a name, we can inspect the category of that declaration to determine if overloading is even possible.
That is, if the first declaration found is in a category of declaration that doesn't support overloading (basically anything other than a <code>func</code>, <code>init</code>, or <code>subscript</code>), then that result can be used as-is as the result of lookup.</p>
<p></div></p>
<h1 id="sec.overload"><a href="#sec.overload" class="anchor">Overload Resolution</a></h1>
<p><div class=issue>
This chapter needs to describe how to disambiguate an overloaded lookup result.
Overload resolution comes up primarily in two places:</p>
<ul><li><p>When the typing rules attempt to coerce an overloaded expression to some type.</p>
</li>
<li><p>When attempting to call an overloaded expression as a function.</p>
</li>
</ul>
<p>(Hypothetically it can also arise for a generic specialization <code>F<A,B,...></code> as well, so the rules need to be ready for that case)</p>
<p>The first of the two cases is the easier one by far, with an outline of it's semantics being:</p>
<ul><li><p>\emph{Filter} the candidates to only those that can be coerced successfully to the desired type.</p>
</li>
<li><p>Select the best candidate among the remaining ones, based on priority.</p>
<ul><li><p>The relative "distance" of declarations needs to factor in (more derived vs. more base, imported vs. local, etc.)</p>
</li>
<li><p>Additionally, the relative cost of the type conversions applied (if any) may be relevant.</p>
</li>
</ul>
</li>
</ul>
<p>The second case (overloaded calls) is superficially similar, in that we can filter the candidates to the applicable ones and then pick the best.
The definition of ``best'' for an overloaded call is more subtle and needs care to not mess up developer expectations for things like simple infix expressions (since event infix <code>operator+</code> is handled as an overloaded call, semantically).</p>
<p>A few basic principles that guide intuition:</p>
<ul><li><p>For every candidate we should know the conversion/cost associated with each argument position, as well as the conversion/cost associated with the function result position (if we are in a checking rather than synthesis context).</p>
</li>
<li><p>One overload candidate is strictly better than another if it is better at at least one position (one argument, or the function result), and not worse at any position.</p>
</li>
<li><p>When choosing between candidates that are equally good, a few factors play in:</p>
<ul><li><p>The relative "distance" of declarations (as determined by lookup)</p>
</li>
<li><p>Which candidates required defaulting of arguments (and how many)</p>
</li>
<li><p>Candidates that required implicit specialization of a generic vs. those that didn't</p>
</li>
<li><p>For two candidates that required implicit specialization of a generic, which of them is ``more general'' than the other.</p>
</li>
</ul>
</li>
</ul>
<p>Generally, a function $f$ is ``more general'' than another function $g$ if for every set of arguments that $g$ is applicable to, $f$ is also applicable, but not vice versa.</p>
<p>Also: it doesn't exactly belong in this chapter, but something needs to document the rules for when two function declarations are considered to have the same signature (or at least conflicting signatures), so that errors can be diagnosed when trying to redefine a function.</p>
<p></div></p>
<p>If:</p>
<ul><li><p><a><var class="meta">f</var></a> synthesizes function type <code>( <a><var class="meta">params</var></a> ) -> <a><var class="meta">result</var></a></code></p>
</li>
<li><p><a><var class="meta">args</var></a> matches against <a><var class="meta">params</var></a> with cost <a><var class="meta">argsCost</var></a></p>
</li>
<li><p><a><var class="meta">result</var></a> is implicitly convertible to <a><var class="meta">T</var></a> with cost <a><var class="meta">resultCost</var></a></p>
</li>
</ul>
<p>then the invocation <code><a><var class="meta">f</var></a> ( <a><var class="meta">args</var></a> )</code> checks against <a><var class="meta">T</var></a> with cost (<a><var class="meta">argsCost</var></a>, <a><var class="meta">resultCost</var></a>)</p>
<p>If:</p>
<ul><li><p><a><var class="meta">g</var></a> synthesizes generic type <code>< <a><var class="meta">genericParams</var></a> > -> <a><var class="meta">result</var></a></code></p>
</li>
<li><p><a><var class="meta">genericArgs</var></a> are fresh solver variables</p>
</li>
<li><p>the specialization <code><a><var class="meta">g</var></a> <</code> _genericArgs <code>></code> synthesizes type <a><var class="meta">specialized</var></a> with cost <a><var class="meta">specializationCost</var></a></p>
</li>
<li><p>the type `<a><var class="meta">specialized</var></a></p>
</li>
</ul>
<p>then the invocation <code><a><var class="meta">g</var></a> (</code> )</p>
<h1 id="sec.subtype"><a href="#sec.subtype" class="anchor">Subtyping</a></h1>
<p><div class=issue></p>
<p>This chapter needs to define what the subtyping rules are, as something distinct from the conversion/coercion rules (which need their own chapter).</p>
<p>At the most basic, we want to have a guarantee that if <code>T</code> is a subtype of <code>S</code>, then it is safe and meaningful to read an <code>S</code> from a memory location that holds a <code>T</code>.
Beyond that, we need to decide whether it a subtype (in the formal semantics) must have the same size and stride as the supertype, or it if is allowed to be larger.</p>
<p>The key reason to have the subtyping rules kept distinct from the conversion/coercion rules is that many built-in types (as well as the conceptual/intermediate types that are needed for semantic checking) are covariant type constructors, where the covariance must be defined in terms of true subtyping and not just convertability. E.g., a <code>borrow</code> T} can be converted to a <code>borrow</code> S} only if <code>T</code> is truly a subtype of <code>S</code>, and not just convertible to it.</p>
<p>Note that the <code>is-a-subtype-of'' relationship between two types is distinct from the </code>conforms-to'' relationship between a proper type and an interface type.
The ``conforms-to'' relationship might need to be documented in this chapter as well, just because it shares a lot of structurally similar machinery.</p>
<p>(In fact, it may be best to have a judgement that is parameterized over the type relationship that is being checked: conformance, subtyping, implicit coercion, explicit conversion.)</p>
<p></div></p>
<h1 id="sec.conv"><a href="#sec.conv" class="anchor">Type Conversions</a></h1>
<div class="issue callout"><h6>Issue</h6>
<p>Broadly this chapter needs to do two things:</p>
<ul><li><p>Define the semantic rules for implicit type coercion and explicit type conversion.</p>
</li>
<li><p>Specify the implicit coercions that are defined for the basic Slang types, and their costs.</p>
</li>
</ul>
<p>The latter part (the builtin implicit coercions and their costs) can be a simple table, once the rules are properly defined.</p>
<p>From a big-picture perspective, the implicit type coercion rules when coercing something of type <code>From</code> to type <code>To</code> are something like:</p>
<ul><li><p>If <code>From</code> and <code>To</code> are identical types, then coercion succeeds, with no cost.</p>
</li>
<li><p>If <code>From</code> is a subtype of <code>To</code>, then coercion succeeds, with a cost that relates to how "far" apart the types are in an inheritance hierarchy.</p>
</li>
<li><p>If neither of the above applies, look up <code>init</code> declarations on type <code>To</code>, filtered to those that are marked as suitable for implicit coercion, and then perfom overload resolution > to pick the best overload. The cost is the cost that was marked on the chosen <code>init</code> declaration.</p>
</li>
</ul>
<p>The overload resolution rules rely on checking implicit type coercions, and the implicit type coercion rules can end up checking an overloaded <code>init</code> call.
The specification must explain how to avoid the apparant possibility of infinite recursion.
The simplest way to avoid such problems is to specif that the overload resolution for the <code>init</code> call above uses a modified form where only subtyping, and not implicit coercion, is > allowed for arguments.</p>
<p>Explicit type conversion follows the same overall flow as the implicit case, except it does not filter the candidates down to only those marked as usable for implicit coercion.</p>
</div>
<p>To convert <a>intermediate expression</a> <a><var class="meta">fromExp</var></a> to <a>type</a> <a><var class="meta">toType</var></a>:</p>
<ul><li><p>Switch on the syntactic form of <a><var class="meta">fromExp</var></a>:</p>
<ul><li><p>Case <code>InitializerList <a><var class="meta">args</var></a></code>:</p>
<ul><li><p>Let <a><var class="meta">checkedCall</var></a> be the result of checking the invocation of <a><var class="meta">toType</var></a> on <a><var class="meta">args</var></a></p>
</li>
<li><p>Return the result of convertring <a><var class="meta">checkedCall</var></a> to <a><var class="meta">toType</var></a></p>
</li>
</ul>
</li>
<li><p>Case <code>OverloadSet <a><var class="meta">candidates</var></a></code>:</p>
<ul><li><p>Let <a><var class="meta">convertedCandidates</var></a> be the result of converting each <a><var class="meta">candidate</var></a> to <a><var class="meta">toType</var></a></p>
</li>
<li><p>Filter <a><var class="meta">convertedCandidates</var></a> to contain only the candidates with minimum cost</p>
</li>
<li><p>...</p>
</li>
</ul>
</li>
<li><p>Case <code>OverloadedCall <a><var class="meta">f</var></a> (</code> _args <code>)</code>:</p>
<ul><li><p>Let <a><var class="meta">checkedCall</var></a> be the result of checking the invocation of <a><var class="meta">f</var></a> on <a><var class="meta">args</var></a> against <a><var class="meta">toType</var></a></p>
</li>
<li><p>...</p>
</li>
</ul>
</li>
<li><p>Case a <a>checked expression</a> <a><var class="meta">checkedFromExpr</var></a> of <a>type</a> <a><var class="meta">fromType</var></a></p>
<ul><li><p>...</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="sec.exec"><a href="#sec.exec" class="anchor">Execution</a></h1>
<div class="note callout"><h6>Note</h6>
<p>This chapter concerns itself with the context in which Slang code is executed at runtime.</p>
<p>The details of the dynamic semantics of particular statement or expression forms is left to the sections that document those pieces of syntax.</p>
</div>
<h2 id="sec.exec.runtime"><a href="#sec.exec.runtime" class="anchor">Runtime Sessions</a></h2>
<p>A <dfn>runtime session</dfn> is a context for loading and execution of Slang code.</p>
<p>A <a>runtime session</a> exists within the context of a <dfn>process</dfn> running on some <dfn>host</dfn> machine.</p>
<div class="note callout"><h6>Note</h6>
<p>For some implementations, a <a>runtime session</a> may be the same as a <a>process</a>, but this is not required.</p>
</div>
<p>A <a>runtime session</a> has access to one or more distinct <dfn>devices</dfn> on which work may be performed.
Different <a>devices</a> in a <a>runtime session</a> may implement different <dfn>architectures</dfn>, each having its own machine code format(s).
For some implementations, the <a>host</a> may also be a <a>device</a>, but this is not required.</p>
<p>The state of a <a>runtime session</a> consists of:</p>
<ul><li><p>The contents of <a>memory</a>, accross all <a>address spaces</a> and <a>devices</a></p>
</li>
<li><p>The running <a>strands</a>, <a>dispatches</a>, and <a>commands</a> on each <a>device</a>, and the state of each</p>
</li>
<li><p>The state of systems and resources external to the <a>runtime session</a>, but accessible to it through calls to services of the <a>host</a> machine.</p>
</li>
</ul>
<h2 id="sec.exec.strand"><a href="#sec.exec.strand" class="anchor">Strands</a></h2>
<p>A <dfn>strand</dfn> is a logical runtime entity that executes Slang code.
The state of a strand consists of a stack of <a>invocation records</a>, representing <a>invocations</a> that the strand has entered but not yet exited.</p>
<p>A strand may be realized in different ways by different devices, runtime systems, and compilation strategies.</p>
<div class="note callout">Note: The term "strand" was chosen because a term like "thread" is both overloaded and charged.
On a typical CPU <a>architecture</a>, a strand might map to a thread, or it might map to a single SIMD lane, depending on how code is compiled.
On a typical GPU <a>architecture</a>, a strand might map to a thread, or it might map to a wave, thread block, or other granularity.</div>
<div class="note callout">Note: An implementation is allowed to "migrate" a strand from one thread to another.</div>
<p>A strand is <dfn>launched</dfn> for some <a>invocable</a> declaration <a><var class="meta">D</var></a>, with an initial stack comprising a single <a>invocation record</a> for <a><var class="meta">D</var></a>.</p>
<h2 id="sec.exec.completion"><a href="#sec.exec.completion" class="anchor">Completion Status</a></h2>
<p>A <dfn>completion status</dfn> represents the result of <a>execution</a> or <a>evaluation</a> and can be either a <dfn>normal</dfn> completion status, or an <dfn>abnormal</dfn> completion status:</p>
<div class="semantics grammar callout"><pre class="lexical grammar">
<div class="grammar production"><dfn><span class="meta">CompletionStatus</span></dfn>
⇒ <span class="alternative grammar"><span class="meta">NormalCompletionStatus</span></span>
⇒ <span class="alternative grammar"><span class="meta">AbnormalCompletionStatus</span></span></div>
<div class="grammar production"><dfn><span class="meta">NormalCompletionStatus</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>NORMAL(</code> <span class="meta">Value</span> <code>)</code></span></span></div>
<div class="grammar production"><dfn><span class="meta">AbnormalCompletionStatus</span></dfn>
⇒ <span class="alternative grammar"><span class="sequence grammar"><code>RETURN(</code> <span class="meta">Value</span> <code>)</code></span></span>
⇒ <span class="alternative grammar"><code>CONTINUE</code></span>
⇒ <span class="alternative grammar"><code>BREAK</code></span>
⇒ <span class="alternative grammar"><code>DISCARD</code></span></div>
</pre>
</div>
<div class="issue callout">TODO: Cover all possible completion statuses</div>
<h2 id="sec.exec.stmt"><a href="#sec.exec.stmt" class="anchor">Execution of Statements</a></h2>
<p><dfn>Execution</dfn> is the process by which a <a>strand</a> performs the computations indicated by a compiled Slang <a>statement</a>.
<a>Execution</a> is always performed in the context of some <a>strand</a>.
The state of that <a>strand</a>, as well as the <a>runtime session</a> the <a>strand</a> belongs to, can affect the results of <a>excutiion</a>.</p>
<p><a>Execution</a> of a statement either completes with some <a>completion status</a>, or fails to terminate.</p>
<p><a>Execution</a> of a <a>statement</a> does not yield any <a>value</a>, but may change the state of a <a>runtime session</a> by performing <a>side effects</a>, including <a>memory operations</a>.</p>
<div class="issue callout">Issue: The notion of a <a>side effect</a> needs to be specified properly somewhere.</div>
<div class="note callout">Note: <a>Execution</a> of a <a>statement</a> will often entail <a>execution</a> of sub-<a>statements</a> and <a>evaluation</a> of sub-<a>expressions</a>.</div>
<h2 id="sec.exec.eval"><a href="#sec.exec.eval" class="anchor">Evaluation of Expressions</a></h2>
<p><dfn>Evaluation</dfn> is the process by which a <a>strand</a> attempts to calculate a <a>value</a> for a compiled Slang <a>expression</a>.
<a>Execution</a> is always performed in the context of some <a>strand</a>.
The state of that <a>strand</a>, as well as the <a>runtime session</a> the <a>strand</a> belongs to, can affect the results of <a>excutiion</a>.</p>
<p><a>Evaluation</a> of an expression either completes with some <a>completion status</a>, or fails to terminate.</p>
<p>An expression <dfn>evaluates to</dfn> a <a>value</a> <a><var class="meta">v</var></a>, if <a>evaluation</a> of that <a>expression</a> completes with a <a>completion status</a> of <a><span class="meta">NORMAL(v)</span></a>.</p>
<p><a>Evaluating</a> an <a>expression</a> may also have some number of <a>side effects</a>.</p>
<div class="note callout">Note: <a>Evaluation</a> of an <a>expression</a> will often entail <a>evaluation</a> of its sub-<a>expressions</a>.</div>
<h2 id="sec.exec.invocation"><a href="#sec.exec.invocation" class="anchor">Invocation</a></h2>
<p>An <dfn>invocation</dfn> occurs when a <a>strand</a> <a>evaluates</a> a <a>call</a> to a <a>function</a> or other <a>invocable</a> entity, with zero or more <a>arguments</a>.</p>
<h3 id="sec.exec.invocation.record"><a href="#sec.exec.invocation.record" class="anchor">Invocation Records</a></h3>
<p>An <dfn>invocation record</dfn> represents the state of a single <a>invocation</a> being <a>evaluated</a> by some <a>strand</a>.
The state of an <a>invocation record</a> for <a>invocable</a> declaration <a><var class="meta">d</var></a> by strand <a><var class="meta">s</var></a> consists of:</p>
<ul><li><p>A <a>value</a> for each <a>parameter</a> of <a><var class="meta">d</var></a></p>
</li>
<li><p>The location <a><var class="meta">L</var></a> within the <a>body</a> of <a><var class="meta">d</var></a> that <a><var class="meta">s</var></a>'s execution has reached for that <a>invocation</a></p>
</li>
<li><p>A <a>value</a> for each <a>local variable</a> of <a><var class="meta">d</var></a> that is in scope at <a><var class="meta">L</var></a></p>
</li>
</ul>
<h3 id="sec.exec.invocation.eval"><a href="#sec.exec.invocation.eval" class="anchor">Evaluation of Invocations</a></h3>
<p>To <a>evaluate</a> an <a>invocation</a> of an <a>invocable</a> entity <a><var class="meta">f</var></a> with <a>arguments</a> <a><var class="meta">a0, a1, ...</var></a>, in the context of <a>strand</a> <a><var class="meta">s</var></a>:</p>
<ul><li><p>Create an <a>invocation record</a> <a><var class="meta">r</var></a> for <a><var class="meta">f</var></a></p>
</li>
<li><p>For each <a>parameter</a> <a><var class="meta">pi</var></a> of <a><var class="meta">f</var></a>:</p>
<ul><li><p>Set the corresponding <a>value</a> in <a><var class="meta">r</var></a> to the corresponding <a>argument</a> <a><var class="meta">ai</var></a></p>
</li>
</ul>
</li>
<li><p>Push <a><var class="meta">r</var></a> onto the stack of <a>invocation records</a> for <a><var class="meta">s</var></a></p>
</li>
<li><p>Let <a><var class="meta">result</var></a> be the result of <a>executing</a> the <a>body</a> of <a><var class="meta">f</var></a></p>
</li>
<li><p>Pop <a><var class="meta">r</var></a> from the the stack of <a>invocation records</a> for <a><var class="meta">s</var></a></p>
</li>
<li><p>Switch on <a><var class="meta">result</var></a>:</p>
<ul><li><p><a><span class="meta">RETURN(v)</span></a>: <a>evaluation</a> completes with <a><span class="meta">NORMAL(v)</span></a></p>
</li>
<li><p><a><span class="meta">NORMAL(v)</span></a>: <a>evaluation</a> completes with <a><span class="meta">NORMAL(UNIT())</span></a></p>
</li>
<li><p>Otherwise: <a>evaluation</a> completes with <a><var class="meta">result</var></a></p>
</li>
</ul>
</li>
</ul>
<h2 id="sec.exec.wave"><a href="#sec.exec.wave" class="anchor">Waves</a></h2>
<p>A <dfn>wave</dfn> is a set of one or more <a>strands</a> that execute concurrently.
At each point in its execution, a <a>strand</a> belongs to one and only one <a>wave</a>.</p>
<p>Waves are guaranteed to make forward progress independent of other waves.
Strands that belong to the same wave are not guaranteed to make independent forward progress.</p>
<div class="note callout">Note: A runtime system can execute the strands of a wave in "lock-step" fashion, if it chooses.</div>
<p>Strands that are <a>launched</a> to execute a <a>kernel</a> as part of a <a>dispatch</a> will only ever be in the same wave as strands that were launched as part of the same <a>dispatch</a>.</p>
<p>Every <a>wave</a> has a positive integer <dfn>wave size</dfn>.
Each strand that belongs to a <a>wave</a> with <a>wave size</a> <a><var class="meta">N</var></a> has a distinct integer <dfn>lane ID</dfn> in [0, <a><var class="meta">N</var></a>).</p>
<div class="note callout">Note: A wave with <a>wave size</a> <a><var class="meta">N</var></a> can have at most <a><var class="meta">N</var></a> strands that belong to it, but it can also have fewer.
This might occur because a partially-full wave was launched, or because strands in the wave terminated.
If strands in a wave have terminated, it is possible that there will be gaps in the sequence of used lane IDs.</div>
<p>Two strands that are launched for the same kernel for the same node of the same pipeline configuration as part of the same dispatch will belong to waves with the same wave size.</p>
<div class="note callout">Note: Wave sizes can differ across target platforms, pipeline stages, and even different optimization choices made by a compiler.</div>
<h2 id="sec.exec.uniformity"><a href="#sec.exec.uniformity" class="anchor">Uniformity</a></h2>
<h3 id="sec.exec.uniformity.collective"><a href="#sec.exec.uniformity.collective" class="anchor">Collective Operations</a></h3>
<p>A <dfn>collective</dfn> operation is one that require multiple strands to coordinate.
A <a>collective</a> operation is only guaranteed to execute correctly when the required subset of strands all <dfn>participate</dfn> in the operation together.</p>
<h3 id="sec.exec.uniformity.tangle"><a href="#sec.exec.uniformity.tangle" class="anchor">Tangles</a></h3>
<p>A <dfn>tangle</dfn> is a collection of <a>strands</a> that are conceptually executing together.
Every <a>strand</a> belongs to one and only one <a>tangle</a> at any point in its execution.
The <a>tangle</a> that a <a>strand</a> belongs to can change over the course of its execution.
When a <a>strand</a> performs a <a>collective</a> operation, it <a>participates</a> with those strands that are part of the same tangle.</p>
<h3 id="sec.exec.cfg"><a href="#sec.exec.cfg" class="anchor">Control-Flow Graphs</a></h3>
<div class="issue callout">TODO: These definitions need to live somewhere else.</div>
<p>A <dfn>control-flow graph</dfn> (or <a>CFG</a>) consists of:</p>
<ul><li><p>a set of <a>basic blocks</a>, including</p>
</li>
<li><p>a unique <a>entry block</a>, and</p>
</li>
<li><p>the <a>control-flow edges</a> between those blocks</p>
</li>
</ul>
<h4 id="sec.exec.cfg.dom"><a href="#sec.exec.cfg.dom" class="anchor">Dominance</a></h4>
<p>A <a>basic block</a> <a><var class="meta">x</var></a> dominates another <a>basic block</a> <a><var class="meta">y</var></a> in the same <a>CFG</a> if every path of <a>control-flow edges</a> from the <a>entry block</a> of the <a>CFG</a> to <a><var class="meta">y</var></a> passes through <a><var class="meta">x</var></a>.</p>
<div class="note callout">Note: By these rules, <a><var class="meta">x</var></a> <a>dominates</a> <a><var class="meta">y</var></a> if <a><var class="meta">y</var></a> is unreachable, because every oen of the (zero) paths from the <a>entry block</a> to <a><var class="meta">y</var></a> passes through <a><var class="meta">x</var></a>.</div>
<h3 id="sec.exec.uniformity.region"><a href="#sec.exec.uniformity.region" class="anchor">Control-Flow Regions</a></h3>
<p>A <dfn>control-flow region</dfn> is a pair of <a>basic blocks</a> (<a><var class="meta">entry</var></a>, <a><var class="meta">exit</var></a>) in a <a>control-flow graph</a> such that <a><var class="meta">entry</var></a> <a>dominates</a> <a><var class="meta">exit</var></a>.</p>
<p>A node <a><var class="meta">n</var></a> in a <a>control-flow graph</a> is <dfn>inside</dfn> the region (<a><var class="meta">entry</var></a>, <a><var class="meta">exit</var></a>) if:</p>
<ul><li><p><a><var class="meta">entry</var></a> dominates <a><var class="meta">n</var></a>, and</p>
</li>
<li><p><a><var class="meta">exit</var></a> does not dominate <a><var class="meta">n</var></a>.</p>
</li>
</ul>
<h4 id="sec.exec.uniformity.region.break"><a href="#sec.exec.uniformity.region.break" class="anchor">Breaking Out Of a Region</a></h4>
<p>A strand <dfn>breaks out of</dfn> a <a>control-flow region</a> (<a><var class="meta">entry</var></a>, <a><var class="meta">merge</var></a>) if it enters the region (by branching to <a><var class="meta">entry</var></a>) and then subsequently exits the region by branching to some node <a><var class="meta">n</var></a>, distinct from <a><var class="meta">m</var></a>, that is not inside the region.</p>
<h4 id="sec.exec.uniformity.region.structured"><a href="#sec.exec.uniformity.region.structured" class="anchor">Structured Regions</a></h4>
<p>A <dfn>structured region</dfn> is a <a>control-flow region</a> that is significant to the Slang language semantics.</p>
<p>For each function body, there is a <a>structured region</a> (<a><var class="meta">entry</var></a>, <a><var class="meta">unreachable</var></a>) where <a><var class="meta">entry</var></a> is the unique entry block of the function's control-flow graph, and <a><var class="meta">unreachable</var></a> is a unique unreachable block.</p>
<p>Each conditional control-flow operation has a <dfn>merge point</dfn>,
and defines a structured region (<a><var class="meta">c</var></a>, <a><var class="meta">m</var></a>) where <a><var class="meta">c</var></a> is the control-flow operation and <a><var class="meta">m</var></a> is its <a>merge point</a>.</p>
<div class="issue callout">TODO: We need rules to define the CFG that arises for each of our syntactic forms (both statements and expressions).</div>
<h3 id="sec.exec.uniformity.divergence"><a href="#sec.exec.uniformity.divergence" class="anchor">Divergence</a></h3>
<p>When a <a>strand</a> <a><var class="meta">s</var></a> that is part of a tangle <a><var class="meta">t</var></a> <a>executes</a> a <a>conditional control-flow operation</a> and branches to a destination <a>block</a> <a><var class="meta">d</var></a>, then <a><var class="meta">s</var></a> becomes part of a new <a>tangle</a> comprising exactly the subset of <a>strands</a> of <a><var class="meta">t</var></a> that branch to <a><var class="meta">d</var></a>.</p>
<h3 id="sec.exec.uniformity.reconvergence"><a href="#sec.exec.uniformity.reconvergence" class="anchor">Reconvergence</a></h3>
<p>When a <a>strand</a> <a><var class="meta">s</var></a> that is part of a tangle <a><var class="meta">t</var></a> enters a <a>structured control-flow region</a> (<a><var class="meta">entry</var></a>, <a><var class="meta">merge</var></a>) and then exits that region by branching to <a><var class="meta">merge</var></a>, it becomes part of a new <a>tangle</a> comprising exactly the subset of <a>strands</a> of <a><var class="meta">t</var></a> that entered that region and did not <a>break out of</a> that region.</p>
<div class="note callout">Note: These rules carefully say that a strand re-converges with the strands in the same tangle that don't break out of the region, rather than the strands that exit the region normally. The reason for this choice is that a strand that goes into an infinite loop without exiting a region will be treated the same as a strand that exits that region normally.</div>
<h3 id="sec.exec.uniformity.dynamic"><a href="#sec.exec.uniformity.dynamic" class="anchor">Dynamic Uniformity</a></h3>
<p>A <dfn>granularity</dfn> of group of <a>strands</a> is one of:</p>
<ul><li><p><a><span class="meta">Strand</span></a>: a single <a>strand</a></p>
</li>
<li><p><a><span class="meta">Wave</span></a>: <a>strands</a> in the same <a>wave</a></p>
</li>
<li><p><a><span class="meta">Block</span></a>: <a>strands</a> in the same compute <a>block</a></p>
</li>
<li><p><a><span class="meta">Dispatch</span></a>: <a>strands</a> in the same GPU <a>dispatch</a></p>
</li>
<li><p><a><span class="meta">Constant</span></a>: all <a>strands</a></p>
</li>
</ul>
<h4 id="sec.exec.uniformity.dynamic.value"><a href="#sec.exec.uniformity.dynamic.value" class="anchor">Dynamically Uniform Values</a></h4>
<p>When a <a>strand</a> <a><var class="meta">s</var></a> in a <a>tangle</a> <a><var class="meta">t</var></a> <a>evaluates</a> some <a>expression</a> <a><var class="meta">e</var></a>, the result is <dfn>dynamically per-<a><var class="meta">g</var></a></dfn>, for some <a>granularity</a> <a><var class="meta">g</var></a>, if <a><var class="meta">e</var></a> evaluates to the same <a>value</a> for every <a>strand</a> in <a><var class="meta">t</var></a> that is in the same <a><var class="meta">g</var></a> as <a><var class="meta">s</var></a>.</p>
<h4 id="sec.exec.uniformity.dynamic.control"><a href="#sec.exec.uniformity.dynamic.control" class="anchor">Dynamically Uniform Control Flow</a></h4>
<p>When a <a>strand</a> <a><var class="meta">s</var></a> in a <a>tangle</a> <a><var class="meta">t</var></a> <a>executes</a> some <a>statement</a>, then control-flow for <a><var class="meta">s</var></a> is <dfn>dynamically per-<a><var class="meta">g</var></a> uniform</dfn>, for some <a>granularity</a> <a><var class="meta">g</var></a>,  if every <a>strand</a> in the same <a><var class="meta">g</var></a> as <a><var class="meta">s</var></a> is also in <a><var class="meta">t</var></a>.</p>
<h2 id="sec.exec.rate"><a href="#sec.exec.rate" class="anchor">Rates</a></h2>
<p>A <dfn>rate</dfn> takes the form <a><span class="meta">@g</span></a> where <a><var class="meta">g</var></a> is a <a>granularity</a>.
A <a>rate</a> of <a><span class="meta">@g</span></a> may also be referred to as per-<a><var class="meta">g</var></a>.</p>
<div class="issue callout">TODO: Writing the rules for computing static rates will be an important exercise...</div>
<h3 id="sec.exec.rate.value"><a href="#sec.exec.rate.value" class="anchor">Rates of Values</a></h3>
<p>An <a>expression</a> is <dfn>statically per-<a><var class="meta">g</var></a></dfn> if it can be proved, using the rules in this specification, that the value will always be <dfn>dynamically per-<a><var class="meta">g</var></a></dfn> at runtime.</p>
<h3 id="sec.exec.rate.control"><a href="#sec.exec.rate.control" class="anchor">Rates of Control-Flow</a></h3>
<p>At some point in a Slang program, control-flow is <dfn>statically per-<a><var class="meta">g</var></a> uniform</dfn> if it can be proved, using the rules in this specification, that at runtime any <a>strand</a> at that point would be part of a <a>tangle</a> that is <dfn>dynamically per-<a><var class="meta">g</var></a> uniform</dfn>.</p>
<h1 id="sec.gpu"><a href="#sec.gpu" class="anchor">GPUs</a></h1>
<h2 id="sec.gpu.dispatch"><a href="#sec.gpu.dispatch" class="anchor">Dispatches</a></h2>
<p>Work is issued to a GPU device in the form of <dfn>commands</dfn>.
A <dfn>dispatch</dfn> is a <a>command</a> that causes a GPU device to execute a specific <a>pipeline instance</a>.</p>
<p>A dispatch determines:</p>
<ul><li><p>The <a>pipeline instance</a> <a><var class="meta">P</var></a> to execute</p>
</li>
<li><p>A value for each of the <a>dispatch parameters</a> of <a><var class="meta">P</var></a></p>
</li>
<li><p>A value for each of the <a>uniform shader parameters</a> of <a><var class="meta">P</var></a></p>
</li>
</ul>
<h2 id="sec.gpu.pipeline"><a href="#sec.gpu.pipeline" class="anchor">Pipelines</a></h2>
<h3 id="sec.gpu.pipeline.type"><a href="#sec.gpu.pipeline.type" class="anchor">Pipeline Types</a></h3>
<p>A <dfn>pipeline type</dfn> is a category of workloads that a GPU can support.
Slang supports the following pipeline types:</p>
<ul><li><p><a>rasterization pipelines</a></p>
</li>
<li><p><a>compute pipelines</a></p>
</li>
<li><p><a>ray-tracing pipelines</a></p>
</li>
</ul>
<p>Each <a>pipeline type</a> <a><span class="meta">PT</span></a> defines:</p>
<ul><li><p>Zero or more <dfn>dispatch parameters</dfn>, each having a name and a type</p>
</li>
<li><p>A set of <a>stage types</a></p>
</li>
<li><p>A set of <dfn>associated record types</dfn></p>
</li>
<li><p>Validation rules for <a>pipeline instances</a> of type <a><span class="meta">PT</span></a></p>
</li>
</ul>
<h3 id="sec.gpu.pipeline.instance"><a href="#sec.gpu.pipeline.instance" class="anchor">Pipeline Instances</a></h3>
<p>A <dfn>pipeline instance</dfn> is an instance of some <a>pipeline type</a>, and consists of:</p>
<ul><li><p>A set of zero or more <a>stage instances</a></p>
</li>
<li><p>A <a>bundle</a></p>
</li>
</ul>
<p>The <a>kernels</a> of any <a>programmable</a> <a>stage instances</a> in a <a>pipeline instance</a> must be compatible with the <a>bundle</a> of the <a>pipeline instance</a>.</p>
<h4 id="sec.gpu.pipeline.stage"><a href="#sec.gpu.pipeline.stage" class="anchor">Stages</a></h4>
<h5 id="sec.exec.gpu.pipeline.stage.type"><a href="#sec.exec.gpu.pipeline.stage.type" class="anchor">Stage Types</a></h5>
<p>A <dfn>stage type</dfn> is a type of stage that may appear in <a>pipeline instances</a>.</p>
<p>Each <a>stage type</a> belongs to a single <a>pipeline type</a>.</p>
<p>A <a>stage type</a> is either <dfn>programmable</dfn> or it is <dfn>fixed-function</dfn>.</p>
<p>A stage has zero or more <dfn>fixed-function parameters</dfn>, each having a name and a type</p>
<p>A <a>stage type</a> is either required, optional, or instanceable.</p>
<h5 id="sec.gpu.pipeline.stage.instance"><a href="#sec.gpu.pipeline.stage.instance" class="anchor">Stage Instances</a></h5>
<p>A <dfn>stage instance</dfn> is an instance of some <a>stage type</a> <a><span class="meta">ST</span></a>, and consists of:</p>
<ul><li><p>A <a>kernel</a> <a><var class="meta">K</var></a> for <a><span class="meta">ST</span></a>, if <a><span class="meta">ST</span></a> is <a>programmable</a>.</p>
</li>
<li><p>Values for each of the <a>fixed-function parameters</a> of <a><span class="meta">ST</span></a> that are not included in <a><var class="meta">K</var></a></p>
</li>
</ul>
<h4 id="sec.exec.gpu.pipeline.stage.signature"><a href="#sec.exec.gpu.pipeline.stage.signature" class="anchor">Signatures</a></h4>
<p>The <dfn>signature</dfn> of a <a>programmable stage</a> consists of its <a>uniform signature</a> and its <a>varying signature</a>.</p>
<p>The <dfn>uniform signature</dfn> of a <a>programmable stage</a> is a sequence of <a>types</a>.</p>
<p>A <a>programmable stage</a> has a set of <dfn>boundaries</dfn>.
Each <a>programmable stage</a> has an input <a>boundary</a> and an output boundary.</p>
<p>The varying input signature of a programmable stage is its signature along its input boundary;
The varying output signature of a programmabel stage is its signature along its output boundary;</p>
<p>The varying signature of a programmable stage comprises the boundary signature of that stage along each of its boundaries.</p>
<p>To compute the signature of a stage <a><var class="meta">S</var></a> with a kernel based on a function <a><var class="meta">f</var></a>:</p>
<ul><li><p>Initialize the uniform signature of <a><var class="meta">S</var></a> to an empty sequence</p>
</li>
<li><p>Initailize the boundary signature of <a><var class="meta">S</var></a> along each of its boundaries to an empty sequence</p>
</li>
<li><p>If <a><var class="meta">f</var></a> has an implicit <code>this</code> parameter then:</p>
<ul><li><p>Append the type of the <code>this</code> parameter to the uniform signature of <a><var class="meta">S</var></a></p>
</li>
</ul>
</li>
<li><p>For each explicit parameter <a><var class="meta">p</var></a> of <a><var class="meta">f</var></a>:</p>
<ul><li><p>If <a><var class="meta">p</var></a> is <code>uniform</code>, then:</p>
<ul><li><p>Add the type of <a><var class="meta">p</var></a> to the uniform signature of <a><var class="meta">S</var></a></p>
</li>
</ul>
</li>
<li><p>Otherwise:</p>
<ul><li><div class="issue callout">TODO: handling of semantics!</div>
</li>
<li><p>Add <a><var class="meta">p</var></a> to the varying signature of <a><var class="meta">S</var></a></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Add the result type <a><var class="meta">R</var></a> to the varying output signature of <a><var class="meta">S</var></a></p>
<ul><li><div class="issue callout">TODO: need to handle semantics on <a><var class="meta">f</var></a> as semantics on the result...</div>
</li>
</ul>
</li>
</ul>
<p>The default way to add a parameter <a><var class="meta">p</var></a> to the varying signature of some stage <a><var class="meta">S</var></a> is:</p>
<ul><li><p>If the direction of <a><var class="meta">p</var></a> is <code>in</code> or <code>inout</code>, then add <a><var class="meta">p</var></a> to the varying input signature of <a><var class="meta">S</var></a></p>
</li>
<li><p>If the direction of <a><var class="meta">p</var></a> is <code>out</code> or <code>inout</code>, then add <a><var class="meta">p</var></a> to the varying output signature of <a><var class="meta">S</var></a></p>
</li>
</ul>
<h3 id="sec.exec.gpu.pipeline.record"><a href="#sec.exec.gpu.pipeline.record" class="anchor">Records</a></h3>
<p>A <dfn>record</dfn> is an instance of an <a>associated record type</a> of a <a>pipeline type</a>.
Data is passed between the <a>stage instances</a> of a <a>pipeline instance</a> in the form of <a>records</a>.</p>
<p>The varying input and output signature of a <a>stage instance</a> is defined with respect to the <a>associated record types</a> of the corresponding <a>pipeline type</a>.</p>
<p>A <a>stage instance</a> depends on the <a>associated record types</a> that are part of its signature.
A <a>pipeline instance</a> depends on the <a>associated record types</a> that are part of its <a>stage instances</a>.</p>
<p>A programmable stage has a set of boundaries.
Every programmable stage has an input boundary and an output boundary.</p>
<p>A record type signature is a sequence of pairs (<a><var class="meta">T</var></a>, <a><var class="meta">s</var></a>), where <a><var class="meta">T</var></a> is a type and <a><var class="meta">s</var></a> is a semantic.
The varying signature of a programmable stage along one of its boundaries is a record type signature.</p>
<p>For each <a>associated record type</a> <a><var class="meta">R</var></a> that a <a>pipeline instance</a> <a><var class="meta">P</var></a> depends on, if there are <a>stage instances</a> <a><var class="meta">A</var></a> and <a><var class="meta">B</var></a> in <a><var class="meta">P</var></a> such that <a><var class="meta">A</var></a> outputs <a><var class="meta">R</var></a> and <a><var class="meta">B</var></a> inputs <a><var class="meta">R</var></a>, then the configuration of <a><var class="meta">R</var></a> for <a><var class="meta">B</var></a> must be a prefix of the configuration of <a><var class="meta">A</var></a>.</p>
<h3 id="sec.exec.gpu.pipeline.compute"><a href="#sec.exec.gpu.pipeline.compute" class="anchor">Compute</a></h3>
<p>A <dfn>compute pipeline</dfn> instance is a <a>pipeline instance</a> with a single <a>stage instance</a> of <a>stage type</a> <code>compute</code>.
The <code>compute</code> <a>stage type</a> is <a>programmable</a>.</p>
<p>A <dfn>compute dispatch</dfn> is a <a>dispatch</a> of a <a>compute pipeline instance</a>.</p>
<h4 id="section-blocks"><a href="#section-blocks" class="anchor">Blocks</a></h4>
<p>A <a>compute dispatch</a> invokes its kernel for each strand in a <dfn>block</dfn> of strands.
The number and organization of strands in a <a>block</a> is determined by a <dfn>block shape</dfn>.
A <a>block shape</a> consists of its rank <a><var class="meta">N</var></a>, a positive integer, and its extents, a vector of <a><var class="meta">N</var></a> positive integers.</p>
<div class="note callout">Note: Typical GPU platforms support block shapes with ranks up to 3.</div>
<p>Every <a>strand</a> in a <a>block</a> <a><var class="meta">b</var></a> has a <dfn>strand ID</dfn>, a vector of <a><var class="meta">N</var></a> non-negative integers, where <a><var class="meta">N</var></a> is the rank of the block shape of <a><var class="meta">b</var></a>.
For a <a>strand</a> <a><var class="meta">s</var></a> in <a>block</a> <a><var class="meta">b</var></a>, <a><var class="meta">s.strandID</var></a> is in [0, <a><var class="meta">b.shape.extents[i]</var></a>) for all <a><var class="meta">i</var></a> in [0,<a><var class="meta">b.shape.rank</var></a>).</p>
<p>The <a>strands</a> in a <a>block</a> are guaranteed to execute concurrently.</p>
<h4 id="section-grids"><a href="#section-grids" class="anchor">Grids</a></h4>
<p>Each <a>block</a> of <a>strands</a> that execute a compute entry point is part of a <dfn>grid</dfn> of blocks.
The number and organization of blocks in a <a>grid</a> is determined by a <dfn>grid shape</dfn>.
A <a>grid shape</a> consists its rank <a><var class="meta">N</var></a>, a positive integer, and its extent, a positive integer, along each axis <a><var class="meta">i</var></a>, where 0 <= <a><var class="meta">i</var></a> < <a><var class="meta">N</var></a>.</p>
<div class="note callout">Note: Typical GPU platforms support grid shapes with ranks up to 3.</div>
<p>Every <a>block</a> in a <a>grid</a> <a><var class="meta">g</var></a> has a <dfn>block ID</dfn>, a vector of <a><var class="meta">N</var></a> non-negative integers, where <a><var class="meta">N</var></a> is the rank of the grid shape of <a><var class="meta">g</var></a>.
For a <a>block</a> <a><var class="meta">b</var></a> in <a>grid</a> <a><var class="meta">g</var></a>, <a><var class="meta">b.blockID</var></a> is in [0, <a><var class="meta">g.shape.extents[i]</var></a>) for all <a><var class="meta">i</var></a> in [0,<a><var class="meta">g.shape.rank</var></a>).</p>
<p>The <a>blocks</a> in a <a>grid</a> may be executed concurrently, but this is not guaranteed.</p>
<h4 id="section-attributes"><a href="#section-attributes" class="anchor">Attributes</a></h4>
<h5 id="section-[numthreads]"><a href="#section-[numthreads]" class="anchor"><code>[numthreads]</code></a></h5>
<p>An entry point for the <code>compute</code> stage may have a <code>[numthreads]</code> attribute.
If present, a <code>[numthreads]</code> attribute determines the <a>block shape</a> of compute pipelines using that entry point.</p>
<h4 id="section-signature"><a href="#section-signature" class="anchor">Signature</a></h4>
<p>A <code>compute</code> stage has the following boundaries:</p>
<ul><li><p>An input boundary with associated record type <code>ComputeInput</code></p>
</li>
<li><p>An output boundary with associated record type <code>ComputeOutput</code></p>
</li>
</ul>
<p>The <code>ComputeOutput</code> record type of a <code>compute</code> stage must be empty.</p>
<p>The <code>ComputeInput</code> record type of a <code>compute</code> stage must not contain any entries with a user semantic.</p>
<p>The <code>ComptueInput</code> record type of a <code>compute</code> stage may contain entries of the form:</p>
<ul><li><p>( <a><var class="meta">T</var></a> , <code>SV_DispatchThreadID</code>, 0 )</p>
</li>
<li><p>( <a><var class="meta">T</var></a> , <code>SV_GroupID</code>, 0 )</p>
</li>
<li><p>( <a><var class="meta">T</var></a>, <code>SV_GroupIndex</code>, 0 )</p>
</li>
<li><p>( <a><var class="meta">T</var></a>, <code>SV_GroupThreadID</code>, 0 )</p>
</li>
</ul>
<div class="issue callout">TODO: Need a compact notation for specifying system-value semantics, because otherwise the writing will get overly verbose.</div>
<pre><code class="language-">in @ComputeInput SV_GroupID<N> : vector<uint,N>;
in @ComputeInput SV_GroupIndex : uint;
in @ComputeInput SV_GroupThreadID<N> : vector<uint,N>
in @ComputeInput SV_DispatchThreadID<N> : vector<uint,N>
</code></pre>
<h3 id="sec.exec.gpu.pipeline.raster"><a href="#sec.exec.gpu.pipeline.raster" class="anchor">Rasterization</a></h3>
<p>A <dfn>rasterization pipeline</dfn> instance is a <a>pipeline instance</a>.</p>
<h4 id="section-rasterization-system-values"><a href="#section-rasterization-system-values" class="anchor">Rasterization System Values</a></h4>
<div class="issue callout">TODO: There are system values that can appear on vertices of whatever geometry-related stage comes last.</div>
<pre><code class="language-">out @RasterVertex SV_Position : float4;
out @RasterVertex SV_RenderTargetArrayIndex : uint;
out @RasterVertex SV_ViewPortArrayIndex : uint;
out @RasterVertex SV_ClipDistance : float4[];
out @RasterVertex SV_CullDistance : float4[];
</code></pre>
<h4 id="sec.exec.gpu.pipeline.raster.stage.fetch.index"><a href="#sec.exec.gpu.pipeline.raster.stage.fetch.index" class="anchor">Index Fetch</a></h4>
<h4 id="sec.exec.gpu.pipeline.raster.stage.fetch.vertex"><a href="#sec.exec.gpu.pipeline.raster.stage.fetch.vertex" class="anchor">Vertex Fetch</a></h4>
<p>Vertex fetch is a <a>fixed-function</a> stage.</p>
<p>This stage takes as input an <code>VertexIndex</code> record, and produces as output an <code>AssembledVertex</code> record.</p>
<ul><li><p>For each attribute of the <code>AssembledVertex</code> record, fetch data from the corresponding vertex stream, using either the instance ID or vertex ID (based on configuration).</p>
</li>
</ul>
<h4 id="sec.exec.gpu.pipeline.raster.stage.vertex"><a href="#sec.exec.gpu.pipeline.raster.stage.vertex" class="anchor">Vertex Shader</a></h4>
<p>A given dispatch may invoke the kernel for the <code>vertex</code> stage one or more times for each vertex ID and instance ID.</p>
<h5 id="section-signature"><a href="#section-signature" class="anchor">Signature</a></h5>
<p>The <code>vertex</code> <a>stage type</a> is <a>programmable</a>.</p>
<p>A <code>vertex</code> stage has the following boundaries:</p>
<ul><li><p>An input boundary with associated record type <code>AssembledVertex</code></p>
</li>
<li><p>An output boundary with associated record type <code>CoarseVertex</code></p>
</li>
</ul>
<h5 id="section-system-values"><a href="#section-system-values" class="anchor">System Values</a></h5>
<pre><code class="language-">in @AssembledVertex SV_VertexID : uint;
in @DrawInstance SV_InstanceID : uint;
in @View SV_ViewID : uint;
</code></pre>
<h4 id="sec.exec.gpu.pipeline.raster.stage.primitive-assembly"><a href="#sec.exec.gpu.pipeline.raster.stage.primitive-assembly" class="anchor">Primitive Assembly</a></h4>
<p>A primitive consists of a primitive topology and N vertices, where N matches the requirements of that primitive topology.</p>
<p>This stage takes as input coarse vertex records from a preceding stage.
It produces as output primitives of coarse vertex records.</p>
<h4 id="sec.exec.gpu.pipeline.raster.stage.tess"><a href="#sec.exec.gpu.pipeline.raster.stage.tess" class="anchor">Tessellation</a></h4>
<h5 id="sec.exec.gpu.pipeline.raster.stage.tess.hull"><a href="#sec.exec.gpu.pipeline.raster.stage.tess.hull" class="anchor">Hull Shader</a></h5>
<p>This stage takes as input a patch primitive of coarse vertex records.
It produces as output a patch primitive of control point records a patch record.</p>
<h6 id="section-attributes"><a href="#section-attributes" class="anchor">Attributes</a></h6>
<p>An entry point for the <code>hull</code> stage must have a <code>[patchconstantfunc]</code> attribute.</p>
<div class="issue callout">TODO: specify how the patch-constant function gets identified, etc.</div>
<div class="issue callout">TODO: add the other attributes...</div>
<h6 id="section-signature"><a href="#section-signature" class="anchor">Signature</a></h6>
<p>The varying signature of a <code>hull</code> entry point is determined as follows:</p>
<ul><li><p>For any <code>in</code> parameter of type <code>InputPatch<<a><var class="meta">T</var></a>,<a><var class="meta">N</var></a>></code>, <a><var class="meta">T</var></a> contributes to the <code>CoarseVertex</code> record type</p>
</li>
<li><p>Any other <code>in</code> parameters contribute to the <code>HullInput</code> record type</p>
</li>
<li><p><code>out</code> parameters contribute to the <code>ControlPoint</code> record type</p>
</li>
</ul>
<p>The varying signature of a patch-constant function is determined as follows:</p>
<ul><li><p>For any <code>in</code> parameters of type <code>OutputPatch<<a><var class="meta">T</var></a>,<a><var class="meta">N</var></a>></code>, <a><var class="meta">T</var></a> contributes to the <code>ControlPoint</code> record type</p>
</li>
<li><p>Any other <code>in</code> parameters contribute to the <code>PatchConstantInput</code> record type</p>
</li>
<li><p><code>out</code> parameters contribute to the <code>Patch</code> record type</p>
</li>
</ul>
<p>The varying signature of a <code>hull</code> stage is the union of the varying signatures of the <code>hull</code> entry point and the patch-constant function.</p>
<div class="issue callout">TODO: Need to specify that the <code>ControlPoint</code> type and <a><var class="meta">N</var></a> on input to the patch-constant function must match those output by the hull shader.</div>
<p>The <code>HullInput</code> boundary of a <code>hull</code> stage must not have any elements with user semantics.</p>
<p>The <code>PatchConstantInput</code> boundary of a <code>hull</code> stage must be empty.</p>
<h6 id="section-system-values"><a href="#section-system-values" class="anchor">System Values</a></h6>
<p>The <code>HullInput</code> record type supports the following system values:</p>
<pre><code class="language-">    => `SV_PrimitiveID`
    => `SV_OutputControlPointID`
</code></pre>
<p>The <code>Patch</code> record type supports the following system values:</p>
<pre><code class="language-">    => `SV_TessFactor`
    => `SV_InsideTessFactor`
</code></pre>
<h5 id="sec.exec.gpu.pipeline.raster.stage.tess.domain"><a href="#sec.exec.gpu.pipeline.raster.stage.tess.domain" class="anchor">Domain Shader</a></h5>
<p>This stage takes as input a patch primitive of control point records, and a patch record.
It outputs a fine vertex record.</p>
<h6 id="section-system-values"><a href="#section-system-values" class="anchor">System Values</a></h6>
<pre><code class="language-">    => `SV_DomainLocation`
</code></pre>
<h4 id="sec.exec.gpu.pipeline.raster.stage.geometry"><a href="#sec.exec.gpu.pipeline.raster.stage.geometry" class="anchor">Geometry Shader</a></h4>
<p>This stage takes as input a primitive of vertex records (either coarse or fine vertices, depending on what preceding stages are enabled).
As output, a geometry shader may have one or more output streams, each having a coresponding type of record.
For each output stream, a strand executing a geometry shader may output zero or more records of the corresponding type.</p>
<p>If one of the output streams of the geometry shader is connected to the rasterizer stage, then that output stream corresponds to raster vertex records.</p>
<h5 id="section-system-values"><a href="#section-system-values" class="anchor">System Values</a></h5>
<pre><code class="language-">    => `SV_GSInstanceID`
</code></pre>
<h4 id="sec.exec.gpu.pipeline.raster.stage.mesh"><a href="#sec.exec.gpu.pipeline.raster.stage.mesh" class="anchor">Mesh Shading</a></h4>
<h4 id="sec.exec.gpu.pipeline.raster.stage.rasterizer"><a href="#sec.exec.gpu.pipeline.raster.stage.rasterizer" class="anchor">Rasterizer</a></h4>
<p>The rasterizer is a <a>fixed-function</a> stage.</p>
<p>This stage takes as input a primitive of raster vertex records, and determines which pixels in a render target that primitive covers.
The stage outputs zero or more raster fragment records, one for each covered pixel.</p>
<h4 id="sec.exec.gpu.pipeline.raster.stage.depth-stencil-test"><a href="#sec.exec.gpu.pipeline.raster.stage.depth-stencil-test" class="anchor">Depth/Stencil Test</a></h4>
<h4 id="sec.exec.gpu.pipeline.raster.stage.fragment"><a href="#sec.exec.gpu.pipeline.raster.stage.fragment" class="anchor">Fragment Shader</a></h4>
<h5 id="section-signature"><a href="#section-signature" class="anchor">Signature</a></h5>
<p>This stage takes as input a raster fragment record, and produces as output either:</p>
<ul><li><p>One <code>ShadedFragment</code> record</p>
</li>
<li><p>One <code>ShadedFragment</code> record and N <code>ShadedFragment.Sample</code> records</p>
</li>
</ul>
<div class="issue callout"><h6>TODO</h6>
<ul><li><p>For any input elements, need to consider its interpolation mode.
If <code>sample</code> interpolation is requested, then the input goes to the <code>Sample</code>
record type; otherwise the <code>Fragment</code> record type.</p>
<ul><li><p>Then need a little fixup after that step to deal with system values
that would have been binned into the <code>Fragment</code> record but that
should go elsewhere.</p>
</li>
</ul>
</li>
</ul>
</div>
<h5 id="section-system-values"><a href="#section-system-values" class="anchor">System Values</a></h5>
<p>Input:</p>
<pre><code class="language-">in @Sample SV_SampleIndex : uint;

in @RasterPrimitive SV_IsFrontFace : bool;

in @Fragment SV_Coverage : ???;
in @Fragment SV_InnerCoverage : ???;

// TODO: these could have @Fragment or @Sample rate,
// depending on how they are qualified
in @Sample SV_Barycentrics : float3;
in @Sample SV_Depth : float;
</code></pre>
<p>Output:</p>
<pre><code class="language-">    => `SV_Target`
    => `SV_Depth`
    => `SV_DepthLessEqual`
    => `SV_DepthGreaterEqual`
    => `SV_StencilRef`
</code></pre>
<h4 id="sec.exec.gpu.pipeline.raster.stage.blend"><a href="#sec.exec.gpu.pipeline.raster.stage.blend" class="anchor">Blend</a></h4>
<p>This stage takes as input a <code>ShadedFragment</code> record (possibly including its <code>ShadedFragment.Sample</code>) and a <code>Pixel</code> record, and produces as output a <code>Pixel</code> record.</p>
<h3 id="sec.exec.gpu.pipeline.ray-tracing"><a href="#sec.exec.gpu.pipeline.ray-tracing" class="anchor">Ray Tracing</a></h3>
<div class="issue callout">TODO: The trickiest part here is setting up the relevant record types, since a single pipeline instance may use a variety of different ray payloads, hit attributes, etc. The only constraints that can be given are really related to when the results of a <code>TraceRay</code> might be undefined because of a mismatch in record types between entry points that get invoked.</div>
<h2 id="sec.gpu.fodder"><a href="#sec.gpu.fodder" class="anchor">Fodder</a></h2>
<div class="note callout"><h6>Note</h6>
<p>This section is being used to collect material that probably belongs in the "GPU" chapter, but that doesn't currently have a home in the way it has been organized so far.</p>
</div>
<pre><code class="language-.semantic">PipelineType
    => `RASTERIZATION`
    => `COMPUTE`
    => `RAYTRACING`
    => `WORKGRAPH`

ShaderStage
    => RasterizationPipelineShaderStage
    => ComputeShaderStage
    => RayTracingShaderStage
    => WorkGraphShaderStage

RasterizationPipelineShaderStage
    => `fragment`

PreRasterizationShaderStage
    => TraditionalPreRasterizationShaderStage
    => MeshPreRasterizationShaderStage

TraditionalPreRasterizationShaderStage
    => `vertex`
    => TessellationShaderStage
    => `geometry`

TessellationShaderStage
    => `hull`
    => `domain`

MeshPreRasterizationShaderStage
    => `mesh`
    => `amplification`

ComputeShaderStage
    => `compute`

RayTracingShaderStage
    => `raygen`
    => `intersection`
    => `anyhit`
    => `closesthit`
    => `miss`
    => `callable`

WorkGraphShaderStage
    => `node`

Semantic
    => SemanticName SemanticIndex

SemanticIndex
    => NaturalNumber

SemanticName
    => UserSemanticName
    => SystemSemanticName

UserSemanticName
    => String

SystemSemanticName
    => `SV_VertexID`
    => `SV_InstanceID`
    => `SV_Position`
    => `SV_RenderTargetArrayIndex`
    => `SV_ViewPortArrayIndex`
    => `SV_ClipDistance`
    => `SV_CullDistance`
    => `SV_OutputControlPointID`
    => `SV_DomainLocation`
    => `SV_PrimitiveID`
    => `SV_GSInstanceID`
    => `SV_SampleIndex`
    => `SV_IsFrontFace`
    => `SV_Coverage`
    => `SV_InnerCoverage`
    => `SV_Target`
    => `SV_Depth`
    => `SV_DepthLessEqual`
    => `SV_DepthGreaterEqual`
    => `SV_StencilRef`
    => `SV_DispatchThreadID`
    => `SV_GroupID`
    => `SV_GroupIndex`
    => `SV_GroupThreadID`
    => `SV_TessFactor`
    => `SV_InsideTessFactor`
    => `SV_ViewID`
    => `SV_Barycentrics`
    => `SV_ShadingRate`
    => `SV_CullPrimitive`
    => `SV_StartVertexLocation`
    => `SV_StartInstanceLocation`
</code></pre>
<table><tr><th>Stage</th>
<th>Boundary</th>
<th>Record Type</th>
</tr>
<tr><td><code>vertex</code></td>
<td><code>in</code></td>
<td><code>AssembledVertex</code></td>
</tr>
<tr><td><code>vertex</code></td>
<td><code>out</code></td>
<td><code>CoarseVertex</code></td>
</tr>
<tr><td><code>hull</code></td>
<td><code>in</code></td>
<td><code>HullInput</code></td>
</tr>
<tr><td><code>hull</code></td>
<td><code>out</code></td>
<td><code>HullOutput</code></td>
</tr>
<tr><td><code>hull</code></td>
<td>input control points</td>
<td><code>CoarseVertex</code></td>
</tr>
<tr><td><code>hull</code></td>
<td>output control points</td>
<td><code>ControlPoint</code></td>
</tr>
<tr><td><code>hull</code></td>
<td>patch constant function</td>
<td><code>Patch</code></td>
</tr>
<tr><td><code>domain</code></td>
<td><code>in</code></td>
<td><code>Patch</code></td>
</tr>
<tr><td><code>domain</code></td>
<td>input control points</td>
<td><code>ControlPoint</code></td>
</tr>
<tr><td><code>domain</code></td>
<td>output</td>
<td><code>FineVertex</code></td>
</tr>
<tr><td><code>geometry</code></td>
<td><code>in</code></td>
<td><code>GeometryInput</code></td>
</tr>
<tr><td><code>geometry</code></td>
<td><code>out</code></td>
<td><code>GeometryOutput</code></td>
</tr>
<tr><td><code>geometry</code></td>
<td>input vertices</td>
<td><code>FineVertex</code></td>
</tr>
<tr><td><code>geometry</code></td>
<td>output stream 0</td>
<td><code>RasterVertex</code></td>
</tr>
<tr><td><code>geometry</code></td>
<td>output stream <a><var class="meta">i</var></a></td>
<td><code>StreamOutputVertex_i</code></td>
</tr>
<tr><td><code>fragment</code></td>
<td><code>in</code></td>
<td><code>RasterVertex</code></td>
</tr>
<tr><td><code>fragment</code></td>
<td><code>out</code></td>
<td><code>Fragment</code></td>
</tr>
<tr><td><code>mesh</code></td>
<td><code>in</code></td>
<td><code>MeshInput</code></td>
</tr>
<tr><td><code>mesh</code></td>
<td>???</td>
<td><code>MeshOutputVertex</code></td>
</tr>
<tr><td><code>mesh</code></td>
<td>???</td>
<td><code>MeshPrimitive</code></td>
</tr>
<tr><td><code>amplification</code></td>
<td>???</td>
<td>???</td>
</tr>
<tr><td><code>compute</code></td>
<td><code>in</code></td>
<td><code>ComputeInput</code></td>
</tr>
<tr><td><code>compute</code></td>
<td><code>out</code></td>
<td><code>ComputeOutput</code></td>
</tr>
</table>
<h1 id="sec.memory"><a href="#sec.memory" class="anchor">Memory</a></h1>
<p>Values of <a>storable</a> types may be stored into and loaded from memory.
A proper type <a><var class="meta">T</var></a> is <dfn>storable</dfn> if <a><var class="meta">T</var></a> conforms to <code>IStorable</code>.</p>
<h2 id="sec.memory.location"><a href="#sec.memory.location" class="anchor">Memory Locations</a></h2>
<p>Memory logically consists of a set of <dfn>memory locations</dfn>, each of which can hold an 8-bit byte.
Each memory location is part of one and only one <dfn>address space</dfn>.</p>
<p>Two sets of <a>memory locations</a> overlap if their intersection is non-empty.</p>
<h2 id="sec.memory.access"><a href="#sec.memory.access" class="anchor">Memory Accesses</a></h2>
<p>A <dfn>memory access</dfn> is an operation performed by a <a>strand</a> on a set of <a>memory locations</a> in a single <a>address space</a>.
A <a>memory access</a> has a <a>memory access mode</a>.</p>
<h3 id="sec.memory.access.mode"><a href="#sec.memory.access.mode" class="anchor">Memory Access Modes</a></h3>
<p>A <dfn>memory access mode</dfn> is one of: <code>read</code>, <code>write</code>, or <code>modify</code>.</p>
<h2 id="sec.memory.model"><a href="#sec.memory.model" class="anchor">Memory Model</a></h2>
<p><div class="issue">
We need to find an existing formal memory model to reference and use.
</div></p>
<h1 id="sec.SECTION.layout"><a href="#sec.SECTION.layout" class="anchor">Layout</a></h1>
<p><div class="issue">
We clearly need a chapter on the guarantees Slang makes about memory layout.
</div></p>
<p>Types in Slang do not necessarily prescribe a single <dfn>layout</dfn> in memory.
The discussion of each type will specify any guarantees about <a>layout</a> it provides; any details of layout not specified here may depend on the target platform, compiler options, and context in which a type is used.</p>
<h1 id="sec.storage"><a href="#sec.storage" class="anchor">Storage</a></h1>
<h2 id="sec.storage.concrete"><a href="#sec.storage.concrete" class="anchor">Concrete Storage Locations</a></h2>
<p>A <dfn>concrete storage location</dfn> with layout <a>L</a> for storable type <a><var class="meta">T</var></a> comprises a set of contiguous <a>memory locations</a>, in a single <a>address space</a>, where a value of type <a><var class="meta">T</var></a> with layout <a>L</a> can be stored.</p>
<h3 id="sec.storage.concrete.type"><a href="#sec.storage.concrete.type" class="anchor">Reference Types</a></h3>
<p>A <dfn>reference type</dfn> is written <code><a><var class="meta">m</var></a> ref <a><var class="meta">T</var></a></code> where <a><var class="meta">m</var></a> is a <a>memory access mode</a> and <a><var class="meta">T</var></a> is a storable type.</p>
<p><div class="issue">
How do we get layout involved here?
</div></p>
<h4 id="sec.storage.concrete.type.conversion"><a href="#sec.storage.concrete.type.conversion" class="anchor">Type Conversion</a></h4>
<p>An expression of reference type <code>modify ref <a><var class="meta">T</var></a></code> can be implicitly coerced to type <code>read ref <a><var class="meta">S</var></a></code> if <a><var class="meta">T</var></a> is subtype of <a><var class="meta">S</var></a>.</p>
<p>An expression of reference type <code>modify ref <a><var class="meta">T</var></a></code> can be implicitly coerced to type <code>write ref <a><var class="meta">S</var></a></code> if <a><var class="meta">S</var></a> is subtype of <a><var class="meta">T</var></a>.</p>
<p>An expression of reference type <code>read ref <a><var class="meta">T</var></a></code> can be implicitly coerced to type <a><var class="meta">T</var></a>.</p>
<h2 id="sec.storage.abstract.location"><a href="#sec.storage.abstract.location" class="anchor">Abstract Storage Locations</a></h2>
<p>An <dfn>abstract storage location</dfn> is a logical place where a value of some proper type <a><var class="meta">T</var></a> can reside.</p>
<p>A <a>concrete storage location</a> is also an <a>abstract storage location</a>.</p>
<p>Example: A local variable declaration like <code>var x : Int;</code> defines an <a>abstract storage location</a>, and a reference to <code>x</code> will have the <a>abstract storage reference type</a> <code>read modify Int</code>.</p>
<h2 id="sec.storage.abstract.access"><a href="#sec.storage.abstract.access" class="anchor">Abstract Storage Access</a></h2>
<p>An <dfn>abstract storage access</dfn> is an operation performed by a <a>strand</a> on an <a>abstract storage location</a>.
Each <a>abstract storage access</a> has an <a>abstract storage access mode</a>.</p>
<h2 id="sec.storage.abstract.access.mode"><a href="#sec.storage.abstract.access.mode" class="anchor">Access Mode</a></h2>
<p>An <dfn>abstract storage access mode</dfn> is either <code>get</code>, <code>set</code>, or a <a>memory access mode</a>.</p>
<h2 id="sec.storage.abstract.reference.type"><a href="#sec.storage.abstract.reference.type" class="anchor">Abstract Storage References</a></h2>
<p>An <dfn>abstract storage reference type</dfn> is written <a><var class="meta">m</var></a> <a><var class="meta">T</var></a> where <a><var class="meta">T</var></a> is a proper type and <a><var class="meta">m</var></a> is a set of one or more <a>abstract storage access modes</a>.</p>
<p><div class="issue">
Some of the access types imply others, and it is inconvenient to have to write all explicitly in those cases.
For example:</p>
<ul><li><p>If you have <code>read</code> access, you can also perform a <code>get</code> (if the stored type is copyable).</p>
</li>
<li><p>If you have <code>modify</code> access, you can also perform a <code>write</code>.</p>
</li>
<li><p>If you hae <code>modify</code> or <code>write</code> access, you can also perform a <code>set</code> (if the stored type is copyable).</p>
</li>
</ul>
<p>(Having <code>modify</code> access doesn't let you perform a <code>read</code> or <code>get</code>, because it implies the possibility of write-back which could in principle conflict with other accesses)</p>
<p></div></p>
<h3 id="sec.storage.abstract.reference.type.conversion"><a href="#sec.storage.abstract.reference.type.conversion" class="anchor">Type Conversion</a></h3>
<p>An expression with <a>reference type</a> <code>read ref <a><var class="meta">T</var></a></code> can be implicitly coerced to an <a>abstract storage reference type</a> <code>read <a><var class="meta">T</var></a></code>.</p>
<p>An expression with <a>reference type</a> <code>write ref <a><var class="meta">T</var></a></code> can be implicitly coerced to an <a>abstract storage reference type</a> <code>write <a><var class="meta">T</var></a></code>.</p>
<p>An expression with <a>reference type</a> <code>modify ref <a><var class="meta">T</var></a></code> can be implicitly coerced to an <a>abstract storage reference type</a> <code>read write modify <a><var class="meta">T</var></a></code>.</p>
<p>An expression with <a>abstract storage reference type</a> <a><var class="meta">a</var></a> <a><var class="meta">T</var></a> can be implicitly coerced to <a>abstract storage reference type</a> <a><var class="meta">b</var></a> <a><var class="meta">T</var></a> if <a><var class="meta">b</var></a> is a subset of <a><var class="meta">a</var></a>.</p>
<p>An expression with an abstract storage type <a><var class="meta">m</var></a> <a><var class="meta">T</var></a> can be implicitly coerced to an abstract storage type <a><var class="meta">m</var></a> <a><var class="meta">S</var></a> if all of the following are true:</p>
<ul><li><p><a><var class="meta">S</var></a> is a subtype of <a><var class="meta">T</var></a> unless <a><var class="meta">m</var></a> does not contain any of <code>write</code>, <code>modify</code>, and <code>set</code></p>
</li>
<li><p><a><var class="meta">T</var></a> is a subtype of <a><var class="meta">S</var></a> unless <a><var class="meta">m</var></a> does not contain any of <code>read</code>, <code>modify</code>, and <code>get</code></p>
</li>
</ul>
<h2 id="sec.storage.location.contain"><a href="#sec.storage.location.contain" class="anchor">Containment</a></h2>
<p>An abstract storage location may contain other abstract storage locations.</p>
<p>Two <a>abstract storage locations</a> overlap if they are the same location, or one transitively contains the other.</p>
<p>An abstract storage location of an array type <code><a><var class="meta">T</var></a>[<a><var class="meta">N</var></a>]</code> contains <a><var class="meta">N</var></a> storage locations of type <a><var class="meta">T</var></a>, one for each element of the array.</p>
<p>An abstract storage location of a <code>struct</code> type <a><var class="meta">S</var></a> contains a distinct storage location for each of the <a>fields</a> of <a><var class="meta">S</var></a>.</p>
<h3 id="sec.storage.access.conflict"><a href="#sec.storage.access.conflict" class="anchor">Conflicts</a></h3>
<p>An <a>abstract storage access</a> performed by a strand begins at some point <a><var class="meta">b</var></a> in the execution of that strand, and ends at some point <a><var class="meta">e</var></a> in the execution of that strand.
The interval of an <a>abstract storage access</a> is the half-open interval [<a><var class="meta">b</var></a>, <a><var class="meta">e</var></a>).</p>
<p>The intervals [|a0|, |a1|) and [|b0|, |b1|) overlap if either:</p>
<ul><li><p>|a0| happens-before |b0| and |b0| happens-before |a1|</p>
</li>
<li><p>|b0| happens-before |a0| and |a0| happens-before |b1|</p>
</li>
</ul>
<p>Two <a>abstract storage accesses</a> <a><var class="meta">A</var></a> and <a><var class="meta">B</var></a> overlap if all of the following:</p>
<ul><li><p>The <a>abstract storage location</a> of <a><var class="meta">A</var></a> overlaps the <a>abstract storage location</a> of <a><var class="meta">B</var></a></p>
</li>
<li><p>The interval of <a><var class="meta">A</var></a> overlaps the interval of <a><var class="meta">B</var></a></p>
</li>
</ul>
<p>Two distinct <a>abstract storage accesses</a> <a><var class="meta">A</var></a> and <a><var class="meta">B</var></a> conflict if all of the following:</p>
<ul><li><p><a><var class="meta">A</var></a> and <a><var class="meta">B</var></a> overlap</p>
</li>
<li><p>At least one of the accesses is a <code>write</code>, <code>modify</code>, or <code>set</code></p>
</li>
</ul>
<h2 id="sec.storage.expr"><a href="#sec.storage.expr" class="anchor">Expressions That Reference Storage</a></h2>
<p><div class="issue">
This text really belongs in the relevant sections about type-checking each of these expression forms.
</div></p>
<p>Rather than evaluating to a value, of an expression may evaluate to an abstract storage location, along with restrictions on the kinds of access allowed to that location.
An expression that evaluates to an abstract storage location does not constitute an abstract storage access to that location.</p>
<p>Examples of expressions that evaluate to an abstract storage location include:</p>
<ul><li><p>An identifier expression that names some variable <a><var class="meta">v</var></a></p>
</li>
<li><p>A member-access expression <a><var class="meta">x</var></a>.<a><var class="meta">m</var></a> where <a><var class="meta">x</var></a> is an abstract storage location of some struct type <a><var class="meta">S</var></a> and <a><var class="meta">m</var></a> is a field of <a><var class="meta">S</var></a></p>
</li>
<li><p>A member-access expression <a><var class="meta">x</var></a>.<a><var class="meta">p</var></a> where <a><var class="meta">p</var></a> is a property</p>
</li>
<li><p>A subscript exrpession <code><a><var class="meta">x</var></a>[<a><var class="meta">i</var></a>]</code> that resolves to an invocation of a <code>subscript</code> declaration</p>
</li>
</ul>
<p>Examples of expressions that perform an abstract storage access include:</p>
<ul><li><p>An assignment <code><a><var class="meta">dst</var></a> = <a><var class="meta">src</var></a></code> performs a write to <a><var class="meta">dst</var></a>. It also performs a read from <a><var class="meta">src</var></a> if <a><var class="meta">src</var></a> is an abstract storage location.</p>
</li>
<li><p>A call <code>f(... a ... )</code> where argument <code>a</code> is an abstract storage location performs an abstract storage access based on the direction of the corresponding parameter:</p>
<ul><li><p>An <code>in</code> parameter performs a read access that begins and ends before the strand enters the body of <code>f</code></p>
</li>
<li><p>An <code>out</code> parameter begins a write access before the call begins, and ends it after the call returns. The abstract storage location <code>a</code> must have been uninitialized before the call, and will be initialized after the call.</p>
</li>
<li><p>An <code>inout</code> parameter begins a modify access before the call that ends after the call returns. The abstract storage location <code>a</code> must have been initialized before the call.</p>
</li>
<li><div class="issue callout">TODO: <code>ref</code> etc.</div>
</li>
</ul>
</li>
</ul>
<h1 id="sec.stability"><a href="#sec.stability" class="anchor">Source and Binary Stability</a></h1>
<div class="issue callout">Issue: This section needs to define what it means for something to be <a><var class="meta">stable</var></a> vs. <dfn>fragile</dfn>.</div>
<h1 id="sec.autodiff"><a href="#sec.autodiff" class="anchor">Automatic Differentiation</a></h1>
<div class="issue callout"><h6>Issue</h6>
<p>This chapter needs to specify:</p>
<ul><li><p>The built-in types and attributes related to automatic differentiation.</p>
</li>
<li><p>The rules applied when checking the body of a <code>[Differentiable]</code> function.</p>
</li>
<li><p>The semantics of the <code>fwd_diff</code> and <code>bwd_diff</code> operators, including how to determine the signature of the function they return.</p>
</li>
<li><p>The requirements of the <code>IDifferentiable</code> interface, and also the rules used to automatically synthesize conformance for it.</p>
</li>
</ul>
</div>

</body>
</html>